

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="GODXQI">
  <meta name="keywords" content="">
  
    <meta name="description" content="002节 7种Mode:  usr&#x2F;sys 正常&#x2F;兴奋模式 undefined(und) 未定义指令模式 Supervisor(svc) 管理模式 Abort(abt) 中止模式 指令预取中止：CPU读指令时，它执行当前指令时已经在解析第二条指令，同时也在读取第三条指令，第三条指令的读取即预取，有可能出错 数据访问中止：比如访问某个地址时出错了   IRQ(irq) 中断模式">
<meta property="og:type" content="article">
<meta property="og:title" content="CPU的工作模式_状态和寄存器">
<meta property="og:url" content="https://godxqi.github.io/2023/01/15/%E9%9F%A6%E4%B8%9C%E5%B1%B1%E4%B8%80%E6%9C%9F/CPU%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F_%E7%8A%B6%E6%80%81%E5%92%8C%E5%AF%84%E5%AD%98%E5%99%A8/index.html">
<meta property="og:site_name" content="GODXQI&#39;s Blog">
<meta property="og:description" content="002节 7种Mode:  usr&#x2F;sys 正常&#x2F;兴奋模式 undefined(und) 未定义指令模式 Supervisor(svc) 管理模式 Abort(abt) 中止模式 指令预取中止：CPU读指令时，它执行当前指令时已经在解析第二条指令，同时也在读取第三条指令，第三条指令的读取即预取，有可能出错 数据访问中止：比如访问某个地址时出错了   IRQ(irq) 中断模式">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godxqi.github.io/image/f693c816f656497d8840275d2ba74ec3.png">
<meta property="og:image" content="https://godxqi.github.io/image/c315e75974db39349489c5211b268ccd.png">
<meta property="og:image" content="https://godxqi.github.io/image/50a0730e0d3c716809ecc6d351809fbf.png">
<meta property="og:image" content="https://godxqi.github.io/image/2668da5cb375777e2ef323e66720bdf7.png">
<meta property="og:image" content="https://godxqi.github.io/image/ea57846e8a843997a6ab0f0bc93b3105.png">
<meta property="og:image" content="https://godxqi.github.io/image/1da882ad2d1b6a4435c7d7b1842bdfaa.png">
<meta property="og:image" content="https://godxqi.github.io/image/375020a76d4189cc942a9d90be8971eb.png">
<meta property="og:image" content="https://godxqi.github.io/image/4c83b7f226192bc431db62da91d180c9.png">
<meta property="og:image" content="https://godxqi.github.io/image/cb46877f626bca675c1d305c342e0023.png">
<meta property="og:image" content="https://godxqi.github.io/image/136bfc8c086cfdbfbaf9f6163e1568f0.png">
<meta property="og:image" content="https://godxqi.github.io/image/d7d4629fc1fa3da8105353615902a2f3.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter14_lesson5_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/136bfc8c086cfdbfbaf9f6163e1568f0.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter14_lesson6_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/12ded688d46c48aa3521c1ae0464616d.png">
<meta property="og:image" content="https://godxqi.github.io/image/d15ed2551d92ee42a203de78e0d0d88a.png">
<meta property="og:image" content="https://godxqi.github.io/image/b0a4affe35fb0524909151ffa32b8682.png">
<meta property="og:image" content="https://godxqi.github.io/image/54019a20aabe6d0f047bae6f14a2ebdb.png">
<meta property="og:image" content="https://godxqi.github.io/image/f17a90c67b39bc8cdfefdcd1c14f0889.png">
<meta property="og:image" content="https://godxqi.github.io/image/c6153354099cc21cde644195a3fded8a.png">
<meta property="og:image" content="https://godxqi.github.io/image/2d8c3b4b89685e7cd77a809b36555d05.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter14_lesson6_0011.png">
<meta property="og:image" content="https://godxqi.github.io/image/de4721414cc408358081c71fc2d2c48c.png">
<meta property="og:image" content="https://godxqi.github.io/image/1a42bfaa519db705869ef805e4faff6c.png">
<meta property="og:image" content="https://godxqi.github.io/image/b436fdac06f773f584b03539726ecb3b.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter14_lesson6_0014.png">
<meta property="og:image" content="https://godxqi.github.io/image/388eb1ae56a0e00eb08fe1b280c3508c.png">
<meta property="og:image" content="https://godxqi.github.io/image/9dba24c50318ce93233af097feefd2ef.png">
<meta property="og:image" content="https://godxqi.github.io/image/fb8f2cb4442897d291455a375fa81c19.png">
<meta property="og:image" content="https://godxqi.github.io/image/f260fa33f4e83980af9cda33254d29b7.png">
<meta property="og:image" content="https://godxqi.github.io/image/2e61a1315da6391919e514c23451ff9f.png">
<meta property="og:image" content="https://godxqi.github.io/image/e952bd32aa16202b20c092df04a3fd51.png">
<meta property="og:image" content="https://godxqi.github.io/image/f5bccdad305d5f4d352fce62e0d4604c.png">
<meta property="og:image" content="https://godxqi.github.io/image/9ba631e79479724f79bdee3c818e6596.png">
<meta property="og:image" content="https://godxqi.github.io/image/f8afce629a651780016780a4e69e8104.png">
<meta property="og:image" content="https://godxqi.github.io/image/ccd4014ba91cc12d13baa12954f76d3b.png">
<meta property="og:image" content="https://godxqi.github.io/image/800px-Chapter14_lesson8_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/7ef44f90567be421d19d9aedcccbe60d.png">
<meta property="og:image" content="https://godxqi.github.io/image/f59da1b8a7583eb7787ba29dcd835abc.png">
<meta property="og:image" content="https://godxqi.github.io/image/9597068d41a2ef047075a6c32ee915cf.png">
<meta property="og:image" content="https://godxqi.github.io/image/40482a9f658b104b65e6d1f342e0f012.png">
<meta property="og:image" content="https://godxqi.github.io/image/800px-Chapter14_lesson8_007.png">
<meta property="og:image" content="https://godxqi.github.io/image/68bd44a3aba8b01b941c4dbfbcceff31.png">
<meta property="og:image" content="https://godxqi.github.io/image/3520a06f8a00a3c2ddf62632127c2727.png">
<meta property="og:image" content="https://godxqi.github.io/image/3c7d29e2ea9cc627c32d02b8c60841e6.png">
<meta property="og:image" content="https://godxqi.github.io/image/c93eb2d99b7bcbfb22f587851ff7decc.png">
<meta property="og:image" content="https://godxqi.github.io/image/a48d57153707e8b932dc0ed286a12383.png">
<meta property="article:published_time" content="2023-01-15T12:59:57.996Z">
<meta property="article:modified_time" content="2023-01-15T13:03:31.666Z">
<meta property="article:author" content="GODXQI">
<meta property="article:tag" content="未重构">
<meta property="article:tag" content="嵌入式">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://godxqi.github.io/image/f693c816f656497d8840275d2ba74ec3.png">
  
  
  
  <title>CPU的工作模式_状态和寄存器 - GODXQI&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"godxqi.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>GODXQI</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CPU的工作模式_状态和寄存器"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-01-15 20:59" pubdate>
          January 15, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          35k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          294 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CPU的工作模式_状态和寄存器</h1>
            
            
              <div class="markdown-body">
                
                <p><strong>002节</strong></p>
<p><strong>7种Mode:</strong></p>
<ul>
<li>usr&#x2F;sys 正常&#x2F;兴奋模式</li>
<li>undefined(und) 未定义指令模式</li>
<li>Supervisor(svc) 管理模式</li>
<li>Abort(abt) 中止模式<ul>
<li>指令预取中止：CPU读指令时，它执行当前指令时已经在解析第二条指令，同时也在读取第三条指令，第三条指令的读取即预取，有可能出错</li>
<li>数据访问中止：比如访问某个地址时出错了</li>
</ul>
</li>
<li>IRQ(irq) 中断模式</li>
<li>FIQ(fiq) 快中断模式</li>
</ul>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs maxima">五种异常模式：<span class="hljs-literal">und</span>，svc，abt，irq，fiq<br>六种特权模式(Privileged mode)：sys，<span class="hljs-literal">und</span>，svc，abt，irq，fiq<br>    除了用户模式以外，其他<span class="hljs-number">6</span>种都是特权模式<br>    特权模式中，可以编程操作CPSR直接进入其他模式；在用户模式下，不可以切换成特权模式<br></code></pre></td></tr></table></figure>

<p><strong>2种State:</strong></p>
<ul>
<li>ARM state</li>
<li>Thumb state</li>
</ul>
<p><strong>寄存器：</strong></p>
<ul>
<li>通用寄存器</li>
<li>备份寄存器(banked register)</li>
<li>当前程序状态寄存器(Current Program Status Register);CPSR</li>
<li>CPSR的备份寄存器:SPSR(Save Program Status Register)</li>
</ul>
<hr>
<p>发生某种异常时，会进入某种异常模式，在这种异常模式下更容易处理这些异常</p>
<p>在各种异常模式下，它们拥有的其实就是寄存器的差别</p>
<p><img src="/image/f693c816f656497d8840275d2ba74ec3.png" srcset="/img/loading.gif" lazyload alt="f693c816f656497d8840275d2ba74ec3.png"></p>
<p>这个图是有关各个模式下能访问寄存器的，再讲这个图之前我们先引入 2种state</p>
<p>CPU有两种state:</p>
<p>a. ARM state:使用ARM指令集，每个指令4byte</p>
<p>b. Thumb state:使用的是Thumb指令集，每个指令2byte</p>
<p>比如同样是:</p>
<p>mov R0, R1 编译后</p>
<p>对于ARM指令集要占据4个字节：机器码</p>
<p>对于Thumb指令集占据2个字节：机器码</p>
<p>引入Thumb减少存储空间</p>
<p>ARM指令集与Thumb指令集的区别：</p>
<p>Thumb 指令可以看作是 ARM 指令压缩形式的子集,是针对代码密度的问题而提出的,它具有 16 位的代码密度但是它不如ARM指令的效率高 .</p>
<p>Thumb 不是一个完整的体系结构,不能指望处理只执行Thumb 指令而不支持 ARM 指令集.</p>
<p>因此,Thumb 指令只需要支持通用功能,必要时可以借助于完善的 ARM 指令集,比如,所有异常自动进入 ARM 状态.在编写 Thumb 指令时,先要使用伪指令 CODE16 声明,而且在 ARM 指令中要使用 BX指令跳转到 Thumb 指令,以切换处理器状态.编写 ARM 指令时,则可使用伪指令 CODE32声明.</p>
<p>下节课会演示使用Thumb指令集编译，看是否生成的bin文件会变小很多</p>
<p>在每种模式下都有R0 ~ R15</p>
<p>在这张图注意到有些寄存器画有灰色的三角形，表示访问该模式下访问的专属寄存器 比如</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">R0</span>, <span class="hljs-built_in">R8</span><br></code></pre></td></tr></table></figure>

<p>在System 模式下访问的是R0 ~ R8,在所有模式下访问R0都是同一个寄存器</p>
<p>但是在FIQ模式下，访问R8是访问的FIQ模式专属的R8寄存器，不是同一个物理上的寄存器</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">R0</span>, <span class="hljs-built_in">R8</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">R0</span>, R8_fiq<br></code></pre></td></tr></table></figure>

<p>在这五种异常模式中每个模式都有自己专属的R13 R14寄存器，R13用作SP(栈) R14用作LR(返回地址) LR是用来保存发生异常时的指令地址</p>
<p>为什么快中断(FIQ模式)有那么多专属寄存器，这些寄存器称为备份寄存器</p>
<p>回顾一下中断的处理过程</p>
<p>a. 保存现场(保存被中断模式的寄存器)</p>
<p>就比如说我们的程序正在系统模式&#x2F;用户模式下运行，当你发生中断时，需要把R0 ~ R14这些寄存器全部保存下来，让后处理异常，最后恢复这些寄存器</p>
<p>但如果是快中断，那么我就不需要保存 系统&#x2F;用户模式下的R8 ~ R12这几个寄存器，在FIQ模式下有自己专属的R8 ~ R12寄存器，省略保存寄存器的时间，加快处理速度</p>
<p>但是在Linux中并不会使用FIQ模式</p>
<p>b. 处理</p>
<p>c. 恢复现场</p>
<p>CPSR：当前程序状态寄存器，这是一个特别重要的寄存器</p>
<p>SPSR保存的程序状态寄存器</p>
<p>它们格式如下：</p>
<p><img src="/image/c315e75974db39349489c5211b268ccd.png" srcset="/img/loading.gif" lazyload alt="c315e75974db39349489c5211b268ccd.png"></p>
<p>首先 M4 ~ M0 表示当前CPU处于哪一种模式(Mode)；</p>
<p>我们可以读取这5位来判断CPU处于哪一种模式，也可以修改这些模式位，让它进入某种模式；</p>
<p>当然若你当前处于用户模式下，是没有权限修改这些位的；</p>
<p>M4 ~ M0对应什么值，会有说明：</p>
<p><img src="/image/50a0730e0d3c716809ecc6d351809fbf.png" srcset="/img/loading.gif" lazyload alt="50a0730e0d3c716809ecc6d351809fbf.png"></p>
<p>查看其他位</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">Bit5 </span>State <span class="hljs-keyword">bits表示CPU工作与Thumb </span>State还是ARM State用的指令集是什么<br><span class="hljs-keyword">Bit6 </span>FIQ <span class="hljs-keyword">disable当bit6等于1时，FIQ是不工作的</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">Bit7 </span>IRQ <span class="hljs-keyword">disable当bit5等于1时，禁止所有的IRQ中断，这个位是IRQ的总开关</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">Bit8 </span>~ <span class="hljs-keyword">Bit27是保留位</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">Bite28 </span>~ <span class="hljs-keyword">Bit31是状态位，</span><br></code></pre></td></tr></table></figure>

<p>什么是状态位，比如说执行一条指令cmp R0, R1</p>
<p>如果R0 等于 R1 那么zero位将等于1，即这条指令影响 Z 位，如果R0 &#x3D;&#x3D; R1，则Z &#x3D; 1</p>
<p>beq xxx 这条跳转指令会判断Bit30是否为1，是1的话则跳转，不是1的话则不会跳转：即Z 位，如果 Z 位等于1 则跳转，这些指令是借助状态位实现的</p>
<p>SPSR(保存的程序状态寄存器)： 表示发生异常时这个寄存器会用来保存被中断的模式下它的CPSR</p>
<p>比如我的程序在系统模式下运行 CPSR是某个值，当发生中断时会进入irq模式，irq模式下有一个它专属的CPSR_irq寄存器，这个CPSR_irq就保存着被中断模式的系统模式下的CPSR</p>
<p>我们来看看发生异常时CPU是如何协同工作的：</p>
<p>进入异常的处理流程(硬件)：</p>
<p><img src="/image/2668da5cb375777e2ef323e66720bdf7.png" srcset="/img/loading.gif" lazyload alt="2668da5cb375777e2ef323e66720bdf7.png"></p>
<p>翻译一下：</p>
<p>发生异常时，我们的CPU会做什么事情</p>
<p>a. 把下一条指令的地址保存在LR寄存器里(某种异常模式的LR寄存器等于被中断的下一条指令的地址)，它有可能是PC + 4有可能是PC + 8,到底是那种取决于不同的情况</p>
<p>b. 把CPSR保存在SPSR里面(某一种异常模式下SPSR里面的值等于CPSR)</p>
<p>c. 修改CPSR的模式为进入异常模式(修改CPSR的M4 ~ M0进入异常模式)</p>
<p>d. 跳到向量表</p>
<p>退出异常怎么做？</p>
<p><img src="/image/ea57846e8a843997a6ab0f0bc93b3105.png" srcset="/img/loading.gif" lazyload alt="ea57846e8a843997a6ab0f0bc93b3105.png"></p>
<p>a. 让LR减去某个值，让后赋值给PC(PC &#x3D; 某个异常LR寄存器减去 offset)</p>
<p>减去什么值呢？</p>
<p>也就是说我们怎么返回去继续执行原来的程序，根据下面这个表来取值</p>
<p>Table 2-2</p>
<p><img src="/image/1da882ad2d1b6a4435c7d7b1842bdfaa.png" srcset="/img/loading.gif" lazyload alt="1da882ad2d1b6a4435c7d7b1842bdfaa.png"></p>
<p>如果发生的是SWI可以把 R14_svc复制给PC</p>
<p>如果发生的是IRQ可以把R14_irq的值减去4赋值给PC</p>
<p>b. 把CPSR的值恢复(CPSR值等于某一个异常模式下的SPSR)</p>
<p>c. 清中断（如果发生的是中断的话，对于其他异常不用设置）</p>
<p>003节（一点不重要）</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">all: led.o uart.o init.o main.o start.o<br>    <span class="hljs-comment">#arm-linux-ld -Ttext 0 -Tdata 0x30000000  start.o led.o uart.o init.o main.o -o sdram.elf</span><br>    arm-linux-ld -T sdram.lds start.o led.o uart.o init.o main.o -o sdram.elf<br>    arm-linux-objcopy -O binary -S sdram.elf sdram.bin<br>    arm-linux-objdump -D sdram.elf &gt; sdram.dis<br>clean:<br>    rm *<span class="hljs-string">.bin</span> *<span class="hljs-string">.o</span> *<span class="hljs-string">.elf</span> *<span class="hljs-string">.dis</span><br>%<span class="hljs-string">.o</span> : %<span class="hljs-string">.c</span><br>    arm-linux-gcc -mthumb -c -o $@ $&lt;    <span class="hljs-string">//</span>对于所有的C文件，加上这个就可以用thumb指令集来编译<br>%<span class="hljs-string">.o</span> : %<span class="hljs-string">.S</span><br>    arm-linux-gcc -c -o $@ $&lt;<br></code></pre></td></tr></table></figure>

<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/* start.S */</span><br><br><span class="hljs-symbol">.text</span><br><span class="hljs-symbol">.global</span> _start<br><span class="hljs-symbol">.code</span> <span class="hljs-number">32</span>        <span class="hljs-comment">//表示后续的指令使用thumb指令集</span><br><span class="hljs-symbol">_start:</span><br><br>    <span class="hljs-comment">/* 关闭看门狗 */</span><br><br>    <span class="hljs-comment">/* 设置MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */</span><br><br>    <span class="hljs-comment">/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */</span><br><br>    <span class="hljs-comment">/* 设置CPU工作于异步模式 */</span><br><br>    <span class="hljs-comment">/* 设置MPLLCON(0x4C000004) = (92&lt;&lt;12)|(1&lt;&lt;4)|(1&lt;&lt;0)</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/* 设置内存: sp 栈 */</span><br><br>    <span class="hljs-comment">/* 怎么从ARM State切换到Thumb State? */</span><br>    <span class="hljs-keyword">adr</span> <span class="hljs-built_in">r0</span>, thumb_func<br>    <span class="hljs-keyword">add</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#1</span>  <span class="hljs-comment">/* bit0=1时, bx就会切换CPU State到thumb state */</span><br>    <span class="hljs-keyword">bx</span> <span class="hljs-built_in">r0</span><br>    <br><span class="hljs-symbol">.code</span> <span class="hljs-number">16</span>    <br><span class="hljs-symbol">thumb_func:</span>    <br>    <span class="hljs-keyword">bl</span> sdram_init<br>    <span class="hljs-comment">//bl sdram_init2     /* 用到有初始值的数组, 不是位置无关码 */</span><br><br>    <span class="hljs-comment">/* 重定位text, rodata, data段整个程序 */</span><br>    <span class="hljs-keyword">bl</span> copy2sdram<br><br>    <span class="hljs-comment">/* 清除BSS段 */</span><br>    <span class="hljs-keyword">bl</span> clean_bss<br><br>    <span class="hljs-comment">//bl main  /* 使用BL命令相对跳转, 程序仍然在NOR/sram执行 */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-symbol">=main</span>  <span class="hljs-comment">/* 绝对跳转, 跳到SDRAM */</span><br>    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">pc</span>, <span class="hljs-built_in">r0</span><br><br><span class="hljs-symbol">halt:</span><br>    <span class="hljs-keyword">b</span> halt<br></code></pre></td></tr></table></figure>

<span style="background-color: #ffaaaa">

</span>

<span style="background-color: #ffaaaa">

</span>

<p><strong>第004节_und异常模示程序示例</strong></p>
<hr>
<p>写一个程序故意让其发生未定义异常，让后处理这个异常</p>
<p>查看uboot中源码uboot\u-boot-1.1.6\cpu\arm920t</p>
<p>打开start.S找到一场向量表</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">/*code: 28 -- 72*/</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;config.h&gt;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;version.h&gt;</span></span><br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Jump vector table as in table 3.1 in [1]</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> GSTATUS2   (0x560000B4)</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> GSTATUS3   (0x560000B8)</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> GSTATUS4   (0x560000BC)</span><br>    <br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> REFRESH(0x48000024)</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> MISCCR (0x56000080)</span><br>    <br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCKTIME  0x4C000000     <span class="hljs-comment">/* R/W, PLL lock time count register */</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> MPLLCON           0x4C000004  <span class="hljs-comment">/* R/W, MPLL configuration register */</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> UPLLCON           0x4C000008  <span class="hljs-comment">/* R/W, UPLL configuration register */</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> CLKCON            0x4C00000C  <span class="hljs-comment">/* R/W, Clock generator control reg. */</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> CLKSLOW           0x4C000010  <span class="hljs-comment">/* R/W, Slow clock control register */</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> CLKDIVN           0x4C000014  <span class="hljs-comment">/* R/W, Clock divider control */</span></span><br>    <br>    <span class="hljs-comment">/******下面这些就是异常向量表*****/</span><br>    .globl <span class="hljs-variable">_start</span><br>    <span class="hljs-variable">_start</span>:     b   reset<br>        ldr      pc, <span class="hljs-variable">_undefined_instruction</span><br>        ldr      pc, <span class="hljs-variable">_software_interrupt</span><br>        ldr      pc, <span class="hljs-variable">_prefetch_abort</span><br>        ldr      pc, <span class="hljs-variable">_data_abort</span><br>        ldr      pc, <span class="hljs-variable">_not_used</span><br>        ldr      pc, <span class="hljs-variable">_irq</span><br>        ldr      pc, <span class="hljs-variable">_fiq</span><br>    <br>    <span class="hljs-variable">_undefined_instruction</span>:     .word undefined_instruction<br>    <span class="hljs-variable">_software_interrupt</span>:        .word software_interrupt<br>    <span class="hljs-variable">_prefetch_abort</span>:    .word prefetch_abort<br>    <span class="hljs-variable">_data_abort</span>:                .word data_abort<br>    <span class="hljs-variable">_not_used</span>:          .word not_used<br>    <span class="hljs-variable">_irq</span>:                       .word irq<br>    <span class="hljs-variable">_fiq</span>:                       .word fiq<br>    <br>        .balignl <span class="hljs-number">16</span>,<span class="hljs-number">0</span>xdeadbeef<br></code></pre></td></tr></table></figure>

<p>可以在手册中找到异常向量表</p>
<p><img src="/image/375020a76d4189cc942a9d90be8971eb.png" srcset="/img/loading.gif" lazyload alt="375020a76d4189cc942a9d90be8971eb.png"></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/* start.S */</span><br>    <span class="hljs-meta">.text</span><br>    <span class="hljs-meta">.global</span> _start<br>    <br>    _start:<br>        <span class="hljs-keyword">b</span> reset  <span class="hljs-comment">/* vector 0 : reset */</span> <span class="hljs-comment">//一上电复位，是从0地址开始执行，跳到reset处</span><br>        <span class="hljs-keyword">b</span> do_und <span class="hljs-comment">/* vector 4 : und */</span> <br>            <span class="hljs-comment">//如果发生未定义指令异常，就会跳到0x04地址未定义指令异常处，执行do_und程序</span><br>    <br>    <span class="hljs-comment">/* 假设一上电从0地址开始执行，reset，做一系列初始化之后    </span><br><span class="hljs-comment">     * 故意加入一条未定义指令:            </span><br><span class="hljs-comment">        und_code:         </span><br><span class="hljs-comment">            .word 0xdeadc0de  /* 未定义指令 */</span><br>        当CPU发现无法执行此条指令时，就会发生未定义指令异常，就会执行do_und<br>        即<span class="hljs-keyword">bl</span> print2，<br>     */<br>    do_und:<br>        <span class="hljs-comment">/* 执行到这里之前:          </span><br><span class="hljs-comment">         * 1. lr_und保存有被中断模式中的下一条即将执行的指令的地址          </span><br><span class="hljs-comment">         * 2. SPSR_und保存有被中断模式的CPSR          </span><br><span class="hljs-comment">         * 3. CPSR中的M4-M0被设置为11011, 进入到und模式          </span><br><span class="hljs-comment">         * 4. 跳到0x4的地方执行程序           </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* 需要从新设置sp栈，指向某一块没有使用的地址</span><br><span class="hljs-comment">         * 为什么要设置栈，因为这个栈是und模式里的栈，从来没有人设置它 </span><br><span class="hljs-comment">         * sp_und未设置, 先设置它 </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x34000000</span><br>        <br>        <span class="hljs-comment">/* 保存现场：</span><br><span class="hljs-comment">         * 在und异常处理函数中有可能会修改r0-r12, 所以先保存</span><br><span class="hljs-comment">         * 发生异常时，当前被中断的地址会保存在lr寄存器中 先减后存</span><br><span class="hljs-comment">         * lr是异常处理完后的返回地址, 也要保存 </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">stmdb</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">lr</span>&#125;<br><br>        <span class="hljs-comment">/* 处理und异常：</span><br><span class="hljs-comment">         * 传递两个参数给它，我们放入r0和r1里 </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>    <span class="hljs-comment">//把cpsr的值读入r0</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-symbol">=und_string</span>    <span class="hljs-comment">//把下面的字符串地址赋值给r1</span><br>        <span class="hljs-keyword">bl</span> printException<br><br>        <span class="hljs-comment">/* 恢复现场：</span><br><span class="hljs-comment">         * 这些寄存器保存在栈中，把他们读取出来就可以了</span><br><span class="hljs-comment">         * 先读后加</span><br><span class="hljs-comment">         * 把r0 ~ r12的值从栈中都取出来，并且把原来保存的lr值，赋值到pc中去</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr的值恢复到cpsr里 */</span><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 如何定义字符串und_string，可以百度搜索 arm-linux-gcc 汇编 定义字符串</span><br><span class="hljs-comment">         * 参考官方的说明文档：http://web.mit.edu/gnu/doc/html/as_7.html</span><br><span class="hljs-comment">          .string &quot;str&quot;：Copy the characters in str to the object file. You may specify more than one string to copy, separated by commas. Unless otherwise specified for a particular machine, the assembler marks the end of each string with a 0 byte. You can use any of the escape sequences described in section Strings.</span><br><span class="hljs-comment">          上面是说我们使用.str会自动加上结束符</span><br><span class="hljs-comment">         */</span>        <br>    und_string:<br>        .string <span class="hljs-string">&quot;undefined instruction exception&quot;</span><br>    <br>    reset:<br>        <span class="hljs-comment">/* 关闭看门狗 */</span><br>    <br>        <span class="hljs-comment">/* 设置MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */</span><br>        <span class="hljs-comment">/* LOCKTIME(0x4C000000) = 0xFFFFFFFF */</span><br>    <br>        <span class="hljs-comment">/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */</span><br>    <br>        <span class="hljs-comment">/* 设置CPU工作于异步模式 */</span><br><br>        <span class="hljs-comment">/* 设置MPLLCON(0x4C000004) = (92&lt;&lt;12)|(1&lt;&lt;4)|(1&lt;&lt;0)           </span><br><span class="hljs-comment">         *  FCLK = 2*m*Fin/(p*2^s) = 2*100*12/(3*2^1)=400M          </span><br><span class="hljs-comment">         */</span><br>    <br>        <span class="hljs-comment">/* 一旦设置PLL, 就会锁定lock time直到PLL输出稳定          </span><br><span class="hljs-comment">         * 然后CPU工作于新的频率FCLK          </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* 设置内存: sp 栈 */</span><br>        <span class="hljs-comment">/* 分别是nor/nand启动          </span><br><span class="hljs-comment">         * 写0到0地址, 再读出来          </span><br><span class="hljs-comment">         * 如果得到0, 表示0地址上的内容被修改了, 它对应ram, 这就是nand启动          </span><br><span class="hljs-comment">         * 否则就是nor启动          </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* 重定位text, rodata, data段整个程序 */</span><br>    <br>        <span class="hljs-comment">/* 清除BSS段 */</span><br>   <br>        <span class="hljs-keyword">bl</span> uart0_init<br>    <br>        <span class="hljs-keyword">bl</span> print1<br>        <span class="hljs-comment">/* 故意加入一条未定义指令 */</span><br>    und_code:<br>        <span class="hljs-meta">.word</span> <span class="hljs-number">0xdeadc0de</span>  <span class="hljs-comment">/* 未定义指令 */</span><br>        <span class="hljs-keyword">bl</span> print2<br>    <br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=main</span>  <span class="hljs-comment">/* 绝对跳转, 跳到SDRAM */</span><br>    <br>    halt:<br>        <span class="hljs-keyword">b</span> halt<br></code></pre></td></tr></table></figure>

<p>如何处理这个异常？</p>
<p>直接print打印一句话，新建exception.c文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* exception.c */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;uart.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printException</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpsr, <span class="hljs-type">char</span> *str)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Exception! cpsr = &quot;</span>);<br>    <span class="hljs-built_in">printHex</span>(cpsr);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot; &quot;</span>);<br>    <span class="hljs-built_in">puts</span>(str);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\r&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改makefile添加文件</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">    all: start.o led.o uart.o init.o main.o exception.o<br>        <span class="hljs-comment">#arm-linux-ld -Ttext 0 -Tdata 0x30000000  start.o led.o uart.o init.o main.o -o sdram.elf</span><br>        arm-linux-ld -T sdram.lds $^ -o sdram.elf<br>        <span class="hljs-comment">#用$ ^来包含所有的依赖</span><br>        arm-linux-objcopy -O binary -S sdram.elf sdram.bin<br>        arm-linux-objdump -D sdram.elf &gt; sdram.dis<br>    clean:<br>        rm *<span class="hljs-string">.bin</span> *<span class="hljs-string">.o</span> *<span class="hljs-string">.elf</span> *<span class="hljs-string">.dis</span><br>        <br>    %<span class="hljs-string">.o</span> : %<span class="hljs-string">.c</span><br>        arm-linux-gcc -c -o $@ $&lt;<br>    <br>    %<span class="hljs-string">.o</span> : %<span class="hljs-string">.S</span><br>        arm-linux-gcc -c -o $@ $&lt;<br>        *<span class="hljs-string">.dis</span><br></code></pre></td></tr></table></figure>

<p>编译成功烧写</p>
<p>但没有输出我们想要的字符串</p>
<p>这里通过printf演示如何调试程序</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">sdram:<br>        bl print1 <span class="hljs-regexp">//</span>添加print1<br>        <span class="hljs-regexp">/* 故意加入一条未定义指令 */</span><br>    und_code:<br>        .word <span class="hljs-number">0</span>xdeadc0de  <span class="hljs-regexp">/* 未定义指令 */</span><br>        bl print2 <span class="hljs-regexp">//</span>添加print2,实现这两个函数，来打印<br>    <br>        <span class="hljs-regexp">//</span>bl main  <span class="hljs-regexp">/* 使用BL命令相对跳转, 程序仍然在NOR/</span>sram执行 */<br>        ldr pc, =main  <span class="hljs-regexp">/* 绝对跳转, 跳到SDRAM */</span><br>    <br>    halt:<br>        b halt<br></code></pre></td></tr></table></figure>

<p>实现print1 print2这两个打印函数，在uart.c这个文件里</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-variable">void</span> <span class="hljs-title function_">print1</span>(<span class="hljs-params">void</span>)<br>    &#123;<br>        <span class="hljs-title function_">puts</span>(<span class="hljs-string">&quot;abc<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-variable">void</span> <span class="hljs-title function_">print2</span>(<span class="hljs-params">void</span>)<br>    &#123;<br>        <span class="hljs-title function_">puts</span>(<span class="hljs-string">&quot;123<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>上传代码烧写，发现print1、print2并未执行成功</p>
<p>发现在start.S并未初始化 uart0_init()，删除main.c中的uart0_init()初始化函数</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=sdram</span>    <br>    sdram:<br>        <span class="hljs-keyword">bl</span> uart0_init<br>    <br>        <span class="hljs-keyword">bl</span> print1<br>        <span class="hljs-comment">/* 故意加入一条未定义指令 */</span><br>    und_code:<br>        <span class="hljs-meta">.word</span> <span class="hljs-number">0xdeadc0de</span>  <span class="hljs-comment">/* 未定义指令 */</span><br>        <span class="hljs-keyword">bl</span> print2<br>    <br>        <span class="hljs-comment">//bl main  /* 使用BL命令相对跳转, 程序仍然在NOR/sram执行 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=main</span>  <span class="hljs-comment">/* 绝对跳转, 跳到SDRAM */</span><br>    <br>    halt:<br>        <span class="hljs-keyword">b</span> halt<br></code></pre></td></tr></table></figure>

<p>打印了未定义指令异常CPSR地址,打印了字符串，最后执行main函数</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">.<span class="hljs-type">word</span> <span class="hljs-number">0xdeadc0de</span>  <span class="hljs-comment">/* 也是一条定义指令 只要指令地址对不上上表就是未定义指令*/</span><br></code></pre></td></tr></table></figure>

<p>程序改进</p>
<p>源程序</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk">.text<br>.global _start<br><br>_start:<br>        b reset  <span class="hljs-regexp">/* vector 0 : reset */</span><br>    <span class="hljs-regexp">/*使用b命令跳转  相对跳转*/</span><br>        b do_und <span class="hljs-regexp">/* vector 4 : und */</span><br><br>do_und:<br><br>        <span class="hljs-regexp">/* sp_und未设置, 先设置它 */</span><br><br>        <span class="hljs-regexp">/* 保存现场 */</span><br>        <br>        <span class="hljs-regexp">/* 处理und异常 */</span><br><br>        /* 这里又使用了bl指令跳转，如果是nand启动，且这个函数在<span class="hljs-number">4</span>k之外，这个函数必定出错 <br>         * 为了保险，我们需要跳转到sdram中执行这个函数（在这条指令之前就跳转到sdram去执行）<br>         */<br>        bl printException<br>        <br>        <span class="hljs-regexp">/* 恢复现场 */</span><br>        <br>    und_string:<br>        .string <span class="hljs-string">&quot;undefined instruction exception&quot;</span><br>    <br>reset:<br></code></pre></td></tr></table></figure>

<p>去sdram执行do_und这个代码段，改进后如下：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">.text</span><br>    <span class="hljs-meta">.global</span> _start<br>    <br>    _start:<br>        <span class="hljs-keyword">b</span> reset  <span class="hljs-comment">/* vector 0 : reset */</span><br>    <span class="hljs-comment">/*跳转到sdram执行这个函数，那么这个函数一定在sdram中我们需要指定让他去前面这块内存去读这个值，担心如果这个文件很大，超过4K造成nand就没法去读这个文件</span><br><span class="hljs-comment">     */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, und_addr <span class="hljs-comment">/* vector 4 : und */</span><br><br>    <span class="hljs-comment">/*为什么不直接用ldr pc, =do_und</span><br><span class="hljs-comment">     *使用伪指令时，他并不是直接把do_und的地址传给pc,而是到一个编译器确定的地址读取数据，而这个地址存放着do_und的地址，且这个地址通常会放在汇编文件的最后面，若start.S很小则没关系，若start.S超过4k，编译器就有可能去4k之外的地方取值，若板子是NAND启动的话，在4k之外就取不到值。</span><br><span class="hljs-comment">     *所以我们最好指定它去前面这块内存来读值</span><br><span class="hljs-comment">     */</span>   <br>    <span class="hljs-comment">/* .word就是在当前地址，即und_addr处放一个值do_und</span><br><span class="hljs-comment">     * 主要是为了占领一个位置，不让这个地址放到CPU的片内srom以外了，不然就找不到他了。</span><br><span class="hljs-comment">     */</span> <br>    und_addr:<br>        <span class="hljs-meta">.word</span> do_und<br>    <br>    do_und:<br>        <span class="hljs-comment">/* sp_und未设置, 先设置它 */</span><br>    <br>        <span class="hljs-comment">/* 保存现场 */</span><br>        <span class="hljs-comment">/* 处理und异常 */</span><br>        <br>        <span class="hljs-comment">/* 恢复现场 */</span><br>        <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr的值恢复到cpsr里 */</span><br>        <br>    und_string:<br>        .string <span class="hljs-string">&quot;undefined instruction exception&quot;</span><br>    <span class="hljs-comment">/* 如果你的程序长度稍有变化，就不能保证运行 </span><br><span class="hljs-comment">     * 加上 .align 4才能保证后面的程序以4字节对齐，保证程序运行 </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">.align</span> <span class="hljs-number">4</span><br>    <br>    reset:<br>        <span class="hljs-comment">/* 关闭看门狗 */</span><br><br>        <span class="hljs-comment">/* 设置MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */</span><br><br>        <span class="hljs-comment">/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */</span><br><br>        <span class="hljs-comment">/* 设置CPU工作于异步模式 */</span><br>  <br>        <span class="hljs-comment">/* 设置MPLLCON(0x4C000004) = (92&lt;&lt;12)|(1&lt;&lt;4)|(1&lt;&lt;0)           </span><br><span class="hljs-comment">         *  FCLK = 2*m*Fin/(p*2^s) = 2*100*12/(3*2^1)=400M          </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* 一旦设置PLL, 就会锁定lock time直到PLL输出稳定          </span><br><span class="hljs-comment">         * 然后CPU工作于新的频率FCLK          </span><br><span class="hljs-comment">         */</span><br>    <br>        <span class="hljs-comment">/* 设置内存: sp 栈 */</span><br>        <span class="hljs-comment">/* 分辨是nor/nand启动          </span><br><span class="hljs-comment">         * 写0到0地址, 再读出来          </span><br><span class="hljs-comment">         * 如果得到0, 表示0地址上的内容被修改了, 它对应ram, 这就是nand启动          </span><br><span class="hljs-comment">         * 否则就是nor启动           </span><br><span class="hljs-comment">         */</span><br>    <br>        <span class="hljs-comment">/* 重定位text, rodata, data段整个程序 */</span><br>    <br>        <span class="hljs-comment">/* 清除BSS段 */</span><br><br>        <span class="hljs-comment">/* 把sdram表示的值(sdram的(链接)地址)赋值给pc，使pc直接就跳转到SDRAM中执行sdram */</span><br>        <span class="hljs-comment">/* 重定位完后就应该跳到SDRAM中执行，因为uart0_init,print1两个函数有可能在4k之外 */</span>   <br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=sdram</span><br>    sdram:<br>        <span class="hljs-keyword">bl</span> uart0_init<br>    <br>        <span class="hljs-keyword">bl</span> print1<br><br>        <span class="hljs-comment">/* 故意加入一条未定义指令 */</span><br>    <br>        <span class="hljs-comment">//bl main  /* 使用BL命令相对跳转, 程序仍然在NOR/sram执行 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=main</span>  <span class="hljs-comment">/* 绝对跳转, 跳到SDRAM */</span><br>    <br>    halt:<br>        <span class="hljs-keyword">b</span> halt<br></code></pre></td></tr></table></figure>

<p>编译指定-Ttext0x30000000时，ldr pc, &#x3D;sdram 即是把sdram的链接地址0x30000010赋给PC，实现程序跳转到SDRAM中运行。</p>
<p>问题一：Makefile中没有用到-Ttext 0x30000000，那么它是怎么知道指定的起始&#x2F;链接地址？</p>
<p>答：通过lds链接脚本确定</p>
<p>若此处有不明白之处，参考笔记“链接地址，存储地址的理解”</p>
<p>看一下整个程序的执行过程</p>
<p><img src="/image/4c83b7f226192bc431db62da91d180c9.png" srcset="/img/loading.gif" lazyload alt="4c83b7f226192bc431db62da91d180c9.png"></p>
<p><strong>swi异常程序示例</strong></p>
<hr>
<p>这节我们再来演示swi的处理流程</p>
<p>swi软件中断:software interrupt</p>
<p>在前面的视频中我们讲过ARMCPU有7种模式，除了用户模式以外，其他6种都是特权模式，这些特权模式都可以通过直接修改CPSR进入其他模式(usr用户模式不能修改CPSR进入其他模式)</p>
<p>Linux应用程序一般运行于usr用户模式</p>
<p>APP运行于user mode，(受限模式，不可访问硬件)</p>
<p>APP想访问硬件，必须切换模式，怎么切换？</p>
<p>发生异常</p>
<ul>
<li>中断(中断是一种异常,但可遇不可求)</li>
<li>und</li>
<li>swi + 某个值val(使用软中断切换模式)(可以使用这个值分辨为什么执行这条指令)</li>
</ul>
<p>现在start.S把要做的事情列出来</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">/*<span class="hljs-number">1</span> <br>    /* 复位之后, cpu处于svc模式  <br>     * 现在, 切换到usr模式  <br>     * 设置栈sp_usr  <br>     * 跳转执行 <br>     */<br><br><span class="hljs-regexp">/*2 故意引入一条swi指令*/</span><br><br><span class="hljs-regexp">/*3 需在_start这里放一条swi指令*/</span><br></code></pre></td></tr></table></figure>

<p>查看异常向量表swi异常的向量地址是0x8</p>
<p><img src="/image/cb46877f626bca675c1d305c342e0023.png" srcset="/img/loading.gif" lazyload alt="cb46877f626bca675c1d305c342e0023.png"></p>
<p>我们先切换到usr模式下</p>
<p><img src="/image/136bfc8c086cfdbfbaf9f6163e1568f0.png" srcset="/img/loading.gif" lazyload alt="136bfc8c086cfdbfbaf9f6163e1568f0.png"></p>
<p><img src="/image/d7d4629fc1fa3da8105353615902a2f3.png" srcset="/img/loading.gif" lazyload alt="d7d4629fc1fa3da8105353615902a2f3.png"></p>
<p>usr模式下的 M0 ~ M4是10000</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment">/*5 先进入usr模式*/</span><br><span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>      <span class="hljs-comment">/* 读出cpsr 读到r0 */</span><br>/使用bic命令 bitclean 把低<span class="hljs-number">4</span>位清零/<br><span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0xf</span>  <span class="hljs-comment">/* 修改M4-M0为0b10000, 进入usr模式 */</span><br><span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span><br><br><span class="hljs-comment">/*6 设置栈*/</span><br><span class="hljs-comment">/* 设置 sp_usr */</span><br><span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33f00000</span><br></code></pre></td></tr></table></figure>

<p>编译运行</p>
<p>发现可以处理und指令</p>
<p>添加 swi异常，仿照未定义指令做</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">.text</span><br><span class="hljs-symbol">.global</span> _start<br><br><span class="hljs-symbol">_start:</span><br>        <span class="hljs-keyword">b</span> reset          <span class="hljs-comment">/* vector 0 : reset */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, und_addr <span class="hljs-comment">/* vector 4 : und */</span><span class="hljs-comment">/*1 添加swi指令*/</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, swi_addr <span class="hljs-comment">/* vector 8 : swi */</span><br><br><span class="hljs-symbol">und_addr:</span><br>        <span class="hljs-meta">.word</span> do_und<br><br><span class="hljs-comment">/*2 仿照und未定义添加指令*/</span><br><span class="hljs-symbol">swi_addr:</span><br>        <span class="hljs-meta">.word</span> do_swi<br><br><span class="hljs-symbol">do_und:</span><br>        <span class="hljs-comment">/* 省略 */</span><br><br><span class="hljs-comment">/*3 复制do_und修改为swi */</span><br><span class="hljs-symbol">do_swi:</span><br>        <span class="hljs-comment">/* 执行到这里之前:  </span><br><span class="hljs-comment">         * 3.1. lr_svc保存有被中断模式中的下一条即将执行的指令的地址  </span><br><span class="hljs-comment">         * 3.2. SPSR_svc保存有被中断模式的CPSR  </span><br><span class="hljs-comment">         * 3.3. CPSR中的M4-M0被设置为10011, 进入到svc模式  </span><br><span class="hljs-comment">         * 3.4. 跳到0x08的地方执行程序   </span><br><span class="hljs-comment">         */</span> <br><br>        <span class="hljs-comment">/* 3.5 sp_svc未设置, 先设置它 */</span><br>        <span class="hljs-comment">/* 这种栈可以随便设置，只要指向没有使用的内存就好 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33e00000</span><br><br>        <span class="hljs-comment">/* 3.6 在swi异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>        <span class="hljs-comment">/* 3.7 lr是异常处理完后的返回地址, 也要保存 */</span><br>        <span class="hljs-keyword">stmdb</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">lr</span>&#125;  <br>        <br>        <span class="hljs-comment">/* 3.8 保存现场 */</span><br>        <span class="hljs-comment">/* 3.9 处理swi异常 只是打印 */</span><br>        <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-symbol">=swi_string</span><br>        <span class="hljs-keyword">bl</span> printException<br>        <br>        <span class="hljs-comment">/*3.10  恢复现场 */</span><br>        <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr的值恢复到cpsr里 */</span><br><br><span class="hljs-comment">/*swi处理函数*/</span>       <br><span class="hljs-symbol">swi_string:</span><br>        .string <span class="hljs-string">&quot;swi exception&quot;</span><br></code></pre></td></tr></table></figure>

<p>上传代码实验，烧写，发现没有执行</p>
<p>程序问题出现在</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">.<span class="hljs-built_in">string</span> <span class="hljs-string">&quot;swi exception&quot;</span><br></code></pre></td></tr></table></figure>

<p>这句话，为什么加上这句话程序就无法执行，查看一下反汇编：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-number">30000064</span> &lt;swi_string&gt;: <span class="hljs-comment">//这里地址是64</span><br><span class="hljs-number">30000064</span>:  <span class="hljs-number">20697773</span>     <span class="hljs-keyword">rsbcs</span>    <span class="hljs-built_in">r7</span>, <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">r3</span>, rror <span class="hljs-built_in">r7</span><br><span class="hljs-number">30000068</span>:  <span class="hljs-number">65637865</span>     strvsb   <span class="hljs-built_in">r7</span>, [<span class="hljs-built_in">r3</span>, #-<span class="hljs-number">2149</span>]!<br><span class="hljs-number">3000007</span>c:    <span class="hljs-number">6</span>f697470  <span class="hljs-keyword">swivs</span>    <span class="hljs-number">0x00697470</span><br><span class="hljs-number">30000070</span>:  <span class="hljs-number">0000006</span>e      <span class="hljs-keyword">andeq</span>    <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">lr</span>, <span class="hljs-keyword">rrx</span><br><br><span class="hljs-number">30000082</span> &lt;reset&gt;: <span class="hljs-comment">//我们使用的是ARM指令集，应该是4字节对齐，发现这里并不是，问题就在这里</span><br><span class="hljs-number">30000082</span>:  e3a00453         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r0</span>, <span class="hljs-number">#1392508928</span>  <span class="hljs-comment">; 0x53000000</span><br><span class="hljs-number">30000086</span>:  e3a01000         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span>   <span class="hljs-comment">; 0x0</span><br><span class="hljs-number">3000008</span>a:  e5801000         <span class="hljs-keyword">str</span>      <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><span class="hljs-number">3000008</span>e:  e3a00313         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r0</span>, <span class="hljs-number">#1275068416</span>  <span class="hljs-comment">; 0x4c000000</span><br><span class="hljs-number">30000092</span>:  e3e01000         <span class="hljs-keyword">mvn</span>      <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span>   <span class="hljs-comment">; 0x0</span><br></code></pre></td></tr></table></figure>

<p>因为这个字符串长度有问题</p>
<p>前面und_string 那里的字符串长度刚刚好</p>
<p>添加4字节对齐：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">und_string:</span><br>    .string<span class="hljs-string">&quot;undefined instruction exception&quot;</span><br><br><span class="hljs-comment">/* 以4字节对齐</span><br><span class="hljs-comment"> * 放在可能影响对齐的字符串后面</span><br><span class="hljs-comment"> */</span><br><span class="hljs-symbol">.align</span> <span class="hljs-number">4</span><br><br><span class="hljs-symbol">do_swi:</span><br>        <span class="hljs-comment">/* 执行到这里之前:  </span><br><span class="hljs-comment">         * 3.1. lr_svc保存有被中断模式中的下一条即将执行的指令的地址  </span><br><span class="hljs-comment">         * 3.2. SPSR_svc保存有被中断模式的CPSR  </span><br><span class="hljs-comment">         * 3.3. CPSR中的M4-M0被设置为10011, 进入到svc模式  </span><br><span class="hljs-comment">         * 3.4. 跳到0x08的地方执行程序   </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* 3.5 sp_svc未设置, 先设置它 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33e00000</span><br><br>        <span class="hljs-comment">/* 3.6 在swi异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>        <span class="hljs-comment">/* 3.7 lr是异常处理完后的返回地址, 也要保存 */</span><br>        <span class="hljs-keyword">stmdb</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">lr</span>&#125;  <br>        <br>        <span class="hljs-comment">/* 3.8 保存现场 */</span><br>        <span class="hljs-comment">/* 3.9 处理swi异常 只是打印 */</span><br>        <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-symbol">=swi_string</span><br>        <span class="hljs-keyword">bl</span> printException<br>        <br>        <span class="hljs-comment">/*3.10  恢复现场 */</span><br>        <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr的值恢复到cpsr里 */</span><br><br><span class="hljs-comment">/*****</span><br><span class="hljs-comment">swi处理函数</span><br><span class="hljs-comment">*/</span>        <br><span class="hljs-symbol">swi_string:</span><br>        .string <span class="hljs-string">&quot;swi exception&quot;</span><br><br><span class="hljs-symbol">.align</span> <span class="hljs-number">4</span><br><span class="hljs-comment">/**************</span><br><span class="hljs-comment">放在可能影响对齐的字符串后面</span><br><span class="hljs-comment">表明下面的标号要放在4字节对齐的地方</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-symbol">reset:</span><br></code></pre></td></tr></table></figure>

<p>上传代码编译运行查看反汇编：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-number">30000068</span> &lt;swi_string&gt;:<br><span class="hljs-number">30000068</span>:  <span class="hljs-number">20697773</span>     <span class="hljs-keyword">rsbcs</span>    <span class="hljs-built_in">r7</span>, <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">r3</span>, <span class="hljs-keyword">ror</span> <span class="hljs-built_in">r7</span><br><span class="hljs-number">3000006</span>c:    <span class="hljs-number">65637865</span>     strvsb   <span class="hljs-built_in">r7</span>, [<span class="hljs-built_in">r3</span>, #-<span class="hljs-number">2149</span>]!<br><span class="hljs-number">30000070</span>:  <span class="hljs-number">6</span>f697470  <span class="hljs-keyword">swivs</span>    <span class="hljs-number">0x00697470</span><br><span class="hljs-number">30000074</span>:  <span class="hljs-number">0000006</span>e      <span class="hljs-keyword">andeq</span>    <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">lr</span>, <span class="hljs-keyword">rrx</span><br>        ...<br><br><span class="hljs-number">30000080</span> &lt;reset&gt;: <span class="hljs-comment">//现在reset放在4自己对齐的地方30000080:  e3a00453         mov      r0, #1392508928  ; 0x53000000</span><br><span class="hljs-number">30000084</span>:  e3a01000         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span>   <span class="hljs-comment">; 0x0</span><br><span class="hljs-number">30000088</span>:  e5801000         <span class="hljs-keyword">str</span>      <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><span class="hljs-number">3000008</span>c:    e3a00313         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r0</span>, <span class="hljs-number">#1275068416</span>  <span class="hljs-comment">; 0x4c000000</span><br><span class="hljs-number">30000090</span>:  e3e01000         <span class="hljs-keyword">mvn</span>      <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span>   <span class="hljs-comment">; 0x0</span><br><span class="hljs-number">30000094</span>:  e5801000         <span class="hljs-keyword">str</span>      <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><span class="hljs-number">30000098</span>:  e59f0084         <span class="hljs-keyword">ldr</span>      <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">pc</span>, <span class="hljs-number">#132</span>]       <span class="hljs-comment">; </span><br><span class="hljs-number">30000124</span> &lt;<span class="hljs-meta">.text</span>+<span class="hljs-number">0x124</span>&gt;<br><span class="hljs-number">3000009</span>c:    e3a01005         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r1</span>, <span class="hljs-number">#5</span>   <span class="hljs-comment">; 0x5</span><br><span class="hljs-number">300000</span>a0:    e5801000         <span class="hljs-keyword">str</span>      <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><span class="hljs-number">300000</span><span class="hljs-built_in">a4</span>:    ee110f10         <span class="hljs-keyword">mrc</span>      <span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, cr1, cr0, &#123;<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">300000</span>a8:    e3700103         <span class="hljs-keyword">orr</span>      <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, #-<span class="hljs-number">1073741824</span>     <span class="hljs-comment">; 0xc0000000</span><br><span class="hljs-number">300000</span>ac:    ee010f10         mcr      <span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">r0</span>, cr1, cr0, &#123;<span class="hljs-number">0</span>&#125;<br><span class="hljs-number">300000</span>b0:    e59f0070         <span class="hljs-keyword">ldr</span>      <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">pc</span>, <span class="hljs-number">#112</span>]       <span class="hljs-comment">; </span><br><span class="hljs-number">30000128</span> &lt;<span class="hljs-meta">.text</span>+<span class="hljs-number">0x128</span>&gt;<br><span class="hljs-number">300000</span>b4:    e59f1070         <span class="hljs-keyword">ldr</span>      <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">pc</span>, <span class="hljs-number">#112</span>]       <span class="hljs-comment">; </span><br><span class="hljs-number">3000012</span>c &lt;<span class="hljs-meta">.text</span>+<span class="hljs-number">0x12c</span>&gt;<br><span class="hljs-number">300000</span>b8:    e5801000         <span class="hljs-keyword">str</span>      <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><span class="hljs-number">300000</span>bc:    e3a01000         <span class="hljs-keyword">mov</span>      <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span>   <span class="hljs-comment">; 0x0</span><br><span class="hljs-number">300000</span><span class="hljs-built_in">c0</span>:    e5910000         <span class="hljs-keyword">ldr</span>      <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>]<br></code></pre></td></tr></table></figure>

<p>下载烧写，程序执行完全没有问题</p>
<p>程序备份修改代码</p>
<p>swi可以根据应用程序传入的val来判断为什么调用swi指令，试下我们的异常处理函数能不能把这个val值读出来</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">do_swi:</span><br>        <span class="hljs-comment">/* 执行到这里之前:  </span><br><span class="hljs-comment">         * 1. lr_svc保存有被中断模式中的下一条即将执行的指令的地址  </span><br><span class="hljs-comment">         * 2. SPSR_svc保存有被中断模式的CPSR  </span><br><span class="hljs-comment">         * 3. CPSR中的M4-M0被设置为10011, 进入到svc模式  </span><br><span class="hljs-comment">         * 4. 跳到0x08的地方执行程序   </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* sp_svc未设置, 先设置它 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33e00000</span><br><br>        <span class="hljs-comment">/* 保存现场 */</span><br>        <span class="hljs-comment">/* 在swi异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>        <span class="hljs-comment">/* lr是异常处理完后的返回地址, 也要保存 */</span><br>        <span class="hljs-keyword">stmdb</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">lr</span>&#125;  <br><br><span class="hljs-comment">/* 2</span><br><span class="hljs-comment"> * 我们要把lr拿出来保存，因为bl printException会破坏存储了sw 0x123的下一条指令ldr pc,=main的地址的lr。使用mov rX， lr保存寄存器lr，且这个函数 bl printException 可能会修改某些寄存器，但是又会恢复这些寄存器，根据ATPCS规则得知他会保存r4 ~ r11这些寄存器。如果用到的话就把他保存起来，执行完C函数后把它释放掉，我们把lr保存在r4寄存器里，r4寄存器就不会被C函数printException破坏</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">r4</span>, <span class="hljs-built_in">lr</span><br>        <br>    <span class="hljs-comment">/* 处理swi异常 */</span><br>    <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-symbol">=swi_string</span><br>    <span class="hljs-keyword">bl</span> printException<br>        <br><span class="hljs-comment">/* 1</span><br><span class="hljs-comment"> * 此时跳转到printSWIVal，我们如何才能知道swi的值呢？</span><br><span class="hljs-comment">我们得读出swi 0x123这条指令的内存地址，而执行完swi 0x123指令以后，会发生一次异常，异常模式里的lr寄存器会保存下一条指令的地址，那么把lr寄存器的地址减去4就是swi 0x123这条指令的地址</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* 3</span><br><span class="hljs-comment"> * 把r4的寄存器值(ldr pc,=main指令的地址)-4赋给r0，传递给打印函数，然后打印val</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-keyword">sub</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r4</span>, <span class="hljs-number">#4</span><br>    <span class="hljs-keyword">bl</span> printSWIVal<br>        <br>    <span class="hljs-comment">/* 恢复现场 */</span><br>    <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr的值恢复到cpsr里 */</span><br>        <br><span class="hljs-symbol">swi_string:</span><br>    .string <span class="hljs-string">&quot;swi exception&quot;</span><br><br><span class="hljs-comment">/* uart.c */</span>添加printSWIVal打印函数<br><br><span class="hljs-comment">/* 打印出val，即发生异常的内存地址(除高八位) */</span><br><span class="hljs-symbol">void</span> printSWIVal(unsigned int *pSWI)<br>&#123;<br>        puts(<span class="hljs-string">&quot;SWI val = &quot;</span>)<span class="hljs-comment">;</span><br>        printHEx(*pSWI &amp; ~<span class="hljs-number">0xff000000</span>)<span class="hljs-comment">; //高8位忽略掉  </span><br>        puts(<span class="hljs-string">&quot;\n\r&quot;</span>)<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译实验运行没有问题</p>
<p><img src="/image/700px-Chapter14_lesson5_002.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter14_lesson5_002.png"></p>
<p><strong>_按键中断程序示例_概述与初始</strong></p>
<hr>
<p><strong>中断的处理流程：</strong> </p>
<ol>
<li>中断初始化：</li>
</ol>
<p>a. 我们需要设置中断源，让它能够发出中断信号</p>
<p>b. 设置中断控制器，让它能发出中断给CPU</p>
<p>c. 设置CPU，CPSR有I位，是总开关</p>
<p>（我们需要这样设置，中断源才能发送给CPU）</p>
<ol>
<li>处理完要清中断（相比异常，多了清理中断的操作 ）</li>
<li>处理时，要分辨中断源，对于不同的中断源要执行不同的处理函数</li>
</ol>
<p>下面开始写代码</p>
<p>打开start.S 先做初始化工作，先做第 3 设置CPU，CPSR有I位，是总开关</p>
<p>我们需要把CPSR寄存器 bit7给清零，这是中断的总开关，如果bit7设置为1，CPU无法响应任何中断</p>
<p><img src="/image/136bfc8c086cfdbfbaf9f6163e1568f0.png" srcset="/img/loading.gif" lazyload alt="136bfc8c086cfdbfbaf9f6163e1568f0.png"></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs armasm">    <span class="hljs-comment">/* 清除BSS段 */</span><br>    <span class="hljs-keyword">bl</span> clean_bss<br><br>    <span class="hljs-comment">/* 复位之后, cpu处于svc模式  </span><br><span class="hljs-comment">     * 现在, 切换到usr模式  </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>         <span class="hljs-comment">/* 读出cpsr */</span><br>    <span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0xf</span>     <span class="hljs-comment">/* 修改M4-M0为0b10000, 进入usr模式 */</span><br><br><span class="hljs-comment">/*1 把bit7这一位清零 */</span><br>    <span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, #(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>)  <span class="hljs-comment">/* 清除I位, 使能中断 */</span><br>    <span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span><br><br>    <span class="hljs-comment">/* 设置 sp_usr */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33f00000</span><br><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=sdram</span><br><span class="hljs-symbol">sdram:</span><br>    <span class="hljs-keyword">bl</span> uart0_init<br><br>    <span class="hljs-keyword">bl</span> print1<br>    <span class="hljs-comment">/* 故意加入一条未定义指令 */</span><br><span class="hljs-symbol">und_code:</span><br>    <span class="hljs-meta">.word</span> <span class="hljs-number">0xdeadc0de</span>  <span class="hljs-comment">/* 未定义指令 */</span><br>    <span class="hljs-keyword">bl</span> print2<br><br>    <span class="hljs-keyword">swi</span> <span class="hljs-number">0x123</span>  <span class="hljs-comment">/* 执行此命令, 触发SWI异常, 进入0x8执行 */</span><br><br><span class="hljs-comment">/*2 调用两个中断 */</span><br>    <span class="hljs-keyword">bl</span> interrupt_init <span class="hljs-comment">/* 初始化中断控制器 */</span><br>    <span class="hljs-keyword">bl</span> key_eint_init <span class="hljs-comment">/* 初始化按键，设为中断源 */</span><br><br><span class="hljs-comment">/* 需要初始化上面这两个函数 */</span><br>    <span class="hljs-comment">//bl main  /* 使用BL命令相对跳转, 程序仍然在NOR/sram执行 */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=main</span>  <span class="hljs-comment">/* 绝对跳转, 跳到SDRAM */</span><br><br><span class="hljs-symbol">halt:</span><br>    <span class="hljs-keyword">b</span> halt<br></code></pre></td></tr></table></figure>

<p>添加一个 interrupt.c文件，这个程序稍微有些复杂，我们先画个流程图</p>
<p> <img src="/image/Chapter14_lesson6_002.png" srcset="/img/loading.gif" lazyload alt="Chapter14_lesson6_002.png"></p>
<p>我们想达到按下按键灯亮松开按键灯灭，把下面四个按键全部配置为外部中断按键</p>
<p><img src="/image/12ded688d46c48aa3521c1ae0464616d.png" srcset="/img/loading.gif" lazyload alt="12ded688d46c48aa3521c1ae0464616d.png"></p>
<p>打开芯片手册找到第九章 IO ports，直接搜索“’EINT0号中断和EINT2号中断”’，找配置寄存器 GPFCON</p>
<p><img src="/image/d15ed2551d92ee42a203de78e0d0d88a.png" srcset="/img/loading.gif" lazyload alt="d15ed2551d92ee42a203de78e0d0d88a.png"></p>
<p>为了简单操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* 初始化按键, 设为中断源 */</span><br>void key_eint_init(void)<br>&#123;<br><span class="hljs-regexp">/*1 配置GPIO为中断引脚 */</span><br><span class="hljs-regexp">//</span>先把eint0和eint2这两个引脚清零<br>GPFCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">4</span>));<br>GPFCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">4</span>));   <span class="hljs-regexp">/* S2,S3被配置为中断引脚 */</span><br></code></pre></td></tr></table></figure>

<p>通过电路图得知 S4 S5按键为EINT11号中断引脚和EINT19号中断引脚</p>
<p><img src="/image/b0a4affe35fb0524909151ffa32b8682.png" srcset="/img/loading.gif" lazyload alt="b0a4affe35fb0524909151ffa32b8682.png"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GPGCON</span> &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">22</span>));<br><span class="hljs-attribute">GPGCON</span> |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">22</span>));   /* S4,S5被配置为中断引脚 */<br></code></pre></td></tr></table></figure>

<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">/*2 设置中断触发方式: (按下松开，从低电源变为高电源，或者从低电源变为高电源双边沿触发)</span><br><span class="hljs-comment">设置EINT0 EINT2为双边沿触发 */</span><br><br>EXTI<span class="hljs-symbol">NT0</span> |= <span class="hljs-comment">(7&lt;&lt;0)</span> | <span class="hljs-comment">(7&lt;&lt;8)</span>;     <span class="hljs-comment">/* S2,S3 */</span><br></code></pre></td></tr></table></figure>

<p><img src="/image/54019a20aabe6d0f047bae6f14a2ebdb.png" srcset="/img/loading.gif" lazyload alt="54019a20aabe6d0f047bae6f14a2ebdb.png"></p>
<p>设置EINT11为双边沿触发</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">EXTI<span class="hljs-symbol">NT1</span> |= <span class="hljs-comment">(7&lt;&lt;12)</span>;             <span class="hljs-comment">/* S4 */</span><br></code></pre></td></tr></table></figure>

<p>设置EINT19为双边沿触发</p>
<p><img src="/image/f17a90c67b39bc8cdfefdcd1c14f0889.png" srcset="/img/loading.gif" lazyload alt="f17a90c67b39bc8cdfefdcd1c14f0889.png"></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">EXTI<span class="hljs-symbol">NT2</span> |= <span class="hljs-comment">(7&lt;&lt;12)</span>;             <span class="hljs-comment">/* S5 */</span><br></code></pre></td></tr></table></figure>

<p><img src="/image/c6153354099cc21cde644195a3fded8a.png" srcset="/img/loading.gif" lazyload alt="c6153354099cc21cde644195a3fded8a.png"></p>
<p>外部中断屏蔽寄存器EINTMASK：设置为1的话就禁止向外部发出中断信号，只有EINTMASK相应的位设置为0外部中断才能给中断控制器发信号</p>
<p>我们需要设置这个寄存器</p>
<p><img src="/image/2d8c3b4b89685e7cd77a809b36555d05.png" srcset="/img/loading.gif" lazyload alt="2d8c3b4b89685e7cd77a809b36555d05.png"></p>
<p>把EINT11设置为0 把EINT19设置为0对于EINT0 和EINT2显示为保留，默认时使能的，可以直接发送给中断控制器，无需设置</p>
<p><img src="/image/700px-Chapter14_lesson6_0011.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter14_lesson6_0011.png"></p>
<p>设置EINTMASK使能eint11,19</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">EINTMASK</span> &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">19</span>));<br></code></pre></td></tr></table></figure>

<p>EINTPEND：当发生中断时可以读这个寄存器确认是产生了哪个EINT(eint4~23)(并且要清除它)</p>
<p>清除中断时, 写EINTPEND的相应位为0</p>
<p><img src="/image/de4721414cc408358081c71fc2d2c48c.png" srcset="/img/loading.gif" lazyload alt="de4721414cc408358081c71fc2d2c48c.png"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* 初始化按键, 设为中断源 */</span><br>void key_eint_init(void)<br>&#123;<br>    <span class="hljs-regexp">/* 配置GPIO为中断引脚 */</span><br>    GPFCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">4</span>));<br>    GPFCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">4</span>));   <span class="hljs-regexp">/* S2,S3被配置为中断引脚 */</span><br><br>    GPGCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">11</span>));<br>    GPGCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">11</span>));   <span class="hljs-regexp">/* S4,S5被配置为中断引脚 */</span><br><br>    <span class="hljs-regexp">/* 设置中断触发方式: 双边沿触发 */</span><br>    EXTINT0 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">8</span>);     <span class="hljs-regexp">/* S2,S3 */</span><br>    EXTINT1 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">12</span>);             <span class="hljs-regexp">/* S4 */</span><br>    EXTINT2 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">12</span>);             <span class="hljs-regexp">/* S5 */</span><br><br>    <span class="hljs-regexp">/* 设置EINTMASK使能eint11,19 */</span><br>    EINTMASK &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">19</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来需要阅读’第14章 Interrupt Controller章节设置中断控制器我们只需要按照下面这张流程图Figure 14-1设置就可以了</p>
<p><img src="/image/1a42bfaa519db705869ef805e4faff6c.png" srcset="/img/loading.gif" lazyload alt="1a42bfaa519db705869ef805e4faff6c.png"></p>
<p>我们来看一下外部中断属于哪一种,需不需要设置SUBSRCPND</p>
<p>打开芯片手册，从上往下读</p>
<p><img src="/image/b436fdac06f773f584b03539726ecb3b.png" srcset="/img/loading.gif" lazyload alt="b436fdac06f773f584b03539726ecb3b.png"></p>
<p>由上图可得 EINT4_7 EINT8_23合用一条中断线ARB1</p>
<p>也就是可以直接到达SRCPND不需要设置SUBSRCPND和SUBMASK这两个寄存器</p>
<p>我们只需要设置</p>
<ul>
<li>SRCPND不同的中断类型不可以直接到达这里执行</li>
<li>MASK 屏蔽寄存器</li>
<li>INTPND 等待处理，我们可以读这个寄存器，确定是那个中断产生了</li>
</ul>
<p><img src="/image/700px-Chapter14_lesson6_0014.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter14_lesson6_0014.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/<span class="hljs-emphasis">* SRCPND 用来显示哪个中断产生了, 需要清除对应位，我们只需要关心  </span><br><span class="hljs-emphasis"> *</span> bit0对应eint0  <br> <span class="hljs-emphasis">* bit2对应eint2  </span><br><span class="hljs-emphasis"> *</span> bit5对应eint8<span class="hljs-emphasis">_23(表明bit5等于1的时候 eint8_</span>23中的某一个已经产生，我们需要继续分辨  <br> <span class="hljs-emphasis">* 读EINTPEND分辨是哪个EINT产生)  </span><br><span class="hljs-emphasis"> *</span>/<br></code></pre></td></tr></table></figure>

<p>INTMOD寄存器 默认值为IRQ模式即可，不需要设置</p>
<p><img src="/image/388eb1ae56a0e00eb08fe1b280c3508c.png" srcset="/img/loading.gif" lazyload alt="388eb1ae56a0e00eb08fe1b280c3508c.png"></p>
<p>INTMASK寄存器，需要设置为0</p>
<p><img src="/image/9dba24c50318ce93233af097feefd2ef.png" srcset="/img/loading.gif" lazyload alt="9dba24c50318ce93233af097feefd2ef.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/<span class="hljs-emphasis">* INTMSK 用来屏蔽中断, 1对应masked屏蔽中断，我们需要设置相应位设置为0  </span><br><span class="hljs-emphasis"> *</span> bit0-eint0  <br> <span class="hljs-emphasis">* bit2-eint2  </span><br><span class="hljs-emphasis"> *</span> bit5-eint8<span class="hljs-emphasis">_23  </span><br><span class="hljs-emphasis"> */</span><br></code></pre></td></tr></table></figure>

<p>同时可能有多个中断产生，这么多个中断经过优先级以后，只会有一个通知CPU，是哪一个中断优先级最高，可以读INTPAD就能知道当前处理的唯一 一 个中断是哪一个</p>
<p><img src="/image/fb8f2cb4442897d291455a375fa81c19.png" srcset="/img/loading.gif" lazyload alt="fb8f2cb4442897d291455a375fa81c19.png"></p>
<p>1 表示这个中断已经产生，需要配置相应的位</p>
<p>INTPND 用来显示当前优先级最高的、正在发生的中断, 需要清除对应位</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/<span class="hljs-emphasis">* INTPND 用来显示当前优先级最高的、正在发生的中断, 需要清除对应位</span><br><span class="hljs-emphasis"> *</span>bit0-eint0<br> <span class="hljs-emphasis">*bit2-eint2</span><br><span class="hljs-emphasis"> *</span>bit5-eint8<span class="hljs-emphasis">_23</span><br><span class="hljs-emphasis"> */</span><br></code></pre></td></tr></table></figure>

<p>INTOFFSET是用来显示INTPND寄存器中是哪一位被设置成1，即正在等待处理</p>
<p><img src="/image/f260fa33f4e83980af9cda33254d29b7.png" srcset="/img/loading.gif" lazyload alt="f260fa33f4e83980af9cda33254d29b7.png"></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">/* INTOFFSET是用来显示INTPND寄存器中是哪一位被设置成1，即正在等待处理 */</span><br>INTPAD中<span class="hljs-keyword">bit0等于1的话INTOFFSET就等于0</span><br><span class="hljs-keyword"></span>INTPAD中<span class="hljs-keyword">bit1等于1的话INTOFFSET值就等于1</span><br><span class="hljs-keyword"></span><br>可以读INTPND，也可以读INTOFFSET确定哪个中断正在等待处理，读INTOFFSET比较方便，且不用清零<br></code></pre></td></tr></table></figure>

<p>SRCPND我们用不到</p>
<p><img src="/image/2e61a1315da6391919e514c23451ff9f.png" srcset="/img/loading.gif" lazyload alt="2e61a1315da6391919e514c23451ff9f.png"></p>
<p>某一位等于1时INT_UART0它的来源可能有多个，这是串口0的中断，串口0的中断产生时有可能是接收到了数据(INT_RXD0),有可能是发送了数据(INT_TXD0),也有可能是产生了错误，那么到底是哪一个呢？</p>
<p>需要去读取SUBSRCPND下一级的源寄存器</p>
<p>我们只需要设置INTMSK这个寄存器</p>
<p>SRCPND和INTPND只有发生中断才需要设置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/* 初始化中断控制器 */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">interrupt_init</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>        <span class="hljs-comment">/* 1是屏蔽我们需要清零，外部中断0 外部中断2 外部中8_23里面还有外部中断11到19 */</span><br>        <span class="hljs-variable constant_">INTMSK</span> &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">2</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改start.S</p>
<p>删除</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">bl</span> interrupt_init  <span class="hljs-comment">/* 初始化中断控制器 */</span><br><span class="hljs-keyword">bl</span> key_eint_init  <span class="hljs-comment">/* 初始化按键, 设为中断源 */</span><br></code></pre></td></tr></table></figure>

<p>能使用C语言就使用C语言，在main.c文件中添加调用C函数：</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs wren">int <span class="hljs-title function_">main</span>(<span class="hljs-params">void</span>)<br>&#123;<br>    <span class="hljs-title function_">interrupt_init</span>();  <span class="hljs-comment">/* 初始化中断控制器 */</span><br>    <span class="hljs-title function_">key_eint_init</span>();   <span class="hljs-comment">/* 初始化按键, 设为中断源 */</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>/        <br>    <span class="hljs-title function_">puts</span>(<span class="hljs-string">&quot;<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>g_A = &quot;</span>);<br>    <span class="hljs-title function_">printHex</span>(<span class="hljs-variable">g_A</span>);<br>    <span class="hljs-title function_">puts</span>(<span class="hljs-string">&quot;<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>_按键中断程序示例_完善</strong></p>
<hr>
<p>首先main.c中 我们初始化中断控制器 初始化中断源</p>
<p>假设按键按下就会产生中断，CPU就会跳到start.S 执行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<p>具体跳到哪里执行，我们需要看看中断向量表在哪里</p>
<p><img src="/image/e952bd32aa16202b20c092df04a3fd51.png" srcset="/img/loading.gif" lazyload alt="e952bd32aa16202b20c092df04a3fd51.png"></p>
<p>IRQ模式的话跳到0x00000018地方</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">_start:</span><br>    <span class="hljs-keyword">b</span> reset                  <span class="hljs-comment">/* vector 0 : reset */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, und_addr         <span class="hljs-comment">/* vector 4 : und */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, swi_addr         <span class="hljs-comment">/* vector 8 : swi */</span><br><span class="hljs-comment">/* b halt：一旦发生异常就卡死 */</span><br>    <span class="hljs-keyword">b</span> halt                   <span class="hljs-comment">/* vector 0x0c : prefetch aboot */</span><br>    <span class="hljs-keyword">b</span> halt                   <span class="hljs-comment">/* vector 0x10 : data abort */</span><br>    <span class="hljs-keyword">b</span> halt                   <span class="hljs-comment">/* vector 0x14 : reserved */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, irq_addr         <span class="hljs-comment">/* vector 0x18 : irq */</span><br>    <span class="hljs-keyword">b</span> halt                   <span class="hljs-comment">/* vector 0x1c : fiq */</span><br><br><span class="hljs-comment">/*3/</span><br><span class="hljs-comment">do_irq: </span><br><span class="hljs-comment">    /* 执行到这里之前:  </span><br><span class="hljs-comment">     * 1. lr_irq保存有被中断模式中的下一条即将执行的指令的地址  </span><br><span class="hljs-comment">     * 2. SPSR_irq保存有被中断模式的CPSR  </span><br><span class="hljs-comment">     * 3. CPSR中的M4-M0被设置为10010, 进入到irq模式  </span><br><span class="hljs-comment">     * 4. 跳到0x18的地方执行程序   </span><br><span class="hljs-comment">     */</span><br><br><span class="hljs-comment">/*4 分配不冲突的没有使用的内存就可以了*/</span><br>    <span class="hljs-comment">/* sp_irq未设置, 先设置它 */</span><br>     <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33d00000</span><br><br><span class="hljs-comment">/*5*/</span><br>     <span class="hljs-comment">/* 保存现场 */</span><br><br><span class="hljs-comment">/*7 发生中断时irq返回值是R14-4 为什么要减去4:硬件结构让你怎么做就怎么做 */</span><br>     <span class="hljs-comment">/* 在irq异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>     <span class="hljs-comment">/* lr-4是异常处理完后的返回地址, 也要保存，在Table2-2查看 */</span><br>     <span class="hljs-keyword">sub</span> <span class="hljs-built_in">lr</span>, <span class="hljs-built_in">lr</span>, <span class="hljs-number">#4</span><br>     <span class="hljs-keyword">stmdb</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">lr</span>&#125;  <br>        <br>    <span class="hljs-comment">/* 处理irq异常 */</span><br><span class="hljs-comment">/*6 在这C函数里分辨中断源，处理中断 */</span><br>    <span class="hljs-keyword">bl</span> handle_irq_c<br><br><span class="hljs-comment">/*8*/</span>     <br>    <span class="hljs-comment">/* 恢复现场 */</span><br>    <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr_irq的值恢复到cpsr里 */</span><br></code></pre></td></tr></table></figure>

<p>接下来我们在interrupt.c中写出 handle_irq_c处理函数 这个是处理中断的C函数</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_irq_c</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/*1 分辨中断源 */</span><br>    <span class="hljs-comment">/* 读INTOFFSET在芯片手册里找到这个寄存器，它里面的值表示INTPND中哪一位被设置成1 */</span><br>    <span class="hljs-type">int</span> bit = INTOFFSET;<br><br>    <span class="hljs-comment">/*2 调用对应的处理函数 */</span><br>    <span class="hljs-keyword">if</span> (bit == <span class="hljs-number">0</span> || bit == <span class="hljs-number">2</span> || bit == <span class="hljs-number">5</span>)  <span class="hljs-comment">/* 对应eint0,2,eint8_23 */</span><br>    &#123;<br>        <span class="hljs-comment">/*我们会调用一个按键处理函数*/</span><br>        <span class="hljs-built_in">key_eint_irq</span>(bit); <span class="hljs-comment">/* 处理中断, 清中断源EINTPEND */</span><br>    &#125;<br><br>    <span class="hljs-comment">/*3 清中断 : 从Figure14-1图中的源头开始清  </span><br><span class="hljs-comment">     *先清除掉中断源里面的某些寄存器  </span><br><span class="hljs-comment">     *再清 SRCPND  </span><br><span class="hljs-comment">     *再清 INTPND </span><br><span class="hljs-comment">     */</span><br>    SRCPND = (<span class="hljs-number">1</span>&lt;&lt;bit);<br>    INTPND = (<span class="hljs-number">1</span>&lt;&lt;bit);     <br>&#125;<br></code></pre></td></tr></table></figure>

<p>读EINTPEND分辨哪个EINT产生(eint4~23)清除中断时, 写EINTPEND的相应位</p>
<p><img src="/image/f5bccdad305d5f4d352fce62e0d4604c.png" srcset="/img/loading.gif" lazyload alt="f5bccdad305d5f4d352fce62e0d4604c.png"></p>
<p>我们使用s2来控制哪盏灯？</p>
<ul>
<li>之前我们写过按键控制led灯的程序，它使用的是s2控制gpf6</li>
<li>也就是s2控制led4 D12</li>
</ul>
<p><img src="/image/9ba631e79479724f79bdee3c818e6596.png" srcset="/img/loading.gif" lazyload alt="9ba631e79479724f79bdee3c818e6596.png"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs awk">void key_eint_irq(int irq)<br>&#123;<br>    <span class="hljs-regexp">/*4 清的时候我先把这个值读出来，清的时候我再把他写进去 */</span><br>    unsigned int val = EINTPEND;<br>    unsigned int val1 = GPFDAT;<br>    unsigned int val2 = GPGDAT;  <br>    <span class="hljs-keyword">if</span> (irq == <span class="hljs-number">0</span>)     <span class="hljs-regexp">/*1 外部中断eint0对应s2按键  */</span><br>    &#123;  <br>    <span class="hljs-regexp">/*1.2 如何知道是按下还是松开，我们需要读值*/</span><br>        <span class="hljs-keyword">if</span> (val1 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>)) <span class="hljs-regexp">/* s2 --&gt; gpf6 */</span><br>        &#123;<br>            <span class="hljs-regexp">/*1.3 松开 */</span><br>            GPFDAT |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-regexp">/*1.4 按下 */</span><br>            GPFDAT &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (irq == <span class="hljs-number">2</span>) <span class="hljs-regexp">/*2 eint2对应s3 控制 D11  LED2 */</span><br>    &#123;<br>            <span class="hljs-keyword">if</span> (val1 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">2</span>)) <span class="hljs-regexp">/* s3 --&gt; gpf5 */</span><br>            &#123;<br>                <span class="hljs-regexp">/* 松开 */</span><br>                GPFDAT |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<br>            &#125;<br>           <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-regexp">/* 按下 */</span><br>                GPFDAT &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<br>            &#125;<br>    &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (irq == <span class="hljs-number">5</span>) <span class="hljs-regexp">/*3 eint8_23, eint11对应s4 控制 D10 LED1, eint19对应s5 控制所有LED */</span><br>        &#123;<br></code></pre></td></tr></table></figure>

<p>irq &#x3D; 5表明发生的事8-23的中断，到底是发生哪一种中断，我们需要读取 EINTPND来判断是哪个中断产生</p>
<p><img src="/image/f8afce629a651780016780a4e69e8104.png" srcset="/img/loading.gif" lazyload alt="f8afce629a651780016780a4e69e8104.png"></p>
<p>如果bit19等于1的话表明外部中断EINT19产生了，如果bit11等于1表用外部中断11产生，这里我们需要判断</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs awk">        <span class="hljs-keyword">if</span> (val &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>)) <span class="hljs-regexp">/* 表明外部中断eint11产生 */</span><br>        &#123;    <br>            <span class="hljs-keyword">if</span> (val2 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>)) <span class="hljs-regexp">/* s4 --&gt; gpf4 */</span><br>            &#123;<br>                <span class="hljs-regexp">/* 松开 */</span><br>                GPFDAT |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-regexp">/* 按下 */</span><br>                GPFDAT &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<br>            &#125;<br>        &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">19</span>)) <span class="hljs-regexp">/* 表用外部中断eint19 */</span><br>    &#123;<br>            <span class="hljs-keyword">if</span> (val2 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>))<br>            &#123;<br>                <span class="hljs-regexp">/* 松开 */</span><br>                <span class="hljs-regexp">/* 熄灭所有LED 输出高电平 */</span><br>                GPFDAT |= ((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>));<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-regexp">/* 按下: 点亮所有LED */</span><br>                GPFDAT &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>));<br>            &#125;<br>    &#125;<br>&#125;<br><span class="hljs-regexp">/*5 再把值写进去就达到了清除的效果 */</span><br>EINTPEND = val;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>包含头文件，上传代码测试</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;S3c2440_soc.h&quot;</span></span><br></code></pre></td></tr></table></figure>

<p>编译通过，开发板上电测试正常工作 回顾中断处理流程</p>
<p>我们start.s 一上电从 _start: 运行 做一些初始化工作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs awk">reset:<br>    <span class="hljs-regexp">/* 关闭看门狗 */</span><br><br>    <span class="hljs-regexp">/* 设置MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */</span><br>    <span class="hljs-regexp">/* LOCKTIME(0x4C000000) = 0xFFFFFFFF */</span><br><br>    <span class="hljs-regexp">/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */</span><br><br>    <span class="hljs-regexp">/* 设置CPU工作于异步模式 */</span><br><br>    /* 设置MPLLCON(<span class="hljs-number">0</span>x4C000004) = (<span class="hljs-number">92</span>&lt;&lt;<span class="hljs-number">12</span>)|(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>)|(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>)   <br>     *  m = MDIV+<span class="hljs-number">8</span> = <span class="hljs-number">92</span>+<span class="hljs-number">8</span>=<span class="hljs-number">100</span>  <br>     *  p = PDIV+<span class="hljs-number">2</span> = <span class="hljs-number">1</span>+<span class="hljs-number">2</span> = <span class="hljs-number">3</span>  <br>     *  s = SDIV = <span class="hljs-number">1</span>  <br>     *  FCLK = <span class="hljs-number">2</span>*m*Fin<span class="hljs-regexp">/(p*2^s) = 2*100*12/</span>(<span class="hljs-number">3</span>*<span class="hljs-number">2</span>^<span class="hljs-number">1</span>)=<span class="hljs-number">400</span>M  <br>     */<br><br>    /* 一旦设置PLL, 就会锁定lock time直到PLL输出稳定  <br>     * 然后CPU工作于新的频率FCLK  <br>     */<br><br>    <span class="hljs-regexp">/* 设置内存: sp 栈 */</span><br>    <span class="hljs-regexp">/* 分辨是nor/</span>nand启动  <br>     * 写<span class="hljs-number">0</span>到<span class="hljs-number">0</span>地址, 再读出来  <br>     * 如果得到<span class="hljs-number">0</span>, 表示<span class="hljs-number">0</span>地址上的内容被修改了, 它对应ram, 这就是nand启动  <br>     * 否则就是nor启动  <br>     */<br><br>    bl sdram_init<br>    <span class="hljs-regexp">//</span>bl sdram_init2  <span class="hljs-regexp">/* 用到有初始值的数组, 不是位置无关码 */</span><br><br>    <span class="hljs-regexp">/* 重定位text, rodata, data段整个程序 */</span><br>    bl copy2sdram<br><br>    <span class="hljs-regexp">/* 清除BSS段 */</span><br>    bl clean_bss<br><br>    /* 复位之后, cpu处于svc模式  <br>     * 现在, 切换到usr模式  <br>     */<br>    mrs r0, cpsr         <span class="hljs-regexp">/* 读出cpsr */</span><br>    bic r0, r0, <span class="hljs-comment">#0xf     /* 修改M4-M0为0b10000, 进入usr模式 */</span><br>    bic r0, r0, <span class="hljs-comment">#(1&lt;&lt;7)  /* 清除I位, 使能中断 */</span><br>    msr cpsr, r0<br><br>    <span class="hljs-regexp">/* 设置 sp_usr */</span><br>    ldr sp, =<span class="hljs-number">0</span>x33f00000<br><br>    ldr pc, =sdramsdram:<br>    bl uart0_init<br><br>    bl print1<br>    <span class="hljs-regexp">/* 故意加入一条未定义指令 */u</span>nd_code:<br>    .word <span class="hljs-number">0</span>xdeadc0de  <span class="hljs-regexp">/* 未定义指令 */</span><br>    bl print2<br><br>    swi <span class="hljs-number">0</span>x123  <span class="hljs-regexp">/* 执行此命令, 触发SWI异常, 进入0x8执行 */</span><br><br>    <span class="hljs-regexp">//</span>bl main  <span class="hljs-regexp">/* 使用BL命令相对跳转, 程序仍然在NOR/</span>sram执行 */<br>    ldr pc, =main  <span class="hljs-regexp">/* 绝对跳转, 跳到SDRAM */</span><br><br>halt:<br>    b halt<br><br><span class="hljs-regexp">//</span>然后设置CPSR开中断<br><span class="hljs-regexp">//</span>然后跳到mian函数，做一些中断初始化<br><br>int main(void)<br>&#123;<br>    led_init();<br>    interrupt_init();  <span class="hljs-regexp">/* 初始化中断控制器 */</span><br>    key_eint_init();   <span class="hljs-regexp">/* 初始化按键, 设为中断源 */</span><br>        <br>    puts(<span class="hljs-string">&quot;\n\rg_A = &quot;</span>);<br>    printHex(g_A);<br>    puts(<span class="hljs-string">&quot;\n\r&quot;</span>);<span class="hljs-regexp">/*让后在main函数里一直循环输出串口*/</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        putchar(g_Char);<br>        g_Char++;<br><br>        putchar(g_Char3);<br>        g_Char3++;<br>        delay(<span class="hljs-number">1000000</span>);<br>        &#125;<br><br><span class="hljs-regexp">//</span>这个时候按下按键就会产生中断，让后进入start.s<br><span class="hljs-regexp">//</span>跳到<span class="hljs-number">0</span>x18 irq模式<br><br>    ldr pc, irq_addr <span class="hljs-regexp">/* vector 0x18 : irq */</span><br><br>它是一条读内存的执行，从irq_addr这里读地址赋给pc<br><br>irq_addr:<br>    .word do_irq<br><br>就跳到sdram执行do_irq函数<br>do_irq:<br>    /* 执行到这里之前:  <br>     * <span class="hljs-number">1</span>. lr_irq保存有被中断模式中的下一条即将执行的指令的地址  <br>     * <span class="hljs-number">2</span>. SPSR_irq保存有被中断模式的CPSR  <br>     * <span class="hljs-number">3</span>. CPSR中的M4-M0被设置为<span class="hljs-number">10010</span>, 进入到irq模式  <br>     * <span class="hljs-number">4</span>. 跳到<span class="hljs-number">0</span>x18的地方执行程序   <br>     */<br><br>    <span class="hljs-regexp">/* sp_irq未设置, 先设置它 */</span><br>    ldr sp, =<span class="hljs-number">0</span>x33d00000<br><br>    <span class="hljs-regexp">/* 保存现场 */</span><br>    <span class="hljs-regexp">/* 在irq异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>    <span class="hljs-regexp">/* lr-4是异常处理完后的返回地址, 也要保存 */</span><br>    sub lr, lr, <span class="hljs-comment">#4</span><br>    stmdb sp!, &#123;r0-r12, lr&#125;  <br>        <br>    <span class="hljs-regexp">/* 处理irq异常 */</span><br>    bl handle_irq_c<br>        <br>    <span class="hljs-regexp">/* 恢复现场 */</span><br><br>它怎么处理<br>/* 读INTOFFSET分辨率哪个EINT产生(eint0，<span class="hljs-number">2</span>，<span class="hljs-number">8</span>~<span class="hljs-number">23</span>) <br> * 调用对应的处理函数<br> * 清除中断<br> */<br><br>void key_eint_irq(int irq)<br>&#123;<br>    unsigned int val = EINTPEND;<br>    unsigned int val1 = GPFDAT;<br>    unsigned int val2 = GPGDAT;<br>        <br>    <span class="hljs-keyword">if</span> (irq == <span class="hljs-number">0</span>) <span class="hljs-regexp">/* eint0 : s2 控制 D12 */</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (val1 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>)) <span class="hljs-regexp">/* s2 --&gt; gpf6 */</span><br>        &#123;<br>            <span class="hljs-regexp">/* 松开 */</span><br>            GPFDAT |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-regexp">/* 按下 */</span><br>            GPFDAT &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (irq == <span class="hljs-number">2</span>) <span class="hljs-regexp">/* eint2 : s3 控制 D11 */</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (val1 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">2</span>)) <span class="hljs-regexp">/* s3 --&gt; gpf5 */</span><br>        &#123;<br>            <span class="hljs-regexp">/* 松开 */</span><br>            GPFDAT |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-regexp">/* 按下 */</span><br>            GPFDAT &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (irq == <span class="hljs-number">5</span>) <span class="hljs-regexp">/* eint8_23, eint11--s4 控制 D10, eint19---s5 控制所有LED */</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (val &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>)) <span class="hljs-regexp">/* eint11 */</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (val2 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>)) <span class="hljs-regexp">/* s4 --&gt; gpf4 */</span><br>            &#123;<br>                <span class="hljs-regexp">/* 松开 */</span><br>                GPFDAT |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-regexp">/* 按下 */</span><br>                GPFDAT &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<br>            &#125;<br>        &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">19</span>)) <span class="hljs-regexp">/* eint19 */</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (val2 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>))<br>        &#123;<br>            <span class="hljs-regexp">/* 松开 */</span><br>            <span class="hljs-regexp">/* 熄灭所有LED */</span><br>            GPFDAT |= ((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>));<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-regexp">/* 按下: 点亮所有LED */</span><br>            GPFDAT &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>));<br>        &#125;<br>    &#125;<br>&#125;<br><br>        EINTPEND = val;<br>&#125;<br>处理完之后清中断，从源头开始清<br></code></pre></td></tr></table></figure>

<p>这完全是按照中断流程操作的</p>
<p><strong>定时器中断程序示例</strong></p>
<hr>
<p>这节课我们来写一个定时器的中断服务程序 使用定时器来实现点灯计数 查考资料就是第10章PWM TIMER 可以参考书籍《嵌入式Linux应用程序开发完全手册》第10章</p>
<p>定时器内部控制逻辑图：</p>
<p><img src="/image/ccd4014ba91cc12d13baa12954f76d3b.png" srcset="/img/loading.gif" lazyload alt="ccd4014ba91cc12d13baa12954f76d3b.png"></p>
<ol>
<li>这里面肯定有一个clk(时钟),每来一个clk(时钟)这个TCNTn减去1 </li>
<li>当TCNTn &#x3D;&#x3D; TCMPn时，不可以产生中断，可以让对应的PWM引脚反转，(比如说原来是高电平，发生之后电平转换成低电平) </li>
<li>TCNTn继续减1，当TCNTn &#x3D;&#x3D; 0时，可以产生中断，pwm引脚再次反转，TCMPn 和 TCNTn的初始值来自 TCMPBn,TCNTBn </li>
<li>TCNTn &#x3D;&#x3D; 0时，可设置成从TCMPBn,TCNTBn这两个寄存器中自动加载初始值</li>
</ol>
<p><strong>怎么使用定时器？</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 设置时钟<br><span class="hljs-bullet">2.</span> 设置初值<br><span class="hljs-bullet">3.</span> 加载初值，启动Timer<br><span class="hljs-bullet">4.</span> 设置为自动加载<br><span class="hljs-bullet">5.</span> 中断相关（选择在哪引出中断）<br></code></pre></td></tr></table></figure>

<p>由于2440没有引出pwm引脚，所以pwm功能无法使用，也就无法做pwm相关实验</p>
<p>所谓pwm是指可调制脉冲</p>
<p><img src="/image/800px-Chapter14_lesson8_002.png" srcset="/img/loading.gif" lazyload alt="800px-Chapter14_lesson8_002.png"></p>
<p>T1高脉冲和T2低脉冲它的时间T1, T2可调整，可以输出不同频率不同占控比的波形，在控制电机时特别有用</p>
<p>我们这个程序只做一个实验：当TCNTn这个计数器到0的时候，就产生中断，在这个中断服务程序里我们点灯</p>
<p>写代码 打开我们的main函数</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">int <span class="hljs-selector-tag">main</span>(void)<br>&#123;<br>    <span class="hljs-built_in">led_init</span>();<br>    <span class="hljs-built_in">interrupt_init</span>();  <span class="hljs-comment">/* 初始化中断控制器 */</span><br>    <span class="hljs-built_in">key_eint_init</span>();   <span class="hljs-comment">/* 初始化按键, 设为中断源 */</span><br><span class="hljs-comment">//我们初始化了中断源，同样的，我们初始化timer</span><br><span class="hljs-comment">//初始化定时器</span><br>    <span class="hljs-built_in">timer_init</span>();<br></code></pre></td></tr></table></figure>

<p>我们需要实现定时器初始化函数</p>
<p>新建一个 timer.c，我们需要操作一堆寄存器，添加头文件 #include “s3c2440_soc.h”</p>
<p>写出void timer_init(void)</p>
<ol>
<li>设置TIMER0的时钟  &#x2F;* 选择使用TIMER0 *&#x2F;</li>
<li>设置TIMER0的初值</li>
<li>加载初值, 启动timer0</li>
<li>设置为自动加载并启动(值到0以后会自动加载)</li>
<li>设置中断(显然我们也需要提供一个中断处理函数void timer_irq(void)在这里面我们来点灯)</li>
</ol>
<p>打开芯片手册，我们想设置timer0的话</p>
<ol>
<li>首先设置8-Bit Prescaler(预分频器)</li>
<li>设置5.1 MUX(五选一，选择一个时钟分频)</li>
<li>设置TCMPB０和TCNTB0</li>
<li>设置TCONn寄存器用于控制</li>
</ol>
<p>Figure 10-1：</p>
<p><img src="/image/7ef44f90567be421d19d9aedcccbe60d.png" srcset="/img/loading.gif" lazyload alt="7ef44f90567be421d19d9aedcccbe60d.png"></p>
<p>看手册上写如何初始化timer</p>
<p><img src="/image/f59da1b8a7583eb7787ba29dcd835abc.png" srcset="/img/loading.gif" lazyload alt="f59da1b8a7583eb7787ba29dcd835abc.png"></p>
<ol>
<li>把初始值写到TCNTBn 和TCMPBn寄存器</li>
<li>设置手动更新位</li>
<li>设置启动位</li>
</ol>
<p>往下看到时钟配置寄存器</p>
<p><img src="/image/9597068d41a2ef047075a6c32ee915cf.png" srcset="/img/loading.gif" lazyload alt="9597068d41a2ef047075a6c32ee915cf.png"></p>
<p>有个计算公式</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* Timer clk = PCLK /</span> &#123;(预分频数)prescaler value+<span class="hljs-number">1</span>&#125; / &#123;divider value(<span class="hljs-number">5.1</span>MUX值)&#125;            <br></code></pre></td></tr></table></figure>

<p>PCLK是50M</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">= 50000000/(99+1)/16</span><br><span class="hljs-section">= 31250</span><br> */<br></code></pre></td></tr></table></figure>

<p>也就是说我们得TCON是31250的话，从这个值一直减到0，才过去1秒</p>
<p>Prescaler0等于99</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">TCFG0</span> = <span class="hljs-number">99</span>;  /* Prescaler <span class="hljs-number">0</span> = <span class="hljs-number">99</span>, 用于timer0,<span class="hljs-number">1</span> */<br></code></pre></td></tr></table></figure>

<p>TCFG1 MUX多路复用器的意思，他有多路输入，我们可以通过MUX选择其中一路作为输出</p>
<p><img src="/image/40482a9f658b104b65e6d1f342e0f012.png" srcset="/img/loading.gif" lazyload alt="40482a9f658b104b65e6d1f342e0f012.png"></p>
<p>根据上面mux的值，我们要把MUX0 设置成0011 只需要设置这4位即可，先清零 再或上 0011 就是3</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">TCFG1</span> &amp;= ~<span class="hljs-number">0</span>xf;<br><span class="hljs-attribute">TCFG1</span> |= <span class="hljs-number">3</span>;  /* MUX0 : <span class="hljs-number">1</span>/<span class="hljs-number">16</span> */<br></code></pre></td></tr></table></figure>

<p>再来看看初始值控制寄存器(我们没有用到TCMPB0，所以不设置)</p>
<p><img src="/image/800px-Chapter14_lesson8_007.png" srcset="/img/loading.gif" lazyload alt="800px-Chapter14_lesson8_007.png"></p>
<p>一秒钟点灯太慢了 ，就让0.5秒</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">TCNTB0</span> <span class="hljs-operator">=</span> <span class="hljs-number">15625</span><span class="hljs-comment">;  /* 0.5s中断一次 */</span><br></code></pre></td></tr></table></figure>

<p>TCNTO0这个寄存器是用来观察里面的计数值的，不需要设置</p>
<p>现在可以设置TCON来设置这个寄存器了</p>
<p><img src="/image/68bd44a3aba8b01b941c4dbfbcceff31.png" srcset="/img/loading.gif" lazyload alt="68bd44a3aba8b01b941c4dbfbcceff31.png"></p>
<p>现在需要设置Timer0</p>
<p><img src="/image/3520a06f8a00a3c2ddf62632127c2727.png" srcset="/img/loading.gif" lazyload alt="3520a06f8a00a3c2ddf62632127c2727.png"></p>
<p>开始需要手工更新</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">TCON</span> |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);   /* Update from TCNTB0 &amp; TCMPB0 */<br></code></pre></td></tr></table></figure>

<p>把这两个值放到TCNTB0 和 TCMPB0中</p>
<p><strong>注意：这一位必须清除才能写下一位</strong></p>
<p>设置为自动加载并启动，先清掉手动更新位，再或上bit0 bit3</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">TCON</span> &amp;= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);<br><span class="hljs-attribute">TCON</span> |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>);  /* bit0: start, bit3: auto reload */<br></code></pre></td></tr></table></figure>

<p>设置中断，显然我们需要提供一个中断处理函数void timer_irq(void) 在Timer里没有看到中断相关的控制器，我们需要回到中断章节去看看中断控制器，看看有没有定时器相关的中断 我们没有看到更加细致的Timer0寄存器</p>
<p><img src="/image/3c7d29e2ea9cc627c32d02b8c60841e6.png" srcset="/img/loading.gif" lazyload alt="3c7d29e2ea9cc627c32d02b8c60841e6.png"></p>
<p>当TCNTn&#x3D;TCMPn时，他不会产生中断，只有当TCNTn等于0的时候才可以产生中断，我们之前以为这个定时器可以产生两种中断，那么肯定有寄存器中断或者禁止两种寄存器其中之一，那现在只有一种中断的话，就相对简单些 设置中断的话，我们只需要设置中断控制器</p>
<p>设置interrupu.c中断控制器</p>
<ul>
<li><p>初始化中断控制器 void interrupt_init(void)，把对应位清零就行</p>
</li>
<li><p>把定时器相应的位清零就可以了，哪一位呢？</p>
</li>
</ul>
<p>INTPND的哪一位？ INT_TIMER0第10位即可</p>
<p><img src="/image/c93eb2d99b7bcbfb22f587851ff7decc.png" srcset="/img/loading.gif" lazyload alt="c93eb2d99b7bcbfb22f587851ff7decc.png"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* void interrupt_init(void) */</span><br>INTMSK &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">10</span>);  <span class="hljs-regexp">/* enable timer0 int */</span><br></code></pre></td></tr></table></figure>

<p>当定时器减到0的时候就会产生中断，就会进到start.s这里一路执行do_irq</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs arduino">do_irq:<br>    <span class="hljs-comment">/* 执行到这里之前:  </span><br><span class="hljs-comment">     * 1. lr_irq保存有被中断模式中的下一条即将执行的指令的地址  </span><br><span class="hljs-comment">     * 2. SPSR_irq保存有被中断模式的CPSR  </span><br><span class="hljs-comment">     * 3. CPSR中的M4-M0被设置为10010, 进入到irq模式  </span><br><span class="hljs-comment">     * 4. 跳到0x18的地方执行程序   </span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/* sp_irq未设置, 先设置它 */</span><br><br>    <span class="hljs-comment">/* 保存现场 */</span><br>    <span class="hljs-comment">/* 在irq异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>    <span class="hljs-comment">/* lr-4是异常处理完后的返回地址, 也要保存 */</span><br><br>    <span class="hljs-comment">/* 处理irq异常 */</span><br>    bl handle_irq_c<br>        <br>    <span class="hljs-comment">/* 恢复现场 */</span><br>    ldmia sp!, &#123;r0-r12, pc&#125;^  <span class="hljs-comment">/* ^会把spsr_irq的值恢复到cpsr里 */</span><br><br>然后进入irq处理函数中处理，处理这个<span class="hljs-function">irq</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_irq_c</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* 分辨中断源 */</span><br>    <span class="hljs-type">int</span> bit = INTOFFSET;<br><br>    <span class="hljs-comment">/* 调用对应的处理函数 */</span><br><br>    <span class="hljs-keyword">if</span>(bit ==<span class="hljs-number">0</span> || bit == <span class="hljs-number">2</span> || bit == <span class="hljs-number">5</span>)<span class="hljs-comment">/*eint0,2,rint8_23*/</span><br>    &#123;<br>        <span class="hljs-built_in">key_eint_irq</span>(bit);<span class="hljs-comment">/*处理中断，清中断源EINTPEND*/</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(bit == <span class="hljs-number">10</span>)<br><span class="hljs-comment">//如果等于10的话说明发生的是定时器中断，这时候就调用我们得timer_irq</span><br><span class="hljs-comment">//INTOFFSET中查找对应值</span><br>    &#123;<br>        <span class="hljs-built_in">timer_irq</span>();&#125;<br><br>        <span class="hljs-comment">/* 清中断 : 从源头开始清 */</span><br>        SRCPND = (<span class="hljs-number">1</span>&lt;&lt;bit);<br>        INTPND = (<span class="hljs-number">1</span>&lt;&lt;bit);     <br>    &#125;<br><br>回到timer.c文件中，在这个定时器处理函数中我们需要点灯<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">timer_irq</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* 点灯计数 循环点灯*/</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> tmp;<br><br>    cnt++;<br><br>    tmp = ~cnt;<br>    tmp &amp;= <span class="hljs-number">7</span>;<br>    GPFDAT &amp;= ~(<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">4</span>);<br>    GPFDAT |= (tmp&lt;&lt;<span class="hljs-number">4</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码写完我们实验一下，上传代码，在Makefile中添加timer.o，进行编译 编译后进行烧写 现象灯没有闪烁</p>
<p><strong>TCON有一个观察寄存器</strong></p>
<p>我们不断的打印这个值，看是否有变化</p>
<p><img src="/image/a48d57153707e8b932dc0ed286a12383.png" srcset="/img/loading.gif" lazyload alt="a48d57153707e8b932dc0ed286a12383.png"></p>
<p>在main函数中不断打印</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">putchar</span>(g_Char3);<br>g_Char3++;<br><span class="hljs-built_in">delay</span>(<span class="hljs-number">1000000</span>);<br><span class="hljs-built_in">printHex</span>(TCNTO0);<br></code></pre></td></tr></table></figure>

<p>编译实验</p>
<p>打印结果全都是0，发现我们的定时器根本就没有启用，在timer.c文件void timer_init(void)函数里设置为自动加载并启动，先清掉手动更新位，再或上bit0 bit3</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">TCON</span> &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);//我们没有设置取反<br><span class="hljs-attribute">TCON</span> |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>);  /* bit0: start, bit3: auto reload */<br></code></pre></td></tr></table></figure>

<p>再次实验</p>
<p>发现灯已经开始闪，就可以把调试信息去除了 对程序进行改进</p>
<p>在我们添加了定时器中断后，进入main函数中执行 timer_init();</p>
<p>需要修改interrupt.c 初始化函数 void interrupt_init(void) 还需要修改调用中断处理函数 void handle_irq_c(void) </p>
<p>每次添加一个中断我都需要修改handle_irq这个函数，这样太麻烦，我能不能保证这个interrupt.c文件不变，只需要在timer.c中引用即可，这里我们使用指针数组</p>
<p>在interrupt.c中定义函数指针数组</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs delphi">typedef void<span class="hljs-comment">(*irq_func)(int);   </span><br><span class="hljs-comment">    //使用irq_func代替void(*irq_func)(int irq)这句代码</span><br><span class="hljs-comment">    //irq_func的类型是void (*)</span>(int)    <br>    <span class="hljs-comment">//void(*irq_func)(int)    irq_func是一个函数指针，它的返回类型为空，它所指向的函数接收一个int型的参数</span><br></code></pre></td></tr></table></figure>

<p>定义一个数组，我们来看下这里有多少项，一共32位，我们想把每一个中断的处理函数都放在这个数组里面来，当发生中断时，我们可以得到这个中断号，然后我从数组里面调用对应的中断号就可以了</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">irq_func irq_array[<span class="hljs-number">32</span>];        <br>    <span class="hljs-regexp">//</span>定义<span class="hljs-number">32</span>个指针函数：<span class="hljs-keyword">void</span> (*irq_array[<span class="hljs-number">0</span>])(<span class="hljs-keyword">void</span>); <span class="hljs-keyword">void</span> (*irq_array[<span class="hljs-number">1</span>])(<span class="hljs-keyword">void</span>);<br></code></pre></td></tr></table></figure>

<p>那么我们得提供一个注册函数</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">void register_ir<span class="hljs-string">q (int irq, irq_func fp)</span><br>&#123;<br>    irq_array[irq] = fp;        <span class="hljs-regexp">//</span>把中断处理函数key_enit_irq和timer_inq放在数组里<br>    INTMASK &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; irq)；    //同时使能中断<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以后我直接调用对应的处理函数</p>
<ol>
<li>在中断处理函数中根据中断号调用处理函数</li>
<li>在按键初始化函数，定时器初始化函数中通过register_irq注册中断</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs awk">void handle_irq_c(void)<br>&#123;<br>    <span class="hljs-regexp">/* 分辨中断源 */</span><br>    int bit = INTOFFSET;<br><br>    <span class="hljs-regexp">/* 调用对应的处理函数 */</span><br>    <span class="hljs-regexp">/* 根据得到的中断号，从这个数组里调用对应的函数 */</span><br>    irq_array[bit](bit);<br>        <br>    <span class="hljs-regexp">/* 清中断 : 从源头开始清 */</span><br>    SRCPND = (<span class="hljs-number">1</span>&lt;&lt;bit);<br>    INTPND = (<span class="hljs-number">1</span>&lt;&lt;bit);     <br>&#125;<br><br><span class="hljs-regexp">//</span>按键中断初始化函数需要注册<br><br>    <span class="hljs-regexp">/* 初始化按键, 设为中断源 */</span><br>    void key_eint_init(void)<br>    &#123;<br>        <span class="hljs-regexp">/* 配置GPIO为中断引脚 */</span><br>        GPFCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">4</span>));<br>        GPFCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">4</span>));   <span class="hljs-regexp">/* S2,S3被配置为中断引脚 */</span><br><br>        GPGCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">22</span>));<br>        GPGCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">22</span>));   <span class="hljs-regexp">/* S4,S5被配置为中断引脚 */</span><br>        <br>        <span class="hljs-regexp">/* 设置中断触发方式: 双边沿触发 */</span><br>        EXTINT0 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">8</span>);     <span class="hljs-regexp">/* S2,S3 */</span><br>        EXTINT1 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">12</span>);             <span class="hljs-regexp">/* S4 */</span><br>        EXTINT2 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">12</span>);             <span class="hljs-regexp">/* S5 */</span><br><br>        <span class="hljs-regexp">/* 设置EINTMASK使能eint11,19 */</span><br>        EINTMASK &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">19</span>));<br><br>        /* 注册中断 <br>         * 将该中断源对应的中断处理函数放入处理函数的数组，之后可以通过INTOFFSET的值来访问对应的处理函数<br>         * 同时使能该中断<br>         */<br>        register_irq(<span class="hljs-number">0</span>, key_eint_irq);    <span class="hljs-regexp">/* enit0 */</span><br>        register_irq(<span class="hljs-number">2</span>, key_eint_irq);    <span class="hljs-regexp">/* enit2 */</span><br>        register_irq(<span class="hljs-number">5</span>, key_eint_irq);    <span class="hljs-regexp">/* enit5 */</span><br>        &#125;<br></code></pre></td></tr></table></figure>

<p>在timer.c中也需要设置中断</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">    void timer_init(void)<br>    &#123;<br>        <span class="hljs-regexp">/* 设置TIMER0的时钟 */</span><br>        <span class="hljs-regexp">/* Timer clk = PCLK /</span> &#123;prescaler value+<span class="hljs-number">1</span>&#125; / &#123;divider value&#125;<br>                     = <span class="hljs-number">50000000</span><span class="hljs-regexp">/(99+1)/</span><span class="hljs-number">16</span>              <br>                     = <span class="hljs-number">31250</span>  <br>         */<br>        TCFG0 = <span class="hljs-number">99</span>;  <span class="hljs-regexp">/* Prescaler 0 = 99, 用于timer0,1 */</span><br>        TCFG1 &amp;= ~<span class="hljs-number">0</span>xf;<br>        TCFG1 |= <span class="hljs-number">3</span>;  <span class="hljs-regexp">/* MUX0 : 1/</span><span class="hljs-number">16</span> */<br><br>        <span class="hljs-regexp">/* 设置TIMER0的初值 */</span><br>        TCNTB0 = <span class="hljs-number">15625</span>;  <span class="hljs-regexp">/* 0.5s中断一次 */</span><br><br>        <span class="hljs-regexp">/* 加载初值, 启动timer0 */</span><br>        TCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);   <span class="hljs-regexp">/* Update from TCNTB0 &amp; TCMPB0 */</span><br><br>        <span class="hljs-regexp">/* 设置为自动加载并启动 */</span><br>         TCON &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);<br>         TCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>);  <span class="hljs-regexp">/* bit0: start, bit3: auto reload */</span><br><br>       <span class="hljs-regexp">/* 注册中断 */</span><br>        register_irq(<span class="hljs-number">10</span>, timer_irq);<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>把interrupt.c中按键的初始化放在最后面</p>
<p>我们来看看我们做了什么事情，</p>
<p>我们定义了一个指针数组</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">typedef</span> <span class="hljs-built_in">void</span>(*irq_func)(<span class="hljs-built_in">int</span>);<br></code></pre></td></tr></table></figure>

<p>这个指针数组里面放有各个指针的处理函数</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">irq_func irq_array[<span class="hljs-number">32</span>]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>当我们去初始化按键中断时，我们在初始化函数中给这按键注册中断函数</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">register_ir<span class="hljs-string">q(0, key_eint_irq)</span>;<br>register_ir<span class="hljs-string">q(2, key_eint_irq)</span>;<br>register_ir<span class="hljs-string">q(5, key_eint_irq)</span>;<br></code></pre></td></tr></table></figure>

<p>这个注册函数会把这个数组放在注册函数里面，同时使能中断</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs perl">void register_ir<span class="hljs-string">q(int irq, irq_func fp)</span><br>&#123;<br>    irq_array[irq] = fp;<br><br>    INTMSK &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;irq);<br>&#125;<br>//我们的timer.c中<br>timer_init();<br><span class="hljs-regexp">//</span>也会注册这个函数<br>    /* 设置中断 */<br>    register_ir<span class="hljs-string">q(10, timer_irq)</span>;<br></code></pre></td></tr></table></figure>

<p>把这个中断irq放在第10项里同时使能中断，以后我们只需要添加中断自己的初始化函数，和自己的中断函数，然后去注册中断，再也不需要修改interrupt.c里的内容函数 烧写执行*</p>
<p>查看定时器中断处理流程我们从start.s开始看， 一上电从 b reset运行做一列初始化</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">.text</span><br><span class="hljs-symbol">.global</span> _start<br><br><span class="hljs-symbol">_start:</span><br>    <span class="hljs-keyword">b</span> reset          <span class="hljs-comment">/* vector 0 : reset */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, und_addr <span class="hljs-comment">/* vector 4 : und */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, swi_addr <span class="hljs-comment">/* vector 8 : swi */</span><br>    <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x0c : prefetch aboot */</span><br>    <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x10 : data abort */</span><br>    <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x14 : reserved */</span><br> <br>       <br><span class="hljs-symbol">reset:</span><br>    <span class="hljs-comment">/* 关闭看门狗 */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x53000000</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">=0</span><br>    <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>    <span class="hljs-comment">/* 设置MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */</span><br>    <span class="hljs-comment">/* LOCKTIME(0x4C000000) = 0xFFFFFFFF */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x4C000000</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">=0xFFFFFFFF</span><br>    <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>    <span class="hljs-comment">/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x4C000014</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">=0x5</span><br>    <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>    <span class="hljs-comment">/* 设置CPU工作于异步模式 */</span><br>    <span class="hljs-keyword">mrc</span> <span class="hljs-built_in">p15</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">r0</span>,<span class="hljs-built_in">c1</span>,<span class="hljs-built_in">c0</span>,<span class="hljs-number">0</span><br>    <span class="hljs-keyword">orr</span> <span class="hljs-built_in">r0</span>,<span class="hljs-built_in">r0</span>,<span class="hljs-number">#0xc0000000</span>   <span class="hljs-comment">//R1_nF:OR:R1_iA</span><br>    mcr <span class="hljs-built_in">p15</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">r0</span>,<span class="hljs-built_in">c1</span>,<span class="hljs-built_in">c0</span>,<span class="hljs-number">0</span><br><br>    <span class="hljs-comment">/* 设置MPLLCON(0x4C000004) = (92&lt;&lt;12)|(1&lt;&lt;4)|(1&lt;&lt;0)   </span><br><span class="hljs-comment">     *  m = MDIV+8 = 92+8=100  </span><br><span class="hljs-comment">     *  p = PDIV+2 = 1+2 = 3  </span><br><span class="hljs-comment">     *  s = SDIV = 1  </span><br><span class="hljs-comment">     *  FCLK = 2*m*Fin/(p*2^s) = 2*100*12/(3*2^1)=400M  </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x4C000004</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, =(<span class="hljs-number">92</span>&lt;&lt;<span class="hljs-number">12</span>)<span class="hljs-title">|(1&lt;&lt;4)|</span>(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>    <span class="hljs-comment">/* 一旦设置PLL, 就会锁定lock time直到PLL输出稳定  </span><br><span class="hljs-comment">     * 然后CPU工作于新的频率FCLK  </span><br><span class="hljs-comment">     */</span><br>        <br><br>    <span class="hljs-comment">/* 设置内存: sp 栈 */</span><br>    <span class="hljs-comment">/* 分辨是nor/nand启动  </span><br><span class="hljs-comment">     * 写0到0地址, 再读出来  </span><br><span class="hljs-comment">     * 如果得到0, 表示0地址上的内容被修改了, 它对应ram, 这就是nand启动  </span><br><span class="hljs-comment">     * 否则就是nor启动  </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>] <span class="hljs-comment">/* 读出原来的值备份 */</span><br>    <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r1</span>] <span class="hljs-comment">/* 0-&gt;[0] */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r2</span>, [<span class="hljs-built_in">r1</span>] <span class="hljs-comment">/* r2=[0] */</span><br>    <span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">r2</span>   <span class="hljs-comment">/* r1==r2? 如果相等表示是NAND启动 */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x40000000</span>+<span class="hljs-number">4096</span> <span class="hljs-comment">/* 先假设是nor启动 */</span><br>    <span class="hljs-keyword">moveq</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">#4096</span>  <span class="hljs-comment">/* nand启动 */</span><br>    <span class="hljs-keyword">streq</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>]   <span class="hljs-comment">/* 恢复原来的值 */</span><br><br>    <span class="hljs-keyword">bl</span> sdram_init<br>    <span class="hljs-comment">//bl sdram_init2  /* 用到有初始值的数组, 不是位置无关码 */</span><br><br>    <span class="hljs-comment">/* 重定位text, rodata, data段整个程序 */</span><br>    <span class="hljs-keyword">bl</span> copy2sdram<br><br>    <span class="hljs-comment">/* 清除BSS段 */</span><br>    <span class="hljs-keyword">bl</span> clean_bss<br><br>    <span class="hljs-comment">/* 复位之后, cpu处于svc模式  * 现在, 切换到usr模式  */</span><br>    <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>         <span class="hljs-comment">/* 读出cpsr */</span><br>    <span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0xf</span>     <span class="hljs-comment">/* 修改M4-M0为0b10000, 进入usr模式 */</span><br>    <span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, #(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>)  <span class="hljs-comment">/* 清除I位, 使能中断 */</span><br>    <span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span><br><br>    <span class="hljs-comment">/* 设置 sp_usr */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33f00000</span><br><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=sdramsdram</span>:<br>    <span class="hljs-keyword">bl</span> uart0_init<br><br>    <span class="hljs-keyword">bl</span> print1<br>    <span class="hljs-comment">/* 故意加入一条未定义指令 */</span>und_code:<br>    <span class="hljs-meta">.word</span> <span class="hljs-number">0xdeadc0de</span>  <span class="hljs-comment">/* 未定义指令 */</span><br>    <span class="hljs-keyword">bl</span> print2<br><br>    <span class="hljs-keyword">swi</span> <span class="hljs-number">0x123</span>  <span class="hljs-comment">/* 执行此命令, 触发SWI异常, 进入0x8执行 */</span><br><br><span class="hljs-comment">/***最后执行main函数***/</span><br>    <span class="hljs-comment">//bl main  /* 使用BL命令相对跳转, 程序仍然在NOR/sram执行 */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=main</span>  <span class="hljs-comment">/* 绝对跳转, 跳到SDRAM */</span><br><br><span class="hljs-symbol">halt:</span><br>    <span class="hljs-keyword">b</span> halt<br></code></pre></td></tr></table></figure>

<p>进入main.c做一系列初始化</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss">int <span class="hljs-selector-tag">main</span>(void)<br>&#123;<br>    <span class="hljs-built_in">led_init</span>();<br>    <span class="hljs-comment">//interrupt_init();  /* 初始化中断控制器 */</span><br>    <span class="hljs-built_in">key_eint_init</span>();   <span class="hljs-comment">/* 初始化按键, 设为中断源 */</span><br>    <span class="hljs-built_in">timer_init</span>();<br>        <br>    <span class="hljs-built_in">puts</span>(&quot;\n\rg_A = &quot;);<br>    <span class="hljs-built_in">printHex</span>(g_A);<br>    <span class="hljs-built_in">puts</span>(&quot;\n\r&quot;);<br></code></pre></td></tr></table></figure>

<p>进入按键初始化程序 interrupt.c 初始化按键, 设为中断源</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs awk">int main(void)<br>&#123;<br>    led_init();<br>    <span class="hljs-regexp">//i</span>nterrupt_init();  <span class="hljs-regexp">/* 初始化中断控制器 */</span><br>    key_eint_init();   <span class="hljs-regexp">/* 初始化按键, 设为中断源 */</span><br>    timer_init();<br>        <br>    puts(<span class="hljs-string">&quot;\n\rg_A = &quot;</span>);<br>    printHex(g_A);<br>    puts(<span class="hljs-string">&quot;\n\r&quot;</span>);<br>进入按键初始化程序 interrupt.c 初始化按键, 设为中断源<br>void key_eint_init(void)&#123;<br>     <span class="hljs-regexp">/* 配置GPIO为中断引脚 */</span><br>    GPFCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">4</span>));<br>    GPFCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">4</span>));   <span class="hljs-regexp">/* S2,S3被配置为中断引脚 */</span><br>    GPGCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">22</span>));<br>    GPGCON |= ((<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">2</span>&lt;&lt;<span class="hljs-number">22</span>));   <span class="hljs-regexp">/* S4,S5被配置为中断引脚 */</span><br>        <br>    <span class="hljs-regexp">/* 设置中断触发方式: 双边沿触发 */</span><br>    EXTINT0 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">8</span>);     <span class="hljs-regexp">/* S2,S3 */</span><br>    EXTINT1 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">12</span>);             <span class="hljs-regexp">/* S4 */</span><br>    EXTINT2 |= (<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">12</span>);             <span class="hljs-regexp">/* S5 */</span><br>    <span class="hljs-regexp">/* 设置EINTMASK使能eint11,19 */</span><br>    EINTMASK &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">11</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">19</span>));<br><span class="hljs-regexp">/*注册中断控制器*/</span><br>    register_irq(<span class="hljs-number">0</span>, key_eint_irq);<br>    register_irq(<span class="hljs-number">2</span>, key_eint_irq);<br>    register_irq(<span class="hljs-number">5</span>, key_eint_irq);<br>&#125;<br><br>时钟初始化程序 &lt;code&gt;timer_init();&lt;/code&gt;<br><br>void timer_init(void)<br>&#123;<br>    <span class="hljs-regexp">/* 设置TIMER0的时钟 */</span><br>    <span class="hljs-regexp">/* Timer clk = PCLK /</span> &#123;prescaler value+<span class="hljs-number">1</span>&#125; / &#123;divider value&#125;               <br>                 = <span class="hljs-number">50000000</span><span class="hljs-regexp">/(99+1)/</span><span class="hljs-number">16</span>              <br>                 = <span class="hljs-number">31250</span>  <br>     */<br>    TCFG0 = <span class="hljs-number">99</span>;  <span class="hljs-regexp">/* Prescaler 0 = 99, 用于timer0,1 */</span><br>    TCFG1 &amp;= ~<span class="hljs-number">0</span>xf;<br>    TCFG1 |= <span class="hljs-number">3</span>;  <span class="hljs-regexp">/* MUX0 : 1/</span><span class="hljs-number">16</span> */<br>    <span class="hljs-regexp">/* 设置TIMER0的初值 */</span><br>    TCNTB0 = <span class="hljs-number">15625</span>;  <span class="hljs-regexp">/* 0.5s中断一次 */</span><br>    <span class="hljs-regexp">/* 加载初值, 启动timer0 */</span><br>    TCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);   <span class="hljs-regexp">/* Update from TCNTB0 &amp; TCMPB0 */</span><br>    <span class="hljs-regexp">/* 设置为自动加载并启动 */</span><br>    TCON &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);<br>    TCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>);  <span class="hljs-regexp">/* bit0: start, bit3: auto reload */</span><br>    <span class="hljs-regexp">/* 设置中断 */</span><br>    register_irq(<span class="hljs-number">10</span>, timer_irq);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>让后main.c函数一直循环执行 输出串口信息</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">while (<span class="hljs-number">1</span>)<br>&#123;<br>    <span class="hljs-built_in">putchar</span>(g_Char);<br>    g_Char++;<br>    <span class="hljs-built_in">putchar</span>(g_Char3);<br>    g_Char3++;<br>    <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000000</span>);<br>    <span class="hljs-comment">//printHex(TCNTO0);</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>定时器减到0的时候就会产生中断，start.S 跳到 0x18的地方执行</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs armasm">    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, irq_addr <span class="hljs-comment">/* vector 0x18 : irq */</span><br>    <span class="hljs-keyword">b</span> halt           <span class="hljs-comment">/* vector 0x1c : fiq */</span><br><span class="hljs-symbol">.align</span> <span class="hljs-number">4</span><br><br><span class="hljs-symbol">do_irq:</span><br>    <span class="hljs-comment">/* 执行到这里之前:  </span><br><span class="hljs-comment">     * 1. lr_irq保存有被中断模式中的下一条即将执行的指令的地址  </span><br><span class="hljs-comment">     * 2. SPSR_irq保存有被中断模式的CPSR  </span><br><span class="hljs-comment">     * 3. CPSR中的M4-M0被设置为10010, 进入到irq模式  </span><br><span class="hljs-comment">     * 4. 跳到0x18的地方执行程序   </span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/* sp_irq未设置, 先设置它 */</span><br>    <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33d00000</span><br><br>    <span class="hljs-comment">/* 保存现场 */</span><br>    <span class="hljs-comment">/* 在irq异常处理函数中有可能会修改r0-r12, 所以先保存 */</span><br>    <span class="hljs-comment">/* lr-4是异常处理完后的返回地址, 也要保存 */</span><br>    <span class="hljs-keyword">sub</span> <span class="hljs-built_in">lr</span>, <span class="hljs-built_in">lr</span>, <span class="hljs-number">#4</span><br>    <span class="hljs-keyword">stmdb</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">lr</span>&#125;  <br>        <br>    <span class="hljs-comment">/* 处理irq异常 */</span><br>    <span class="hljs-keyword">bl</span> handle_irq_c<br>        <br>    <span class="hljs-comment">/* 恢复现场 */</span><br>    <span class="hljs-keyword">ldmia</span> <span class="hljs-built_in">sp</span>!, &#123;<span class="hljs-built_in">r0</span>-<span class="hljs-built_in">r12</span>, <span class="hljs-built_in">pc</span>&#125;^  <span class="hljs-comment">/* ^会把spsr_irq的值恢复到cpsr里 */</span><br></code></pre></td></tr></table></figure>

<p>看看怎么处理irq</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_irq_c</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* 分辨中断源 */</span><br>    <span class="hljs-type">int</span> bit = INTOFFSET;<br><br>    <span class="hljs-comment">/* 调用对应的处理函数执行 */</span><br>    irq_array[bit](bit);<br>        <br>    <span class="hljs-comment">/* 清中断 : 从源头开始清 */</span><br>    SRCPND = (<span class="hljs-number">1</span>&lt;&lt;bit);<br>    INTPND = (<span class="hljs-number">1</span>&lt;&lt;bit);     <br>&#125;<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" class="category-chain-item">嵌入式</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%9C%AA%E9%87%8D%E6%9E%84/">#未重构</a>
      
        <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">#嵌入式</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CPU的工作模式_状态和寄存器</div>
      <div>https://godxqi.github.io/2023/01/15/韦东山一期/CPU的工作模式_状态和寄存器/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>GODXQI</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>January 15, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/15/%E9%9F%A6%E4%B8%9C%E5%B1%B1%E4%B8%80%E6%9C%9F/(%E5%BE%85%E4%BF%AE%E6%94%B9)%E7%A1%AC%E4%BB%B6%E7%9F%A5%E8%AF%86_%E5%86%85%E5%AD%98%E6%8E%A5%E5%8F%A3%E6%A6%82%E5%BF%B5-%E4%B8%8D%E5%90%8C%E4%BD%8D%E5%AE%BD%E8%AE%BE%E5%A4%87%E7%9A%84%E8%BF%9E%E6%8E%A5_%E6%97%B6%E5%BA%8F%E5%9B%BE%E5%B7%A5%E4%BD%9C%E5%AE%9E%E4%BE%8B/" title="(待修改)硬件知识_内存接口概念__不同位宽设备的连接_时序图工作实例">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">(待修改)硬件知识_内存接口概念__不同位宽设备的连接_时序图工作实例</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/15/%E9%9F%A6%E4%B8%9C%E5%B1%B1%E4%B8%80%E6%9C%9F/(%E5%BE%85%E4%BF%AE%E6%94%B9)%E7%AC%AC011%E8%AF%BE_%E4%B8%B2%E5%8F%A3UART/" title="(待修改)第011课 串口UART">
                        <span class="hidden-mobile">(待修改)第011课 串口UART</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
