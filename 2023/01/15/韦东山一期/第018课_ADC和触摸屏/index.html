

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="GODXQI">
  <meta name="keywords" content="">
  
    <meta name="description" content="目录   第001节_ADC硬件原理 第002节_ADC编程 第003节_电阻触摸屏硬件原 第004节_S3C2440触摸屏接口 第005节_触摸屏编程_按下松开检测 第006节_触摸屏编程_ADC中断 第007节_触摸屏编程_定时器程序优化 第008节_触摸屏编程_使用定时器支持长按 第009节_触摸屏编程_较准原理 第010节_触摸屏编程_较准与画线编 第011节_触摸屏编程_测试 第012节">
<meta property="og:type" content="article">
<meta property="og:title" content="第018课 ADC和触摸屏">
<meta property="og:url" content="https://godxqi.github.io/2023/01/15/%E9%9F%A6%E4%B8%9C%E5%B1%B1%E4%B8%80%E6%9C%9F/%E7%AC%AC018%E8%AF%BE_ADC%E5%92%8C%E8%A7%A6%E6%91%B8%E5%B1%8F/index.html">
<meta property="og:site_name" content="GODXQI&#39;s Blog">
<meta property="og:description" content="目录   第001节_ADC硬件原理 第002节_ADC编程 第003节_电阻触摸屏硬件原 第004节_S3C2440触摸屏接口 第005节_触摸屏编程_按下松开检测 第006节_触摸屏编程_ADC中断 第007节_触摸屏编程_定时器程序优化 第008节_触摸屏编程_使用定时器支持长按 第009节_触摸屏编程_较准原理 第010节_触摸屏编程_较准与画线编 第011节_触摸屏编程_测试 第012节">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson1_001.jpg">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson1_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson1_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson1_004.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson1_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson2_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_004.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_006.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson3_007.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson4_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson4_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson4_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_004.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_006.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_007.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_008.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_009.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson4_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0010.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0011.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0012.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson4_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0013.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0013-1.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0014.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0015.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0016.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0017.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0018.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0019.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0020.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0023.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0024.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0025.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0026.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson5_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0015.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0016.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson4_0024.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson5_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson6_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson6_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson6_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson6_004.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson6_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson6_006.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson6_007.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson6_008.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson6_009.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson9_001.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson9_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson9_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson9_004.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson9_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson9_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson10_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/Chapter18_lesson10_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_001.jpg">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_002.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_003.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_004.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_005.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_006.png">
<meta property="og:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson12_007.png">
<meta property="article:published_time" content="2023-01-15T12:59:58.016Z">
<meta property="article:modified_time" content="2023-01-15T13:01:41.399Z">
<meta property="article:author" content="GODXQI">
<meta property="article:tag" content="未重构">
<meta property="article:tag" content="嵌入式">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://godxqi.github.io/image/700px-Chapter18_lesson1_001.jpg">
  
  
  
  <title>第018课 ADC和触摸屏 - GODXQI&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"godxqi.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>GODXQI</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="第018课 ADC和触摸屏"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-01-15 20:59" pubdate>
          January 15, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          51k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          426 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第018课 ADC和触摸屏</h1>
            
            
              <div class="markdown-body">
                
                <p><strong>目录</strong></p>
<hr>
<ol>
<li>第001节_ADC硬件原理</li>
<li>第002节_ADC编程</li>
<li>第003节_电阻触摸屏硬件原</li>
<li>第004节_S3C2440触摸屏接口</li>
<li>第005节_触摸屏编程_按下松开检测</li>
<li>第006节_触摸屏编程_ADC中断</li>
<li>第007节_触摸屏编程_定时器程序优化</li>
<li>第008节_触摸屏编程_使用定时器支持长按</li>
<li>第009节_触摸屏编程_较准原理</li>
<li>第010节_触摸屏编程_较准与画线编</li>
<li>第011节_触摸屏编程_测试</li>
<li>第012节_触摸屏编程_完善</li>
</ol>
<p><strong>第001节_ADC硬件原理</strong></p>
<hr>
<p>模数转换器即A&#x2F;D转换器，或简称ADC，通常是指一个将模拟信号转变为数字信号的电子元件。</p>
<p>通常的模数转换器是把经过与标准量比较处理后的模拟量转换成以二进制数值表示的离散信号的转换器。</p>
<p>故任何一个模数转换器都需要一个参考模拟量作为转换的标准，比较常见的参考标准为最大的可转换信号大小。而输出的数字量则表示输入信号相对于参考信号的大小。</p>
<p>如图，是把可变电阻上的电压值变换的模拟信号通过ADC转换，输出数字信号。</p>
<p><img src="/image/700px-Chapter18_lesson1_001.jpg" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson1_001.jpg"></p>
<p>对于数字信号我们需要得到它的几个属性</p>
<ul>
<li>用多少位来存储这个数据（假设10bit）。</li>
<li>最大值0b111111111</li>
<li>它对应的电压是多少伏（模拟信号输入的最大值是多少）我们就可以根据模拟信号(电压)的最大值，来计算出对应的数值。</li>
<li>采样&#x2F;转换速度。</li>
</ul>
<p>对于程序员，我们不关心ADC的内部机制，我们只关心：</p>
<ul>
<li>怎么启动ADC</li>
<li>启动之后怎么得到数据，</li>
</ul>
<p>总之：我们都是通过寄存器操作的。</p>
<p><img src="/image/700px-Chapter18_lesson1_002.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson1_002.png"></p>
<p>从图1-1-1可以看出ADC有8个多路选择器，显然，以后我们写程序的时候，我们可以8个多路选择之一， 下面是编写程序要做的步骤：</p>
<ol>
<li>确定是哪一路信号：设置8：1MUX，选择要测量哪一个引脚，（看原理图选择要测量的引脚）</li>
<li>设置工作时钟（从工作室中，可以算出转换一次，需要多长时间）</li>
<li>启动</li>
<li>读状态，判断ADC转换是否成功。</li>
<li>读数据</li>
</ol>
<p>ADC寄存器介绍</p>
<hr>
<p><strong>1.ADC 控制寄存器（ADCCON）</strong></p>
<p>ADCCON控制寄存器，用于标志转换是否完成，控制是否使能预分频器，输入通道选择，工作模式，ADC是否启动。它的各位含义如下图所示。</p>
<p><img src="/image/700px-Chapter18_lesson1_003.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson1_003.png"></p>
<p><strong>2.ADC 启动延时寄存器（ADCDLY）</strong></p>
<p>ADCDLY 启动延时寄存器用于启动或初始化延时寄存器。它的各位含义如下图所示</p>
<p><img src="/image/700px-Chapter18_lesson1_004.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson1_004.png"></p>
<p><strong>3.ADC 转换数据寄存器（ADCDAT0）</strong></p>
<p>ADCDAT0转换数据寄存器，本节中只用到该寄存器的前10位(用于保存转换后的结果)。</p>
<p><img src="/image/700px-Chapter18_lesson1_005.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson1_005.png"></p>
<p><strong>第002节_ADC编程</strong></p>
<hr>
<p>编程步骤：</p>
<ol>
<li>初始化ADC</li>
<li>读数据，</li>
<li>在串口上显示出来。</li>
</ol>
<p><img src="/image/Chapter18_lesson2_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson2_001.png"></p>
<p>1). 初始化ADC</p>
<p>下面的函数实现对ADC的初始化。</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">03 </span>void adc_init(void)<br><span class="hljs-number">04</span>   &#123;<br><span class="hljs-number">05</span>   /* [<span class="hljs-number">15</span>] : ECFLG,  <span class="hljs-number">1</span> = <span class="hljs-keyword">End</span> of A/D conversion<br><span class="hljs-number">06</span>               * [<span class="hljs-number">14</span>] : PRSCEN, <span class="hljs-number">1</span> = A/D converter prescaler enable<br><span class="hljs-number">07</span>               * [<span class="hljs-number">13</span>:<span class="hljs-number">6</span>]: PRSCVL, adc clk = PCLK / (PRSCVL + <span class="hljs-number">1</span>)<br><span class="hljs-number">08</span>               * [<span class="hljs-number">5</span>:<span class="hljs-number">3</span>] : SEL_MUX, <span class="hljs-number">000</span> = AIN <span class="hljs-number">0</span><br><span class="hljs-number">09</span>                * [<span class="hljs-number">2</span>]   : STDBM<br><span class="hljs-number">10</span>               * [<span class="hljs-number">0</span>]   : <span class="hljs-number">1</span> = A/D conversion starts <span class="hljs-keyword">and</span> this bit is cleared after the startup.<br><span class="hljs-number">11</span>               */<br><span class="hljs-number">12</span>           ADCCON = (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">14</span>) | (<span class="hljs-number">49</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">0</span>&lt;&lt;<span class="hljs-number">3</span>);<br><span class="hljs-number">13</span><br><span class="hljs-number">14</span>           ADCDLY = <span class="hljs-number">0</span>xff;       <br><span class="hljs-number">15</span>   &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>第12行：配置ADCCON寄存器，使能A&#x2F;D 转换器预分频器，设置A&#x2F;D 转换器预分频值，上拉使能。</li>
<li>第14行：设置ADC 转换启动延时值。</li>
</ul>
<p>2). 读数据</p>
<p>在这个读函数中启动ADC，并且等待ADC转换成功。然后返回数据，</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">17 </span><span class="hljs-keyword">int</span> adc_read_ain0(void)<br><span class="hljs-number">18</span>   &#123;<br><span class="hljs-number">19</span>                   /* 启动ADC */<br><span class="hljs-number">20</span>           ADCCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);<br><span class="hljs-number">21</span><br><span class="hljs-number">22</span>           <span class="hljs-keyword">while</span> (!(ADCCON &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>)));  /* 等待ADC结束 */<br><span class="hljs-number">23</span><br><span class="hljs-number">24</span>           <span class="hljs-keyword">return</span> ADCDAT0 &amp; <span class="hljs-number">0</span>x3ff;    //只关心其中的十位<br><span class="hljs-number">25</span>   &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>第20行：启动ADC。</li>
<li>第22行：等待A&#x2F;D转换结束(ADCCON第15位置1)，</li>
<li>第24行：返回转换的值。(ADCDAT0寄存器的前10位，是保存转换后的值)。</li>
</ul>
<p>3). ADC测试</p>
<p>函数代码如下: 函数功能：在串口&#x2F;LCD上打印ADC转换后的结果。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">04</span> void adc<span class="hljs-constructor">_test(<span class="hljs-params">void</span>)</span><br><span class="hljs-number">05</span>   &#123;<br><span class="hljs-number">06</span>           <span class="hljs-built_in">int</span> <span class="hljs-keyword">val</span>;<br><span class="hljs-number">07</span>           double vol;<br><span class="hljs-number">08</span>           <span class="hljs-built_in">int</span> m; <span class="hljs-comment">/* 整数部分 */</span><br><span class="hljs-number">09</span>           <span class="hljs-built_in">int</span> n; <span class="hljs-comment">/* 小数部分 */</span><br><span class="hljs-number">10</span>   <br><span class="hljs-number">11</span>           adc<span class="hljs-constructor">_init()</span>;<br><span class="hljs-number">12</span><br><span class="hljs-number">13</span>           <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br><span class="hljs-number">14</span>           &#123;<br><span class="hljs-number">15</span>                   <span class="hljs-keyword">val</span> = adc<span class="hljs-constructor">_read_ain0()</span>;<br><span class="hljs-number">16</span>                   vol = (double)<span class="hljs-keyword">val</span>/<span class="hljs-number">1023</span>*<span class="hljs-number">3.3</span>;   <span class="hljs-comment">/* 1023----3.3v */</span><br><span class="hljs-number">17</span>                   m = (<span class="hljs-built_in">int</span>)vol;   <span class="hljs-comment">/* 3.01, m = 3 */</span><br><span class="hljs-number">18</span>                   vol = vol - m;  <span class="hljs-comment">/* 小数部分: 0.01 */</span><br><span class="hljs-number">19</span>                   n = vol<span class="hljs-operator"> * </span><span class="hljs-number">1000</span>;  <span class="hljs-comment">/* 10 */</span><br><span class="hljs-number">20</span><br><span class="hljs-number">21</span>                   <span class="hljs-comment">/* 在串口上打印 */</span><br><span class="hljs-number">22</span>                   printf(<span class="hljs-string">&quot;vol: %d.%03dv&quot;</span>, m, n);  <span class="hljs-comment">/* 3.010v */</span><br><span class="hljs-number">23</span><br><span class="hljs-number">24</span>                   <span class="hljs-comment">/* 在LCD上打印 */</span><br><span class="hljs-number">25</span>                   <span class="hljs-comment">//fb_print_string();</span><br><span class="hljs-number">26</span>                   &#125;<br><span class="hljs-number">27</span>   &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>第11行：初始化ADC.</li>
<li>第15行：把ADC转换得到的值赋值给变量val.</li>
<li>第16行：把变量val的值转化为电压值。</li>
<li>第17行：取vol整数部分赋值给变量m。</li>
<li>第18行：取vol的小数部分赋值给vol。</li>
</ul>
<p>测试</p>
<p>把生成的二进制文件烧录到开发板上，接上SPI模块，旋转可变电阻就可以在串口上看到电压值发生变化。</p>
<p><strong>第003节_电阻触摸屏硬件原</strong></p>
<hr>
<p>这节课我们来讲电阻触摸屏的硬件原理</p>
<p>假设有一个比较长的电阻,电阻是R 上面接3.3V电压，下面接地</p>
<p><img src="/image/Chapter18_lesson3_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_001.png"></p>
<p>假设整个电阻的阻值是R某一个触电它的阻值是R1 根据欧姆定律</p>
<figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tp"><span class="hljs-number">3</span><span class="hljs-number">.3</span>v/<span class="hljs-keyword">R</span> = V/<span class="hljs-keyword">R</span><span class="hljs-number">1</span><br>V=<span class="hljs-number">3</span><span class="hljs-number">.3</span> *(<span class="hljs-keyword">R</span><span class="hljs-number">1</span>/<span class="hljs-keyword">R</span>)<br></code></pre></td></tr></table></figure>

<p>假设R1是x坐标 R的长度是L 这个电阻非常的均匀，那么这个电压就等于 3.3V * (x &#x2F; l) 这个电压和这个触电的x坐标有一个线性关系 我使用ADC把这个电压算出来，就可以间接得到这个触电的x坐标 电阻触摸屏就是使用欧姆定律使用电阻原理作出来的</p>
<p>可以上百度图片搜索触摸屏，就知道了触摸屏的样子,它是一个透明的薄膜,注意 LCD是LCD 触摸屏是触摸屏它是两个设备, 我们只不过是把触摸屏做的和LCD大小一样，粘在LCD上面, 实际上触摸屏是由两层膜组成，他们靠的非常近</p>
<p>上面这层右边引出来，代表xp ，p代表正极</p>
<p>上面这层左边引出来，代表xm, m代表负极</p>
<p><img src="/image/Chapter18_lesson3_002.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_002.png"></p>
<p>下面这层膜 前面这条边引出来为yp，后面这层边为ym</p>
<p>假设我们手指要点击触摸屏，那么上下就会粘贴在一起，我怎么算出这个 x y点的坐标呢？ 测量触电x坐标: xp接3.3v,xm接GND</p>
<p><img src="/image/Chapter18_lesson3_003.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_003.png"></p>
<p>yp,ym不接电源</p>
<p>2 测yp电压 上下膜连接在一起，我就可以通过yp测量这个触电的电压 这个yp就像探测一样，从前面的原理我们可以知道，当这个触电越靠近左边这个电压越小，越靠近右边电压越大 这个yp的电压就可以认为是这个触电的坐标(x坐标)</p>
<p>类似的我们怎么测量触电y坐标 类似的xp xm不接电源，同样yp接3.3v， ym接GND，这时候电流就从 yp这里流向ym,让后我们就可以测量xp电压 当按下屏幕时，上下两层膜链接在一起，这个xp就像探针一样，这个触电越靠近yp电压值越大，越靠近ym电压值越小</p>
<p><img src="/image/Chapter18_lesson3_004.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_004.png"></p>
<p>yp接3.3V ym接GND，xp xm不接电源 测量xp电压,就是y坐标</p>
<p>注意 x y坐标都是电压值，不是屏幕上480 * 272 这些值，我们需要把电压值转换为坐标值，这需要经过一些转换</p>
<p>我们测量xp yp可以得到触点的两个方向的电压值，这些电压值和坐标是线性关系 我们现在总结下使用触摸屏的流程</p>
<ol>
<li><p>按下触摸屏 按下触摸屏时，对于一个高效的系统，产生中断，这是触摸屏中断</p>
</li>
<li><p>在触摸中断程序中启动ADC，(获得数据，xy坐标)启动ADC就开始模数转换，不可能瞬间完成。</p>
</li>
<li><p>ADC完成， 产生中断</p>
</li>
<li><p>在ADC中断中读取x y坐标，我们来想想，在这个流程里，启动触摸屏的源头是按下触摸屏，那如果长按触摸屏，我按下之后一直不松开滑动手指呢</p>
<ul>
<li>那么谁来触发后续的多次ADC转换呢 不可能只启动一次吧, 为了支持长按滑动操作，我们需要启用定时器.</li>
</ul>
</li>
<li><p>松开启动定时器(为了支持长按滑动等)</p>
</li>
</ol>
<p>       6. 定时器中断发生，判断触摸屏是否仍被按下，如果按下就循环上述过程(由2开始)</p>
<p>a. 在触摸中断程序中启动ADC，(获得数据，xy坐标)启动ADC就开始模数转换，不可能瞬间完成</p>
<p>b. ADC完成，产生中断</p>
<p>c. ADC中断中读取x y坐标，)</p>
<ol>
<li>松开结束一个流程</li>
</ol>
<p>平时的时候上下两层膜并不连接，我们按下触摸屏的时候就会产生中断，那么你怎么知道产生中断，肯定是由某个引脚的电平发生变化,平时 Y_ADC&#x2F;xp是高电平,按下之后Y_ADC就接地了，就是被拉低了，就产生了低电平</p>
<p><img src="/image/Chapter18_lesson3_005.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_005.png"></p>
<p>产生低电平后就知道触摸屏被按下了，这个时候就需要测量电压值读取x坐标,XP XM通电我就测量YP的电压，这不就是 x 点的坐标</p>
<p><img src="/image/Chapter18_lesson3_006.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_006.png"></p>
<p>读取Y坐标</p>
<p>YP YM 通电，按下后XP通电，这不就是y点的坐标么</p>
<p><img src="/image/Chapter18_lesson3_007.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson3_007.png"></p>
<p><strong>第004节_S3C2440触摸屏接口</strong></p>
<hr>
<p>回顾上节触摸屏使用原理</p>
<p><img src="/image/Chapter18_lesson4_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson4_001.png"></p>
<p>在不使用触摸屏的时候，必须要把 S1 S2 S3断开，S4 S5闭合，只有这样当我按下触摸屏，上面的电平才能从高变低，会产生一个中断信号,而当我去读取X坐标的值时</p>
<p><img src="/image/Chapter18_lesson4_002.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson4_002.png"></p>
<p>必须让S1 S3闭合，这样电流才可以通过，同时让S2 S4 S5断开,这时候YP这层膜就相当于探针一样去测量电压</p>
<p>当我读取y坐标值</p>
<p><img src="/image/Chapter18_lesson4_003.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson4_003.png"></p>
<p>必须让S2 S4闭合，这样电流才可以流 下来，同时S1 S3 S5断开，这个时候XP这层膜就相当于探针一样，我可以来测量这里的电压，从而得到Y坐标的电压值</p>
<p>在测量x y坐标时，这个S5上拉电阻都要断开, 我们需要控制这几个开关，实际上2440的触摸屏接口就提供了这几个开关的控制方法, 打开2440的芯片手册, 从440到450， 我们看有一个8:1 MUX的多路选择器，以及XP YP</p>
<p><img src="/image/700px-Chapter18_lesson4_004.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_004.png"></p>
<p>442页触摸屏接口模式</p>
<p><img src="/image/700px-Chapter18_lesson4_005.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_005.png"></p>
<p><strong>正常模式，在上节视频中我们有讲解过</strong></p>
<p><strong>x y分离转换模式,</strong></p>
<p>看看我们的X Y坐标原理图，可以单独转换X坐标 单独转换Y坐标</p>
<p>换句话说就是逐个去测量X Y坐标,</p>
<p>他首先会启动X坐标的ADC转换，转换成功后数据会保存在ADCDAT0里，同时会产生一个中断，在这个中断服务程序里，就可以把X坐标读取出来，让后可以启动Y坐标的转换，转换成功后数据会保存在ADCDAT，同时会产生一个中断，进入这个中断把Y坐标读取出来 测量一次会产生２个中断，一个是X坐标中断，一个是Y坐标中断</p>
<p><strong>自动的或连续的X／Y坐标转换模式</strong></p>
<p>也就是说不需要单独控制，不需要单独去读取X坐标Y坐标，可以设置寄存器，让它一次性的测量X坐标测量Y坐标，X坐标保存在ADCDAT０　Y坐标保存在ADCDAT１，最后产生一个中断，也就是读取X／Y坐标只需要产生一次中断</p>
<p><strong>等待中断模式</strong></p>
<p>所谓等待中断模式，就是等待按下或者等待松开</p>
<p>对于下面这幅图，我按下的时候XP从高电平变为低电平，松开时，XP从低电平变为高电平，这就是按下松开都可以检测到</p>
<p>我们要等待按下或者松开时　需要设置rADCTSC &#x3D;0xd3这个值</p>
<p>Standby Mode静默模式&#x2F;省电模式(我们不关心这个)</p>
<p><img src="/image/700px-Chapter18_lesson4_006.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_006.png"></p>
<p>443页编程要点</p>
<p><img src="/image/700px-Chapter18_lesson4_007.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_007.png"></p>
<ul>
<li>AD转换数据时可以通过中断或者查询模式来得到数据，使用中断模式时，从AD转换开始，到得到数据可能会有些延迟，因为中断服务程序的进入和退出需要一定的时间，(也就是说，如果你对数据转换的速度要求的非常高，就可以使用查询方式)，可以查询ADCCON[15]来判断是否转换结束</li>
</ul>
<p>444页 剩下就是寄存器操作</p>
<p><img src="/image/700px-Chapter18_lesson4_008.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_008.png"></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">ECFLG状态位 AD转换是否结束<br>PRSCEN 使能ADC转换<br>PRSCVL 设置A/D转换预分频值<br>SEL<span class="hljs-emphasis">_MUX选择输入通道，后面我们使用自动转换XY坐标，所以这里不需要设置</span><br><span class="hljs-emphasis">ENABLE_</span>START 启动转换<br></code></pre></td></tr></table></figure>

<p>445页</p>
<p>ADCTSC这个寄存器是重要的</p>
<p><img src="/image/700px-Chapter18_lesson4_009.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_009.png"></p>
<ul>
<li>UD_SEN Bit8是用来判断触摸屏是被按下还是被松开<ul>
<li>0表明被按下，1表明被松开</li>
</ul>
</li>
<li>YM_SEN Bit7  YM开关使能控制S4</li>
</ul>
<p><img src="/image/Chapter18_lesson4_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson4_001.png"></p>
<pre><code class="hljs">- 0表示断开 1闭合
</code></pre>
<ul>
<li>YP_SEN Bit6 YP开关 0表示闭合 1 表示断开<ul>
<li>寄存器位的含义不同</li>
</ul>
</li>
<li>XM_SEN Bit5 XM开关 0 断开 1 闭合<ul>
<li>XP_SEN Bit4 XP开关</li>
</ul>
</li>
</ul>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">0 </span>闭合 <span class="hljs-number">1</span> 断开<br></code></pre></td></tr></table></figure>

<ul>
<li>PULL_UP Bit3 控制S5开关 0 上拉(闭合)</li>
</ul>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>断开<br></code></pre></td></tr></table></figure>

<ul>
<li>AUTO_PST Bit2 自动连续转换X坐标Y坐标</li>
</ul>
<p>上节视频里我们设置是 0 正常的ADC转换</p>
<p>如果需要连续转换ADC坐标的话，需要设置为1 ，如果需要手动转换ADC坐标的话，需要设置为0</p>
<ul>
<li>XY_PST Bit[1:0] 对于手动转换X Y坐标我们需要手动设置XY_PST 里面的位，是测量X坐标还是测量Y坐标, 也可以设置这两位等于11 让其等于等待模式, 也就是等待触摸屏被按下或者被松开.</li>
</ul>
<p>如果设置自动连续转换的话，Bit2 AUTO_PST设置为1 XY_PST设置为00</p>
<p>如果使用手动转换的话设置AUTO_PST为0 XY_PST设置为01 手动转换X坐标模式 或者设置为10 Y坐标转换模式</p>
<p>447页ADCDATA0 ADC数据寄存器</p>
<p><img src="/image/700px-Chapter18_lesson4_0010.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0010.png"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">UPDOWN</span> Bit15 可以读取这一位去判断触摸屏是按下还是松开<br><span class="hljs-attribute">AUTO_PST</span> Bit14 自动测量<br><span class="hljs-attribute">XY_PST</span> Bit[<span class="hljs-number">13</span>:<span class="hljs-number">12</span>] 和上面ADCTSC寄存器中 AUTO_PST Bit2   XY_PST Bit[<span class="hljs-number">1</span>:<span class="hljs-number">0</span>]原理相同<br><span class="hljs-attribute">XPDATA</span> Bit[<span class="hljs-number">9</span>:<span class="hljs-number">0</span>]最低<span class="hljs-number">10</span>位用来保存ADC的值<br></code></pre></td></tr></table></figure>

<p>448页’ADCDAT1寄存器 和ADCDAT0功能一样的，只不过保存的数据不同</p>
<p><img src="/image/700px-Chapter18_lesson4_0011.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0011.png"></p>
<p>这个的低10位是用来保存 Y坐标的值</p>
<p>接下来是ADCUPDN触摸屏按下或者松开检查寄存器</p>
<p><img src="/image/700px-Chapter18_lesson4_0012.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0012.png"></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">TST_UP <span class="hljs-keyword">Bit1 </span>触摸屏松开中断产生<br>TST_DN <span class="hljs-keyword">Bit0 </span>触摸屏按下中断产生<br></code></pre></td></tr></table></figure>

<p>手册看完了，涉及到中断，我们看下这个图</p>
<p><img src="/image/Chapter18_lesson4_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson4_001.png"></p>
<p>它会涉及两个中断，按下或者松开，即触摸笔的状态中断，另外一个启动ADC以后，ADC结束时也会产生一个中断，但是这个手册里没有看到中断的使能寄存器</p>
<p>那我们猜测一下，ADC模块或者触摸屏模块一定会发出中断</p>
<p>首先是ADC或者触摸屏产生中断，通过中断控制器发送中断给CPU</p>
<p><img src="/image/700px-Chapter18_lesson4_0013.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0013.png"></p>
<p>肯定有寄存器禁止／使能ADC或者触摸屏中断</p>
<p>我们看看中断控制器芯片手册中都需要设置什么</p>
<p><img src="/image/700px-Chapter18_lesson4_0013-1.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0013-1.png"></p>
<p>ADC中断源</p>
<p><img src="/image/700px-Chapter18_lesson4_0014.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0014.png"></p>
<p>ADC结束中断或者触摸屏中断，看来他们合起来用一个中断 既然合并必然还会有一个寄存器来分辨到底是ADC还是触摸屏发生的中断变化</p>
<p>SRCPND寄存器 31位为ADC中断</p>
<p><img src="/image/700px-Chapter18_lesson4_0015.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0015.png"></p>
<p><img src="/image/700px-Chapter18_lesson4_0016.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0016.png"></p>
<p>设置Bit[31]</p>
<p>INTMOD寄存器 来决定是普通中断还是快中断模式</p>
<p><img src="/image/700px-Chapter18_lesson4_0017.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0017.png"></p>
<p>设置Bit[31]</p>
<p><img src="/image/700px-Chapter18_lesson4_0018.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0018.png"></p>
<p>INTMSK寄存器 用来表示是否屏蔽这个中断</p>
<p><img src="/image/700px-Chapter18_lesson4_0019.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0019.png"></p>
<p>设置Bit[31]</p>
<p><img src="/image/700px-Chapter18_lesson4_0020.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0020.png"></p>
<p>INTOFFSET 设置Bit[31]</p>
<p><img src="/image/700px-Chapter18_lesson4_0023.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0023.png"></p>
<p>到底是ADC中断还是触摸屏中断，肯定有其他寄存器可以设置</p>
<p>SUBSOURCE PENDING寄存器</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">INT_ADC_S</span> Bit[<span class="hljs-number">10</span>]表示ADC中断<br><span class="hljs-attribute">INT_TC</span> Bit[<span class="hljs-number">9</span>]表示触摸屏中断<br></code></pre></td></tr></table></figure>

<p><img src="/image/700px-Chapter18_lesson4_0024.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0024.png"></p>
<p>INTSUBMSK 也是同样的位</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">INT_ADC_S</span> Bit[<span class="hljs-number">10</span>]表示ADC中断激活/屏蔽<br><span class="hljs-attribute">INT_TC</span> Bit[<span class="hljs-number">9</span>]表示触摸屏中断激活/屏蔽<br></code></pre></td></tr></table></figure>

<p><img src="/image/700px-Chapter18_lesson4_0025.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0025.png"></p>
<p>我们可以通过INTSUBMSK来屏蔽ADC中断或者TouchScreen中断 当然也可以是能某个中断 可以通过SUBSRCPND来分辨到底产生那个中断，再使用INTSUBMSK屏蔽某一个，最后和SUBSOURCPND这两个寄存器都会汇集到一起 变成一个叫做INT_ADC的中断来发送给CPU</p>
<p>框图就是这样</p>
<p><img src="/image/700px-Chapter18_lesson4_0026.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0026.png"></p>
<p>我们怎么写程序？ 写出一个框架</p>
<ol>
<li><p>初始化ADC&#x2F;TouchScreen接口(ADCCON,时钟,接口等)</p>
</li>
<li><p>一开始触摸屏是没有被按下的，设置TS处于等待中断模式</p>
</li>
<li><p>设置中断</p>
<ul>
<li>INTSUBMSK使能ADC中断和触摸屏中断</li>
<li>设置INTMSK使能INT_ADC让他能够发给CPU</li>
</ul>
</li>
<li><p>按下触摸屏，进入TS中断</p>
<ul>
<li>进入自动采集模式(自动转换XY坐标)</li>
<li>启动ADC</li>
</ul>
</li>
</ol>
<p>       5. 转换完之后产生ADC中断</p>
<pre><code class="hljs">- 读数据
- 再次进入 “&#39;等待中断”&#39;模式\(等待触摸屏被松开\)
- 启动定时器，处理长按或者滑动
</code></pre>
<p>       6. 定时器中断</p>
<pre><code class="hljs">- 判断笔是否松开，若松开结束
- 若仍然按下重新执行，重新4.2启动ADC步骤
</code></pre>
<p><strong>第005节_触摸屏编程_按下松开检测</strong></p>
<hr>
<p><img src="/image/Chapter18_lesson5_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson5_001.png"></p>
<p>看懂这张图的关键点在于 里面有个中断程序 AdcTsIntHandle 它是总的中断，这里面要分辨if, 如果是ADC中断 那么就调用Isr_adc来处理中段 else if, 如果是触摸屏中断，那么就调用Isr_tc中断</p>
<p>我们看看是怎么做的</p>
<ul>
<li>一开始设置中断</li>
<li>初始化触摸屏控制器，进入等待中断模式</li>
<li>这个时候如果按下触摸屏就会进入Pen Down中断</li>
<li>就会进入AdcTsIntHandle这个总中断函数</li>
<li>这里面分辨是按下触摸屏</li>
<li>进入自动(连续) X&#x2F;Y轴坐标转换模式，启动ADC,</li>
<li>ADC结束之后会产生一个ADC中断</li>
<li>又再次进入这个AdcTsIntHandle总中断</li>
<li>这里面分辨是ADC中断，这里面调用Isr_Adc</li>
<li>我可以读出这里面的数据，再次设置寄存器</li>
<li>进入等待Pen UP中断模式</li>
<li>松开触摸笔会再次产生一个中断 </li>
<li>进入总中断AdcTsIntHandle这里面分辨，原来是松开了触摸笔，再次调用Isr_tc </li>
<li>这里面又会设置进入等待Pen Down中断模式</li>
</ul>
<p>我们开始写代码，再上一个视频ADC代码上进行修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">002_touchscreen_018_005/adc_touchscreen<br></code></pre></td></tr></table></figure>

<p>我们在adc_touchscreen目录下添加几个文件</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">touchscreen_test.<span class="hljs-keyword">c</span><br>touchscreen.<span class="hljs-keyword">c</span><br></code></pre></td></tr></table></figure>

<p>先写touchscreen.c文件</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs scss">void <span class="hljs-built_in">touchscreen_init</span>(void)&#123;<br>        看看上面流程图<br>        <span class="hljs-comment">/*1 设置中断我们需要提供中断处理函数 */</span><br>        <span class="hljs-comment">/*2 设置触摸屏接口:也就是寄存器 */</span><br>        <span class="hljs-comment">/*3 让触摸屏控制器进入&quot;等待中断模式&quot; */</span><br>&#125;<br>我们设置中断处理函数<br>void <span class="hljs-built_in">AdcTsIntHandle</span>(void)<br>&#123;<br>&#125;<br><br>看一下之前我们是怎么写中断的,看一下interrupt<span class="hljs-selector-class">.c</span>文件<br>void <span class="hljs-built_in">key_eint_irq</span>(int irq)<br>有个中断号<br><br>那么我们也定义个int irq参数<br>void <span class="hljs-built_in">AdcTsIntHandle</span>(int irq)<br>我们在这个里面分辨一下<br>if (SUBSRCPND &amp; (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT))  <span class="hljs-comment">/* 如果是触摸屏中断 */</span><br>        <span class="hljs-built_in">Isr_Tc</span>();    <span class="hljs-comment">/* 调用 */</span>   <br>else if <span class="hljs-comment">/* 如果是ADC中断 */</span><br>        <span class="hljs-built_in">Isr_Adc</span>();    <span class="hljs-comment">/* 调用 */</span><br>我们等会实现这两个函数<br><br>我们继续写代码<br>void <span class="hljs-built_in">touchscreen_init</span>(void)<br>&#123;<br>        看看上面流程图<br>        <span class="hljs-comment">/*1 设置中断，我们需要提供中断处理函数 */</span><br>        <span class="hljs-built_in">adc_ts_int_init</span>();<br>        <span class="hljs-comment">/*2 设置触摸屏接口:也就是寄存器 */</span><br>        <span class="hljs-built_in">adc_ts_reg_init</span>();<br>        <span class="hljs-comment">/*3 让触摸屏控制器进入&quot;等待中断模式&quot; */</span><br>        <span class="hljs-built_in">enter_wait_pen_down_mode</span>();<br>&#125;<br><br><span class="hljs-comment">//我们先来实现 adc_ts_int_init</span><br><br>void <span class="hljs-built_in">adc_ts_int_init</span>(void)<br>&#123;<br>        <span class="hljs-comment">/*注册中断处理函数*/</span><br><span class="hljs-comment">//怎么注册看之前的代码</span><br>        <span class="hljs-built_in">register_irq</span>(irq, irq_handle);<br>        <span class="hljs-comment">/* 使能中断 */</span><br></code></pre></td></tr></table></figure>

<p>中断号是多少？</p>
<p>打开芯片手册，找到中断控制器</p>
<p><img src="/image/700px-Chapter18_lesson4_0015.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0015.png"></p>
<p><img src="/image/700px-Chapter18_lesson4_0016.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0016.png"></p>
<p>我们是31号中断</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">register_ir<span class="hljs-string">q(31, AdcTsIntHandle)</span>;   <br></code></pre></td></tr></table></figure>

<p>怎么使能中断?</p>
<p>我们需要把&lt;code&gt; INTSUBMISK寄存器的Bit9 Bit10设置为0 宏定义</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADC_INT_BIT (10)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_INT_BIT  (9)</span><br></code></pre></td></tr></table></figure>

<p>使能中断，清零</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">INTSUBMSK</span> &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT));<br></code></pre></td></tr></table></figure>

<p>还有INTMSK我们也需要把Bit31清零</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> INT_ADC_TC (31)</span><br></code></pre></td></tr></table></figure>

<p>Bit31位清零操作</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">INTMSK    <span class="hljs-meta">&amp;= ~(1&lt;&lt;INT_ADC_TC);</span><br></code></pre></td></tr></table></figure>

<p>这句可以不用设置，因为register_irq已经设置</p>
<p>假设产生中断就会进入AdcTsIntHandle函数中 分辨是触摸屏终端还是ADC中断</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">void <span class="hljs-built_in">AdcTsIntHandle</span>(int irq)<br>&#123;<br>        if   <span class="hljs-comment">/* 如果是触摸屏中断 */</span><br>                <span class="hljs-built_in">Isr_Tc</span>();<br>        if  <span class="hljs-comment">/* ADC中断 */</span><br>                <span class="hljs-built_in">Isr_Adc</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如何进行分辨</p>
<p><img src="/image/700px-Chapter18_lesson4_0024.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson4_0024.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell">if (SUBSRCPND &amp; (1&lt;&lt;TC_INT_BIT))  /* 如果是触摸屏中断 */<br>        Isr_Tc();<br>if (SUBSRCPND &amp; (1&lt;&lt;ADC_INT_BIT))  /* ADC中断 */<br>        Isr_Adc();<br><br>//我们要引用寄存器地址头文件<br><span class="hljs-meta prompt_">#</span><span class="language-bash">include <span class="hljs-string">&quot;../s3c2440_soc.h&quot;</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define ADC_INT_BIT (10)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define TC_INT_BIT  (9)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define INT_ADC_TC   (31)</span><br>/* ADCTSC&#x27;s bits */<br><span class="hljs-meta prompt_">#</span><span class="language-bash">define WAIT_PEN_DOWN    (0&lt;&lt;<span class="hljs-string">8)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define WAIT_PEN_UP      (1&lt;&lt;8</span>)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define YM_ENABLE        (1&lt;&lt;<span class="hljs-string">7)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define YM_DISABLE       (0&lt;&lt;7</span>)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define YP_ENABLE        (0&lt;&lt;<span class="hljs-string">6)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define YP_DISABLE       (1&lt;&lt;6</span>)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define XM_ENABLE        (1&lt;&lt;<span class="hljs-string">5)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define XM_DISABLE       (0&lt;&lt;5</span>)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define XP_ENABLE        (0&lt;&lt;<span class="hljs-string">4)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define XP_DISABLE       (1&lt;&lt;4</span>)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define PULLUP_ENABLE    (0&lt;&lt;<span class="hljs-string">3)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define PULLUP_DISABLE   (1&lt;&lt;3</span>)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define AUTO_PST         (1&lt;&lt;<span class="hljs-string">2)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define WAIT_INT_MODE    (3)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">define NO_OPR_MODE      (0)</span></span><br>void enter_wait_pen_down_mode(void)<br>&#123;<br>        ADCTSC = WAIT_PEN_DOWN | PULLUP_ENABLE | YM_ENABLE | YP_DISABLE | XP_DISABLE | XM_DISABLE | WAIT_INT_MODE;<br>&#125;<br>void enter_wait_pen_up_mode(void)<br>&#123;<br>        ADCTSC = WAIT_PEN_UP | PULLUP_ENABLE | YM_ENABLE | YP_DISABLE | XP_DISABLE | XM_DISABLE | WAIT_INT_MODE;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>读一下寄存器,找到触摸屏的寄存器触摸笔,按下松开状态寄存器</p>
<p><img src="/image/Chapter18_lesson5_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson5_001.png"></p>
<p>我们可以读它 Bit1表示up Bit0表示down</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Isr_Tc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ADCUPDN = 0x%x, ADCDAT0 = 0x%x, ADCDAT1 = 0x%x, ADCTSC = 0x%x\n\r&quot;</span>, ADCUPDN, ADCDAT0, ADCDAT1, ADCTSC);<br>        <br>        <span class="hljs-keyword">if</span> (ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))<br>        &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pen up\n\r&quot;</span>);<br>                <span class="hljs-built_in">enter_wait_pen_down_mode</span>();<br>        &#125;<br>        <span class="hljs-keyword">else</span>   <br>        &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pen down\n\r&quot;</span>);<br><br>                <span class="hljs-comment">/* 进入&quot;等待触摸笔松开的模式&quot; */</span><br>                <span class="hljs-built_in">enter_wait_pen_up_mode</span>();<br>        &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AdcTsIntHandle</span><span class="hljs-params">(<span class="hljs-type">int</span> irq)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-keyword">if</span> (SUBSRCPND &amp; (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT))  <span class="hljs-comment">/* 如果是触摸屏中断 */</span><br>                <span class="hljs-built_in">Isr_Tc</span>();<br><br><span class="hljs-comment">//       if (SUBSRCPND &amp; (1&lt;&lt;ADC_INT_BIT))  /* ADC中断*/</span><br><span class="hljs-comment">//               Isr_Adc();</span><br>        SUBSRCPND = (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT); <span class="hljs-comment">/* 清中断 */</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_ts_int_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        SUBSRCPND = (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT);<br><br>        <span class="hljs-comment">/* 注册中断处理函数 */</span><br>        <span class="hljs-built_in">register_irq</span>(<span class="hljs-number">31</span>, AdcTsIntHandle);<br><br>        <span class="hljs-comment">/* 使能中断 */</span><br>        INTSUBMSK &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT));<br>        <span class="hljs-comment">//INTMSK    &amp;= ~(1&lt;&lt;INT_ADC_TC);</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_ts_reg_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">/* [15] : ECFLG,  1 = End of A/D conversion  </span><br><span class="hljs-comment">         * [14] : PRSCEN, 1 = A/D converter prescaler enable  </span><br><span class="hljs-comment">         * [13:6]: PRSCVL, adc clk = PCLK / (PRSCVL + 1)  </span><br><span class="hljs-comment">         * [5:3] : SEL_MUX, 000 = AIN 0  * [2]   : STDBM  </span><br><span class="hljs-comment">         * [0]   : 1 = A/D conversion starts and this bit is cleared after the startup.  </span><br><span class="hljs-comment">         */</span><br>        ADCCON = (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">14</span>) | (<span class="hljs-number">49</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">0</span>&lt;&lt;<span class="hljs-number">3</span>);<br><br>        ADCDLY = <span class="hljs-number">0xff</span>;       <br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">touchscreen_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">/* 设置触摸屏接口:寄存器 */</span><br>        <span class="hljs-built_in">adc_ts_reg_init</span>();<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ADCUPDN = 0x%x, SUBSRCPND = 0x%x, SRCPND = 0x%x\n\r&quot;</span>, ADCUPDN, SUBSRCPND, SRCPND);<br><br>        <span class="hljs-comment">/* 设置中断 */</span><br>        <span class="hljs-built_in">adc_ts_int_init</span>();<br><br>        <span class="hljs-comment">/* 让触摸屏控制器进入&quot;等待中断模式&quot; */</span><br>        <span class="hljs-built_in">enter_wait_pen_down_mode</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>第006节_触摸屏编程_ADC中断</strong></p>
<hr>
<p>这节课我们加上ADC中断把触点的xy坐标读出来</p>
<p>查看touchscreen.c</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">写出这个自动测量的函数<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">enter_auto_measure_mode</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br><span class="hljs-comment">//现在是自动测量，我们没有机会分别设置这些开关</span><br><br>设置<span class="hljs-variable constant_">AUTO_PST</span> =<span class="hljs-number">1</span><br><span class="hljs-variable constant_">XY_PST</span> = <span class="hljs-number">00</span><br><br>        <span class="hljs-variable constant_">ADCTSC</span> = <span class="hljs-variable constant_">AUTO_PST</span> | <span class="hljs-variable constant_">NO_OPR_MODE</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>&#x2F;&#x2F;现在是自动测量，我们没有机会分别设置这些开关</p>
<p><img src="/image/700px-Chapter18_lesson6_001.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson6_001.png"></p>
<p>进入中断处理函数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void <span class="hljs-constructor">AdcTsIntHandle(<span class="hljs-params">int</span> <span class="hljs-params">irq</span>)</span><br>&#123;<br>        <span class="hljs-keyword">if</span> (SUBSRCPND &amp; (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT))  <span class="hljs-comment">/* 如果是触摸屏中断 */</span><br>                <span class="hljs-constructor">Isr_Tc()</span>;<br><br>        <span class="hljs-keyword">if</span> (SUBSRCPND &amp; (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT))  <span class="hljs-comment">/* ADC中断，则会进入Adc中断处理函数 */</span><br>                <span class="hljs-constructor">Isr_Adc()</span>;<br><br>        SUBSRCPND = (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT) <span class="hljs-pattern-match">| (1&lt;&lt;<span class="hljs-constructor">ADC_INT_BIT</span>);</span><br><span class="hljs-pattern-match">&#125;</span><br></code></pre></td></tr></table></figure>

<p>进入触摸屏中断处理函数</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">void Isr_Tc(void)<br>&#123;<br>        <span class="hljs-regexp">//</span>printf(<span class="hljs-string">&quot;ADCUPDN = 0x%x, ADCDAT0 = 0x%x, ADCDAT1 = 0x%x, ADCTSC = 0x%x\n\r&quot;</span>, ADCUPDN, ADCDAT0, ADCDAT1, ADCTSC);<br>        <br>        <span class="hljs-keyword">if</span> (ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))<br>        &#123;<br>                <span class="hljs-regexp">//</span>printf(<span class="hljs-string">&quot;pen up\n\r&quot;</span>);<br>                enter_wait_pen_down_mode();<br>        &#125;<br>        <span class="hljs-keyword">else</span>   <br>        &#123;<br>                <span class="hljs-regexp">/* 进入&quot;自动测量&quot;模式 */</span><br>                enter_auto_measure_mode();<br><br>                <span class="hljs-regexp">/* 启动ADC */</span><br>ENABLE_START = <span class="hljs-number">1</span>就可以了<br>                ADCCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>&#x2F;* 启动ADC *&#x2F;</p>
<p><img src="/image/700px-Chapter18_lesson6_002.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson6_002.png"></p>
<p>Adc中断处理函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Isr_Adc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        进入adc中断后，等待触摸笔松开<br>        <span class="hljs-type">int</span> x = ADCDAT0 &amp; <span class="hljs-number">0x3ff</span>;<br>        <span class="hljs-type">int</span> y = ADCDAT1 &amp; <span class="hljs-number">0x3ff</span>;<br>                <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;x = %08d, y = %08d\n\r&quot;</span>, x, y);<br><br><span class="hljs-comment">//等待触摸笔松开模式</span><br>        <span class="hljs-built_in">enter_wait_pen_up_mode</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>烧写 实验发现打印一堆乱码</p>
<p><img src="/image/700px-Chapter18_lesson6_003.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson6_003.png"></p>
<p>应该是printf函数出了问题 打开my_printf.c文件，找到printf函数 应该是处理第二个数据的时候，没有设置初始值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*reference :   int vprintf(const char *format, va_list ap); */</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">my_vprintf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fmt, va_list ap)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">char</span> lead=<span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-type">int</span>  maxwidth=<span class="hljs-number">0</span>;<br>        <br>         <span class="hljs-keyword">for</span>(; *fmt != <span class="hljs-string">&#x27;\0&#x27;</span>; fmt++)<br>         &#123;<br>                 <span class="hljs-keyword">if</span> (*fmt != <span class="hljs-string">&#x27;%&#x27;</span>) <br>                &#123;<br>                    <span class="hljs-built_in">outc</span>(*fmt);<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>        <span class="hljs-comment">//碰到 % 就重新处理， 初始值应该重新设置初始值上去</span><br>                lead=<span class="hljs-string">&#x27; &#x27;</span>;<br>                maxwidth=<span class="hljs-number">0</span>;<br>                <br>                <span class="hljs-comment">//format : %08d, %8d,%d,%u,%x,%f,%c,%s</span><br>                    fmt++;<br>                <span class="hljs-keyword">if</span>(*fmt == <span class="hljs-string">&#x27;0&#x27;</span>)<br>                &#123;<br>                        lead = <span class="hljs-string">&#x27;0&#x27;</span>;<br>                        fmt++;  <br>                &#125;<br>                <br>                <span class="hljs-keyword">while</span>(*fmt &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; *fmt &lt;= <span class="hljs-string">&#x27;9&#x27;</span>)<br>                &#123;<br>                        maxwidth *=<span class="hljs-number">10</span>;<br>                        maxwidth += (*fmt - <span class="hljs-string">&#x27;0&#x27;</span>);<br>                        fmt++;<br>                &#125;<br>                <br>                        <span class="hljs-keyword">switch</span> (*fmt) <br>            &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-built_in">out_num</span>(<span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">int</span>),          <span class="hljs-number">10</span>,lead,maxwidth); <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;o&#x27;</span>: <span class="hljs-built_in">out_num</span>(<span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>),  <span class="hljs-number">8</span>,lead,maxwidth); <span class="hljs-keyword">break</span>;                                <br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;u&#x27;</span>: <span class="hljs-built_in">out_num</span>(<span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>), <span class="hljs-number">10</span>,lead,maxwidth); <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;x&#x27;</span>: <span class="hljs-built_in">out_num</span>(<span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>), <span class="hljs-number">16</span>,lead,maxwidth); <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-built_in">outc</span>(<span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">int</span>   )); <br><span class="hljs-keyword">break</span>;         <br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-built_in">outs</span>(<span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">char</span> *)); <span class="hljs-keyword">break</span>;                               <br>                                <br>                <span class="hljs-keyword">default</span>: <span class="hljs-built_in">outc</span>(*fmt);<br><span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重新烧写执行，发现数据变化幅度很大，但至少Adc已经有输出</p>
<p><img src="/image/Chapter18_lesson6_004.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson6_004.png"></p>
<p>我们需要解决输出值不线性的问题</p>
<p>到底是触摸屏质量问题，还是Adc转化精度问题， 觉得应该是触摸屏电压不稳定 之前不知道DELAY寄存器是用来干嘛的</p>
<p><img src="/image/700px-Chapter18_lesson6_005.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson6_005.png"></p>
<p>等待中断模式时，当触摸笔按下时我们会产生中断，但是可以通过 DELAY来延时产生中断</p>
<p>在前面有一张图</p>
<p><img src="/image/700px-Chapter18_lesson6_006.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson6_006.png"></p>
<p>按下触摸笔，延迟A 才可以产生中断，你才可以测量X Y坐标 A &#x3D; D（晶振的周期） D就是 DELAY就是那个寄存器的值 晶振周期时12M 我们需要设置一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">void</span> <span class="hljs-title function_">adc_ts_reg_init</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>        <span class="hljs-comment">/* [15] : ECFLG,  1 = End of A/D conversion  </span><br><span class="hljs-comment">         * [14] : PRSCEN, 1 = A/D converter prescaler enable  </span><br><span class="hljs-comment">         * [13:6]: PRSCVL, adc clk = PCLK / (PRSCVL + 1)  </span><br><span class="hljs-comment">         * [5:3] : SEL_MUX, 000 = AIN 0  * [2]   : STDBM  </span><br><span class="hljs-comment">         * [0]   : 1 = A/D conversion starts and this bit is cleared after the startup.  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-variable constant_">ADCCON</span> = (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">14</span>) | (<span class="hljs-number">49</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">0</span>&lt;&lt;<span class="hljs-number">3</span>);<br><br>        <span class="hljs-comment">/*  按下触摸屏, 延时一会再发出TC中断  </span><br><span class="hljs-comment">         * 10ms为120000  </span><br><span class="hljs-comment">         *  延时时间 = ADCDLY </span><br><span class="hljs-comment">         * 晶振周期 = ADCDLY </span><br><span class="hljs-comment">         * 1 / 12000000 = 5ms  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-variable constant_">ADCDLY</span> = <span class="hljs-number">60000</span>;      <br>&#125;<br></code></pre></td></tr></table></figure>

<p>再次烧写，发现数据并不规律 我们需要再次改进程序</p>
<p>我们按下触摸屏会产生触摸屏中断，启动自动测量，启动Adc，Adc成功后会进入Adc中断，在函数中打印数据</p>
<p>也许测量过程很长 我们就需要判断</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Isr_Adc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">int</span> x = ADCDAT0;<br>        <span class="hljs-type">int</span> y = ADCDAT1;<span class="hljs-comment">//松开的话打印也是错误的值，所以如果仍然按下才打印</span><br>        <span class="hljs-keyword">if</span> (!(x &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))) <span class="hljs-comment">/* 如果仍然按下才打印 */</span><br>        &#123;<br>                x &amp;= <span class="hljs-number">0x3ff</span>;<br>                y &amp;= <span class="hljs-number">0x3ff</span>;<br>                <span class="hljs-comment">//打印10进制</span><br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;x = %08d, y = %08d\n\r&quot;</span>, x, y);<br>        &#125;<br>        <span class="hljs-built_in">enter_wait_pen_up_mode</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>烧写执行 发现X Y轴输出有问题</p>
<p><img src="/image/Chapter18_lesson6_007.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson6_007.png"></p>
<p>厂家把X　Y轴搞反了</p>
<p>电路图中</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">TSYP</span>　TSXP接反<br>TSYM　TSXM接反<br></code></pre></td></tr></table></figure>

<p><img src="/image/Chapter18_lesson6_008.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson6_008.png"></p>
<p>我们后面使用触摸屏时会使用软件处理这点，不会导致任何问题　</p>
<p>有一个缺点 我们按下触摸屏会输出一个数据，再按下触摸屏又输出一个数据 我长按并没有输出数据，我滑动也没有输出数据 我们需要使用定时器改进这个问题</p>
<p>各种方向的旋转都可以由软件转换</p>
<p><img src="/image/Chapter18_lesson6_009.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson6_009.png"></p>
<p>我们需要把触摸屏的坐标TS　XY坐标转换成LCD的XY坐标 需要用应用程序做 我们常使用Tslib库来做，这些旋转倒置都没有问题</p>
<p><strong>第007节_触摸屏编程_定时器程序优化</strong></p>
<hr>
<ul>
<li>有一个缺点</li>
<li>我们按下触摸屏会输出一个数据，再按下触摸屏又输出一个数据</li>
<li>我长按并没有输出数据，我滑动也没有输出数据</li>
<li>我们需要使用定时器改进这个问题</li>
</ul>
<p>这个处理流程是怎么样的？</p>
<ul>
<li>按下期间启动定时器 </li>
<li>定时器每过10ms &#x2F; 20ms就中断一次</li>
<li>在中断函数里测量触电的XY坐标</li>
<li>这样就可以得到连续的数据</li>
</ul>
<p>打开定时器Timer.c</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;s3c2440_soc.h&quot;</span></span><br><br><span class="hljs-comment">//定义一个宏 TIMER_NUM = 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TIMER_NUM  32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NULL  ((void *)0)</span><br><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*timer_func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br><br><span class="hljs-comment">//定义一个结构体 ，既存放有函数指针又存放有数据</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timer_desc</span> &#123;<br>        <span class="hljs-type">char</span> *name;<br>        timer_func fp;&#125;timer_desc, *p_timer_desc;<br><br><span class="hljs-comment">//我们需要往这个结构体数组里面添加函数，注册Timer函数</span><br>timer_desc timer_array[TIMER_NUM];<br><br><span class="hljs-comment">//注册Timer函数</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">register_timer</span><span class="hljs-params">(<span class="hljs-type">char</span> *name, timer_func fp)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">int</span> i;<br><span class="hljs-comment">//搜索这个数组，如果fp等于0的话，就表示没有占用这个数组项，我就把它填充进去</span><br><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; TIMER_NUM; i++)<br>        &#123;<br>                <span class="hljs-keyword">if</span> (!timer_array[i].fp)<br>                &#123;        <br>                         [i].name = name;<br>                        timer_array[i].fp   = fp;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//注册成功</span><br>                &#125;<br>        &#125;<br>        <span class="hljs-comment">//否则，表示已经满了，注册失败</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们不需要使用Timer定时器的时候unregister_timer函数, 考虑到我们需要从数组里面把这个Timer去掉，我们怎么找到这个Timer？</p>
<p>传入一个函数指针，以后卸载使用名字找到对应的项.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unregister_timer</span><span class="hljs-params">(<span class="hljs-type">char</span> *name)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">//对于unregister_timer就反过来操作，遍历每一项</span><br>        <span class="hljs-type">int</span> i;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; TIMER_NUM; i++)<br>        &#123;<br>        <span class="hljs-comment">//如果这个数组项里面的名字等于我传进来我名字</span><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(timer_array[i].name, name))<br>                &#123;<br>        <span class="hljs-comment">//也就表示我找到了这两项，设置成NULL</span><br>                        timer_array[i].name = <span class="hljs-literal">NULL</span>;<br>                        timer_array[i].fp   = <span class="hljs-literal">NULL</span>;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>                &#125;<br>        &#125;<br>        <span class="hljs-comment">//否则return -1;找不到选择的项</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>应该让其从某个数组里面把需要定时器处理的函数依次执行，这样做，我们以后添加定时器处理函数时就不需要修改Timer.c</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">void timer_ir<span class="hljs-string">q(void)</span><br>&#123;<br>        <span class="hljs-keyword">int</span> i;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; TIMER_NUM; i++)<br>        &#123;<br>        <span class="hljs-regexp">//</span>判断指针是否为空，如果不是空的话就继续执行timer_array[i].fp();这个函数<br>                <span class="hljs-keyword">if</span> (timer_array[i].fp)<br>                &#123;<br>                        timer_array[i].fp();<br>                &#125;<br>        &#125;        <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果想继续点灯的话，需要单独注册led_timer_irq 在led.c文件里注册led_timer_irq 把这个函数放在led_timer_irq函数下面，防止编译错误,每10ms改函数被调用一次.</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">led_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">/* 设置GPFCON让GPF4/5/6配置为输出引脚 */</span><br>        GPFCON &amp;= ~((<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">8</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">10</span>) | (<span class="hljs-number">3</span>&lt;&lt;<span class="hljs-number">12</span>));<br>        GPFCON |=  ((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">8</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">10</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">12</span>));<br>    <span class="hljs-comment">//led是名字，led_timer_irq是函数指针</span><br>        <span class="hljs-built_in">register_timer</span>(<span class="hljs-string">&quot;led&quot;</span>, led_timer_irq);<br>&#125;<br><br><span class="hljs-comment">/* 每10ms该函数被调用一次  </span><br><span class="hljs-comment"> * 每500ms操作一下LED实现计数 </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">led_timer_irq</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">/* 点灯计数 */</span><br>        <span class="hljs-type">static</span> <span class="hljs-type">int</span> timer_num = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> tmp;<br><br>        timer_num++;<br>        <span class="hljs-keyword">if</span> (timer_num &lt; <span class="hljs-number">50</span>)<br>                <span class="hljs-keyword">return</span>;<br>        timer_num = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//操作led</span><br>        cnt++;<br><br>        tmp = ~cnt;<br>        tmp &amp;= <span class="hljs-number">7</span>;<br>        GPFDAT &amp;= ~(<span class="hljs-number">7</span>&lt;&lt;<span class="hljs-number">4</span>);<br>        GPFDAT |= (tmp&lt;&lt;<span class="hljs-number">4</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改main.c</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs scss">int <span class="hljs-selector-tag">main</span>(void)<br>&#123;<br>        <span class="hljs-built_in">led_init</span>();<span class="hljs-comment">//初始化led</span><br>        <span class="hljs-comment">//interrupt_init();    /* 初始化中断控制器 */</span><br>        <span class="hljs-built_in">key_eint_init</span>();       <span class="hljs-comment">/* 初始化按键, 设为中断源 */</span><br>        <span class="hljs-built_in">timer_init</span>();<span class="hljs-comment">//打开定时器</span><br>        <br>        <span class="hljs-built_in">puts</span>(&quot;\n\rg_A = &quot;);<br>        <span class="hljs-built_in">printHex</span>(g_A);<br>        <span class="hljs-built_in">puts</span>(&quot;\n\r&quot;);<br><br>        <span class="hljs-comment">//nor_flash_test();</span><br>        <span class="hljs-built_in">lcd_test</span>();<br><br>        <span class="hljs-comment">//adc_test();</span><br><br>        <span class="hljs-built_in">touchscreen_test</span>();<br><br>        while (<span class="hljs-number">1</span>);<br>        <br>        return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改timer.c文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">void timer_init(void)<br>&#123;<br>        <span class="hljs-regexp">/* 设置TIMER0的时钟 修改时钟频录让其10ms中断一次 */</span><br>        <span class="hljs-regexp">/* Timer clk = PCLK /</span> &#123;prescaler value+<span class="hljs-number">1</span>&#125; / &#123;divider value&#125;<br>                     = <span class="hljs-number">50000000</span><span class="hljs-regexp">/(49+1)/</span><span class="hljs-number">16</span>              <br>                     = <span class="hljs-number">62500</span>  <br>        */<br>        TCFG0 = <span class="hljs-number">49</span>;  <span class="hljs-regexp">/* Prescaler 0 = 49, 用于timer0,1 */</span><br>        TCFG1 &amp;= ~<span class="hljs-number">0</span>xf;<br>        TCFG1 |= <span class="hljs-number">3</span>;  <span class="hljs-regexp">/* MUX0 : 1/</span><span class="hljs-number">16</span> */<br><br>        <span class="hljs-regexp">/* 设置TIMER0的初值 */</span><br>        TCNTB0 = <span class="hljs-number">625</span>;  <span class="hljs-regexp">/* 10Ms中断一次 */</span><br><br>        <span class="hljs-regexp">/* 加载初值, 启动timer0 */</span><br>        TCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);   <span class="hljs-regexp">/* Update from TCNTB0 &amp; TCMPB0 */</span><br><br>        <span class="hljs-regexp">/* 设置为自动加载并启动 */</span><br>        TCON &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">1</span>);<br>        TCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>);  <span class="hljs-regexp">/* bit0: start, bit3: auto reload */</span><br><br>        <span class="hljs-regexp">/* 设置中断 */</span><br>        register_irq(<span class="hljs-number">10</span>, timer_irq);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>烧写到nandflash发现无输出，可能是前重定位前的代码超出了4k，所以我们使用Norflash启动,发现可以正常运行</p>
<p>我们修改Makefile把负责重定位代码往前移，其他无关代码往后放,接着看star.S</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">.text</span><br><span class="hljs-symbol">.global</span> _start<br><br><span class="hljs-symbol">_start:</span><br>        <span class="hljs-keyword">b</span> reset                    <span class="hljs-comment">/* vector 0 : reset */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, und_addr           <span class="hljs-comment">/* vector 4 : und */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, swi_addr           <span class="hljs-comment">/* vector 8 : swi */</span><br>        <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x0c : prefetch aboot */</span><br>        <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x10 : data abort */</span><br>        <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x14 : reserved */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, irq_addr           <span class="hljs-comment">/* vector 0x18 : irq */</span><br>        <span class="hljs-keyword">b</span> halt                     <span class="hljs-comment">/* vector 0x1c : fiq */</span><br><br><span class="hljs-comment">//我们需要把这些异常往后放</span><br><span class="hljs-symbol">und_addr:</span><br>        <span class="hljs-meta">.word</span> do_und<br><br><span class="hljs-symbol">swi_addr:</span><br>        <span class="hljs-meta">.word</span> do_swi<br><br><span class="hljs-symbol">irq_addr:</span><br>        <span class="hljs-meta">.word</span> do_irq<br><br><span class="hljs-symbol">reset:</span><br>        <span class="hljs-comment">/* 关闭看门狗 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x53000000</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">=0</span><br>        <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br>        <br>        <span class="hljs-comment">/* 设置MPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */</span><br>        <span class="hljs-comment">/* LOCKTIME(0x4C000000) = 0xFFFFFFFF */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x4C000000</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">=0xFFFFFFFF</span><br>        <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>        <span class="hljs-comment">/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x4C000014</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">=0x5</span><br>        <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>        <span class="hljs-comment">/* 设置CPU工作于异步模式 */</span><br>        <span class="hljs-keyword">mrc</span> <span class="hljs-built_in">p15</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">r0</span>,<span class="hljs-built_in">c1</span>,<span class="hljs-built_in">c0</span>,<span class="hljs-number">0</span><br>        <span class="hljs-keyword">orr</span> <span class="hljs-built_in">r0</span>,<span class="hljs-built_in">r0</span>,<span class="hljs-number">#0xc0000000</span>   <span class="hljs-comment">//R1_nF:OR:R1_iA</span><br>        mcr <span class="hljs-built_in">p15</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">r0</span>,<span class="hljs-built_in">c1</span>,<span class="hljs-built_in">c0</span>,<span class="hljs-number">0</span><br><br>        <span class="hljs-comment">/* 设置MPLLCON(0x4C000004) = (92&lt;&lt;12)|(1&lt;&lt;4)|(1&lt;&lt;0)   </span><br><span class="hljs-comment">         *  m = MDIV+8 = 92+8=100  </span><br><span class="hljs-comment">         *  p = PDIV+2 = 1+2 = 3  </span><br><span class="hljs-comment">         *  s = SDIV = 1  </span><br><span class="hljs-comment">         *  FCLK = 2*m*Fin/(p*2^s) = 2*100*12/(3*2^1)=400M  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, <span class="hljs-number">=0x4C000004</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r1</span>, =(<span class="hljs-number">92</span>&lt;&lt;<span class="hljs-number">12</span>)<span class="hljs-title">|(1&lt;&lt;4)|</span>(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r0</span>]<br><br>        <span class="hljs-comment">/* 一旦设置PLL, 就会锁定lock time直到PLL输出稳定  </span><br><span class="hljs-comment">         * 然后CPU工作于新的频率FCLK  </span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/* 设置内存: sp 栈 */</span><br>        <span class="hljs-comment">/* 分辨是nor/nand启动  </span><br><span class="hljs-comment">         * 写0到0地址, 再读出来  </span><br><span class="hljs-comment">         * 如果得到0, 表示0地址上的内容被修改了, 它对应ram, 这就是nand启动  </span><br><span class="hljs-comment">         * 否则就是nor启动  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-number">#0</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>] <span class="hljs-comment">/* 读出原来的值备份 */</span><br>        <span class="hljs-keyword">str</span> <span class="hljs-built_in">r1</span>, [<span class="hljs-built_in">r1</span>] <span class="hljs-comment">/* 0-&gt;[0] */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">r2</span>, [<span class="hljs-built_in">r1</span>] <span class="hljs-comment">/* r2=[0] */</span><br>        <span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">r2</span>   <span class="hljs-comment">/* r1==r2? 如果相等表示是NAND启动 */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x40000000</span>+<span class="hljs-number">4096</span> <span class="hljs-comment">/* 先假设是nor启动 */</span><br>        <span class="hljs-keyword">moveq</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">#4096</span>  <span class="hljs-comment">/* nand启动 */</span><br>         <span class="hljs-keyword">streq</span> <span class="hljs-built_in">r0</span>, [<span class="hljs-built_in">r1</span>]   <span class="hljs-comment">/* 恢复原来的值 */</span><br><br>        <span class="hljs-keyword">bl</span> sdram_init<br>        <span class="hljs-comment">//bl sdram_init2  /* 用到有初始值的数组, 不是位置无关码 */</span><br><br>        <span class="hljs-comment">/* 重定位text, rodata, data段整个程序 */</span><br>        <span class="hljs-keyword">bl</span> copy2sdram<br><br>        <span class="hljs-comment">/* 清除BSS段 */</span><br>        <span class="hljs-keyword">bl</span> clean_bss<br><br>        <span class="hljs-comment">/* 复位之后, cpu处于svc模式  </span><br><span class="hljs-comment">         * 现在, 切换到usr模式  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">mrs</span> <span class="hljs-built_in">r0</span>, <span class="hljs-keyword">cpsr</span>         <span class="hljs-comment">/* 读出cpsr */</span><br>        <span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, <span class="hljs-number">#0xf</span>     <span class="hljs-comment">/* 修改M4-M0为0b10000, 进入usr模式 */</span><br>        <span class="hljs-keyword">bic</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">r0</span>, #(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>)  <span class="hljs-comment">/* 清除I位, 使能中断 */</span><br>        <span class="hljs-keyword">msr</span> cpsr, <span class="hljs-built_in">r0</span><br><br>        <span class="hljs-comment">/* 设置 sp_usr */</span><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">sp</span>, <span class="hljs-number">=0x33f00000</span><br><br>        <span class="hljs-keyword">ldr</span> <span class="hljs-built_in">pc</span>, <span class="hljs-symbol">=sdram</span><br><span class="hljs-symbol">sdram:</span><br>        <span class="hljs-keyword">bl</span> uart0_init<br><br>        <span class="hljs-keyword">bl</span> print1<br>        <span class="hljs-comment">/* 故意加入一条未定义指令 */</span><br></code></pre></td></tr></table></figure>

<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">init.c 需要放在前面<br>nand<span class="hljs-emphasis">_init</span><br><span class="hljs-emphasis">sdram_</span>init初始化也放前面<br>sdram:<br></code></pre></td></tr></table></figure>

<p>bl uart0_init</p>
<p>这就跳到sdram了，重定位后就随便操作</p>
<p>修改Makefile 我们把 start.o init.o nand_flash.o放在最前面</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs makefile">objs = start.o init.o nand_flash.o led.o uart.o main.o exception.o interrupt.o timer.o nor_flash.o my_printf.o string_utils.o lib1funcs.o<br><br>objs += lcd/font.o<br>objs += lcd/framebuffer.o<br>objs += lcd/geometry.o<br>objs += lcd/lcd.o<br>objs += lcd/lcd_4.3.o<br>objs += lcd/lcd_controller.o<br>objs += lcd/lcd_test.o<br>objs += lcd/s3c2440_lcd_controller.o<br>objs += lcd/font_8x16.o<br><br>objs += adc_touchscreen/adc.o<br>objs += adc_touchscreen/adc_test.o<br><br>objs += adc_touchscreen/touchscreen.o<br>objs += adc_touchscreen/touchscreen_test.o<br><br><span class="hljs-section">all: <span class="hljs-variable">$(objs)</span></span><br>        <span class="hljs-comment">#arm-linux-ld -Ttext 0 -Tdata 0x30000000  start.o led.o uart.o init.o main.o -o sdram.elf</span><br>        arm-linux-ld -T sdram.lds <span class="hljs-variable">$^</span> libgcc.a -o sdram.elf<br>        arm-linux-objcopy -O binary -S sdram.elf sdram.bin<br>        arm-linux-objdump -D sdram.elf &gt; sdram.dis<br><span class="hljs-section">clean:</span><br>        rm -f *.bin <span class="hljs-variable">$(objs)</span> *.elf *.dis<br>        <br>%.o : %.c<br>        arm-linux-gcc -march=armv4 -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$&lt;</span><br><br>%.o : %.S<br>        arm-linux-gcc -march=armv4 -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$&lt;</span><br></code></pre></td></tr></table></figure>

<p>这节课讲定时器的优化, 下节课讲怎么使用定时器来改进触摸屏</p>
<p><strong>第008节_触摸屏编程_使用定时器支持长按</strong></p>
<hr>
<p>可以使用定时器把长按或者滑动触摸屏的值读出来,我们按下触摸屏就会产生触摸屏中断，这个时候可以启动ADC,ADC成功后再次产生中段,在这个中断中启动定时器,我们也可以在触摸屏中断里启动定时器.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../s3c2440_soc.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADC_INT_BIT (10)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_INT_BIT  (9)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INT_ADC_TC   (31)</span><br><br><span class="hljs-comment">/* ADCTSC&#x27;s bits */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WAIT_PEN_DOWN    (0&lt;&lt;8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WAIT_PEN_UP      (1&lt;&lt;8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> YM_ENABLE        (1&lt;&lt;7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> YM_DISABLE       (0&lt;&lt;7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> YP_ENABLE        (0&lt;&lt;6)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> YP_DISABLE       (1&lt;&lt;6)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XM_ENABLE        (1&lt;&lt;5)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XM_DISABLE       (0&lt;&lt;5)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XP_ENABLE        (0&lt;&lt;4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XP_DISABLE       (1&lt;&lt;4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PULLUP_ENABLE    (0&lt;&lt;3)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PULLUP_DISABLE   (1&lt;&lt;3)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AUTO_PST         (1&lt;&lt;2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WAIT_INT_MODE    (3)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NO_OPR_MODE      (0)</span><br><br><span class="hljs-comment">//定义一个全局变量设置timer状态</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> g_ts_timer_enable = <span class="hljs-number">0</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adc_ts_int_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        SUBSRCPND = (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT);<br><span class="hljs-comment">//注册中断处理函数，才可以在处理函数中启动定时器</span><br><br>        <span class="hljs-comment">/* 注册中断处理函数 */</span><br>        <span class="hljs-built_in">register_irq</span>(<span class="hljs-number">31</span>, AdcTsIntHandle);<br><br>        <span class="hljs-comment">/* 使能中断 */</span><br>        INTSUBMSK &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT));<br>        <span class="hljs-comment">//INTMSK    &amp;= ~(1&lt;&lt;INT_ADC_TC);&#125;</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">touchscreen_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">/* 设置触摸屏接口:寄存器 */</span><br>        <span class="hljs-built_in">adc_ts_reg_init</span>();<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ADCUPDN = 0x%x, SUBSRCPND = 0x%x, SRCPND = 0x%x\n\r&quot;</span>, ADCUPDN, SUBSRCPND, SRCPND);<br><br>        <span class="hljs-comment">/* 设置中断 */</span><br>        <span class="hljs-built_in">adc_ts_int_init</span>();<br><br>        <span class="hljs-comment">/* 注册定时器处理函数 */</span><br>    <span class="hljs-comment">//首先是一个名字，其次是定时器处理函数</span><br>        <span class="hljs-built_in">register_timer</span>(<span class="hljs-string">&quot;touchscreen&quot;</span>, touchscreen_timer_irq);<br><br>        <span class="hljs-comment">/* 让触摸屏控制器进入&quot;等待中断模式&quot; */</span><br>        <span class="hljs-built_in">enter_wait_pen_down_mode</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进入touchscreen.c adc中断处理函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Isr_Adc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">int</span> x = ADCDAT0;<br>        <span class="hljs-type">int</span> y = ADCDAT1;<br><br>        <span class="hljs-keyword">if</span> (!(x &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))) <span class="hljs-comment">/* 如果仍然按下才打印 */</span><br>        &#123;<br>                x &amp;= <span class="hljs-number">0x3ff</span>;<br>                y &amp;= <span class="hljs-number">0x3ff</span>;<br>                <br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;x = %08d, y = %08d\n\r&quot;</span>, x, y);<br>    <span class="hljs-comment">//添加定时器函数</span><br>                <span class="hljs-comment">/* 启动定时器以再次读取数据 */</span><br>                <span class="hljs-built_in">ts_timer_enable</span>();<br>        &#125;<br>    <span class="hljs-comment">//松开操作</span><br>        <span class="hljs-keyword">else</span><br>        &#123;<br>                <span class="hljs-built_in">ts_timer_disable</span>();<br>                <span class="hljs-built_in">enter_wait_pen_down_mode</span>();<br>        &#125;<br>        <span class="hljs-built_in">enter_wait_pen_up_mode</span>();<br>&#125;<br><br><span class="hljs-comment">//触摸屏定时器处理函数</span><br><span class="hljs-comment">/* 每10ms该函数被调用一次  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">touchscreen_timer_irq</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">/* 如果触摸屏仍被按下, 进入&quot;自动测量模式&quot;, 启动ADC */</span><br>    <span class="hljs-comment">//如果定时器并没有被使能，则return</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">get_status_of_ts_timer</span>() == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span>;<br>    <span class="hljs-comment">//如果松开，则什么事情都不做</span><br>        <span class="hljs-keyword">if</span> (ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>)) <span class="hljs-comment">/* 如果松开 */</span><br>        &#123;<br>    <span class="hljs-comment">//设置定时器状态</span><br>                <span class="hljs-built_in">ts_timer_disable</span>();<br>    <span class="hljs-comment">//触摸笔进入等待模式</span><br>                <span class="hljs-built_in">enter_wait_pen_down_mode</span>();<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>    <span class="hljs-comment">//否则启动测量</span><br>        <span class="hljs-keyword">else</span>  <span class="hljs-comment">/* 按下状态，启动下一次测量 */</span><br>        &#123;<br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                <span class="hljs-built_in">enter_auto_measure_mode</span>();<br><br>                <span class="hljs-comment">/* 启动ADC */</span><br>                ADCCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ts_timer_enable</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//我们使用定时器时把它的状态设置为1</span><br>        g_ts_timer_enable = <span class="hljs-number">1</span>;<br>&#125;<br><br>    <span class="hljs-comment">//有启用定时器就有关闭定时器</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ts_timer_disable</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//我们不使用定时器把定时器状态设置为0</span><br>        g_ts_timer_enable = <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//我们如何获取定时器状态？</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">get_status_of_ts_timer</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//返回定时器状态</span><br>        <span class="hljs-keyword">return</span> g_ts_timer_enable;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们回顾一下处理过程，根据流程图分析</p>
<ul>
<li>首先从main.c函数开始</li>
</ul>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs scss">int <span class="hljs-selector-tag">main</span>(void)<br>&#123;<br>        <span class="hljs-built_in">led_init</span>();<br>        <span class="hljs-comment">//interrupt_init();  /* 初始化中断控制器 */</span><br>        <span class="hljs-built_in">key_eint_init</span>();     <span class="hljs-comment">/* 初始化按键, 设为中断源 */</span><br>        <span class="hljs-built_in">timer_init</span>();<br>        <br>        <span class="hljs-built_in">puts</span>(&quot;\n\rg_A = &quot;);<br>        <span class="hljs-built_in">printHex</span>(g_A);<br>        <span class="hljs-built_in">puts</span>(&quot;\n\r&quot;);<br>        <span class="hljs-comment">//nor_flash_test();</span><br>        <span class="hljs-built_in">lcd_test</span>();<br>        <span class="hljs-comment">//adc_test();</span><br>           <span class="hljs-comment">//执行touchscreen_test</span><br>        <span class="hljs-built_in">touchscreen_test</span>();<br>        while (<span class="hljs-number">1</span>);<br>        <br>        return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进入touchscreen_test.c文件执行init初始化程序</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">void</span> <span class="hljs-title function_">touchscreen_test</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>        <span class="hljs-title function_">touchscreen_init</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进入touchscreen.c文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs awk">void touchscreen_init(void)<br>&#123;<br>        <span class="hljs-regexp">/* 设置触摸屏接口:寄存器 */</span><br>        adc_ts_reg_init();<br><br>        printf(<span class="hljs-string">&quot;ADCUPDN = 0x%x, SUBSRCPND = 0x%x, SRCPND = 0x%x\n\r&quot;</span>, ADCUPDN, SUBSRCPND, SRCPND);<br><br>        <span class="hljs-regexp">/* 设置中断 */</span><br>        adc_ts_int_init();<br><br>        <span class="hljs-regexp">/* 让触摸屏控制器进入&quot;等待中断模式&quot; */</span><br>        enter_wait_pen_down_mode();<br>&#125;<br><br>void adc_ts_reg_init(void)<br>&#123;<br>        <span class="hljs-regexp">/* [15] : ECFLG,  1 = End of A/</span>D conversion  <br>         * [<span class="hljs-number">14</span>] : PRSCEN, <span class="hljs-number">1</span> = A/D converter prescaler enable  <br>         * [<span class="hljs-number">13</span>:<span class="hljs-number">6</span>]: PRSCVL, adc clk = PCLK / (PRSCVL + <span class="hljs-number">1</span>)  <br>         * [<span class="hljs-number">5</span>:<span class="hljs-number">3</span>] : SEL_MUX, <span class="hljs-number">000</span> = AIN <span class="hljs-number">0</span>  * [<span class="hljs-number">2</span>]   : STDBM  <br>         * [<span class="hljs-number">0</span>]   : <span class="hljs-number">1</span> = A/D conversion starts and this bit is cleared after the startup.  <br>         */<br>        ADCCON = (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">14</span>) | (<span class="hljs-number">49</span>&lt;&lt;<span class="hljs-number">6</span>) | (<span class="hljs-number">0</span>&lt;&lt;<span class="hljs-number">3</span>);<br><br>        /*  按下触摸屏, 延时一会再发出TC中断  <br>         *  延时时间 = ADCDLY <br>         * 晶振周期 = ADCDLY <br>         * <span class="hljs-number">1</span> / <span class="hljs-number">12000000</span> = <span class="hljs-number">5</span>ms  <br>         */<br>        ADCDLY = <span class="hljs-number">60000</span>;      <br>&#125;<br><br><span class="hljs-regexp">//</span>进入adc触摸屏中断处理<br>void adc_ts_int_init(void)<br>&#123;<br>        SUBSRCPND = (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT);<br><br>        <span class="hljs-regexp">/* 注册中断处理函数 */</span><br>        register_irq(<span class="hljs-number">31</span>, AdcTsIntHandle);<br><br>        <span class="hljs-regexp">/* 使能中断 */</span><br>        INTSUBMSK &amp;= ~((<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT));<br>        <span class="hljs-regexp">//</span>INTMSK    &amp;= ~(<span class="hljs-number">1</span>&lt;&lt;INT_ADC_TC);<br>&#125;<br><br>void AdcTsIntHandle(int irq)<br>&#123;<br>        <span class="hljs-keyword">if</span> (SUBSRCPND &amp; (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT))  <span class="hljs-regexp">/* 如果是触摸屏中断 */</span><br>                Isr_Tc();<br><br>        <span class="hljs-keyword">if</span> (SUBSRCPND &amp; (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT))  <span class="hljs-regexp">/* ADC中断 */</span><br>                Isr_Adc();<br>        SUBSRCPND = (<span class="hljs-number">1</span>&lt;&lt;TC_INT_BIT) | (<span class="hljs-number">1</span>&lt;&lt;ADC_INT_BIT);<br>&#125;<br><br><span class="hljs-regexp">//</span>进入触摸屏处理函数<br><span class="hljs-regexp">//</span>触摸屏定时器处理函数<br><span class="hljs-regexp">/* 每10ms该函数被调用一次  */</span><br>void touchscreen_timer_irq(void)<br>&#123;<br>        <span class="hljs-regexp">/* 如果触摸屏仍被按下, 进入&quot;自动测量模式&quot;, 启动ADC */</span><br>    <span class="hljs-regexp">//</span>如果定时器并没有被使能，则return<br>        <span class="hljs-keyword">if</span> (get_status_of_ts_timer() == <span class="hljs-number">0</span>)<br>                return;<br>    <span class="hljs-regexp">//</span>如果松开，则什么事情都不做<br>        <span class="hljs-keyword">if</span> (ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>)) <span class="hljs-regexp">/* 如果松开 */</span><br>        &#123;<br>    <span class="hljs-regexp">//</span>设置定时器状态<br>                ts_timer_disable();<br>    <span class="hljs-regexp">//</span>触摸笔进入等待模式<br>                enter_wait_pen_down_mode();<br>                return;<br>        &#125;<br><br>    <span class="hljs-regexp">//</span>否则启动测量<br>        <span class="hljs-keyword">else</span>  <span class="hljs-regexp">/* 按下状态，启动下一次测量 */</span><br>        &#123;<br>                <span class="hljs-regexp">/* 进入&quot;自动测量&quot;模式 */</span><br>                enter_auto_measure_mode();<br><br>                <span class="hljs-regexp">/* 启动ADC */</span><br>                ADCCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>第009节_触摸屏编程_较准原理</strong></p>
<hr>
<p>我们需要校准触摸屏，所谓校准就是找到一个公式把电压值转换为坐标值</p>
<p>触摸屏和LCD是两个东西,触摸屏覆盖在LCD上.</p>
<p><img src="/image/Chapter18_lesson9_001.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson9_001.png"></p>
<p><strong>问：得到触电的(x1,y1)怎么换算出LCD的坐标值 (X,Y)?</strong></p>
<p><img src="/image/Chapter18_lesson9_002.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson9_002.png"></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-keyword">x</span><span class="hljs-operator">=</span><span class="hljs-number">479</span><span class="hljs-number">-0</span>/<span class="hljs-keyword">x</span><span class="hljs-number">2</span>-<span class="hljs-keyword">x</span><span class="hljs-number">1</span> * (<span class="hljs-keyword">x</span><span class="hljs-number">3</span>-<span class="hljs-keyword">x</span><span class="hljs-number">1</span>) + <span class="hljs-number">0</span><br><span class="hljs-keyword">x</span><span class="hljs-operator">=</span>长度的比例<br><span class="hljs-keyword">x</span><span class="hljs-number">1</span> <span class="hljs-number">0</span> 原点的触摸屏/LCD坐标<br></code></pre></td></tr></table></figure>

<p>我们只需要确定两个点就可以把lcd坐标确定下来，但是我们可以做的更好</p>
<p>假设由于制作工艺问题，导致触摸屏和LCD坐标并不相同，需要其他公式计算</p>
<ul>
<li>X轴方向</li>
</ul>
<p><img src="/image/Chapter18_lesson9_003.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson9_003.png"></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-built_in">s1</span><span class="hljs-string">&#x27;是TS上X轴两个点的距离</span><br><span class="hljs-string">s1 是LCD上X轴两个点的距离</span><br><span class="hljs-string">s2&#x27;</span> <span class="hljs-built_in">s2</span><br></code></pre></td></tr></table></figure>

<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Kx= LCD距离/触摸屏距离<br><span class="hljs-section">= (s1 + s2) / (s1&#x27; + s2&#x27;)</span><br><span class="hljs-section">= 2s/(s1&#x27; + s2&#x27;)</span><br></code></pre></td></tr></table></figure>

<ul>
<li>Y轴方向</li>
</ul>
<p><img src="/image/Chapter18_lesson9_004.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson9_004.png"></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">TS</span>距离是<span class="hljs-built_in">d1</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">LCD距离是d1</span><br></code></pre></td></tr></table></figure>

<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Ky=(d1 <span class="hljs-code">+ d2) / (d1&#x27; +</span> d2&#x27;)<br><span class="hljs-section">= 2d / (d1&#x27; + d2&#x27;)</span><br></code></pre></td></tr></table></figure>

<p>我们现在有了斜率，给定一个坐标，我们需要需要原点的触屏LCD坐标</p>
<p>原点我们选在最中间 可以忽略掉上下左右的偏差</p>
<p><img src="/image/Chapter18_lesson9_005.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson9_005.png"></p>
<p>原点坐标在触摸屏上是xc’ yc’,在LCD上是 xc yc ,那我们的校准公式,对于给定的x3,我们如何求出x</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">X</span>= (x3 - xc<span class="hljs-string">&#x27; ) * Kx + xc</span><br></code></pre></td></tr></table></figure>

<p>对于给定的y’我们如何算出Y轴坐标？</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">y</span> = (y<span class="hljs-string">&#x27; - yc&#x27;</span>) * Ky + yc<br></code></pre></td></tr></table></figure>

<p>我们需要点击触摸屏上这5个点，同时需要把这五个点坐标打印显示出来.</p>
<p>这节视频我们讲的时校准原理</p>
<p><strong>第010节_触摸屏编程_较准与画线编</strong></p>
<hr>
<p>这个程序我们怎么写</p>
<p><img src="/image/Chapter18_lesson9_005.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson9_005.png"></p>
<p>我们需要得到这5个点的坐标 给这5个点分别设置为ABCDE</p>
<p>第一步</p>
<ul>
<li>在A点显示 +</li>
<li>客户点击 +</li>
<li>记录触摸屏的坐标</li>
<li>在BCDE上循环操作,显示点击读取的操作</li>
</ul>
<p>第二步</p>
<ul>
<li>根据这些数据，确定公式</li>
</ul>
<p>第三步</p>
<ul>
<li>以后得到TS触点时，可转换出LCD坐标</li>
</ul>
<p>我们需要实现这几个函数</p>
<p>显示 + 在x y 中显示 fb_disp_cross(int x , int y)</p>
<p>如何记录 ts_read_raw ,读到原始数据,根据这些数据，确定公式 ts_calibrate</p>
<p><strong>如何转换出LCD坐标?</strong></p>
<p>ts_read</p>
<p>我们实现这几个函数</p>
<ul>
<li><p>我们先实现 +</p>
</li>
<li><p>我们既然画线就在geometry.c中实现</p>
</li>
</ul>
<p><img src="/image/Chapter18_lesson10_002.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson10_002.png"></p>
<p>画十字架, 原点x,y</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">x</span>-<span class="hljs-number">10</span> y<br><span class="hljs-attribute">x</span>+<span class="hljs-number">10</span> y<br><span class="hljs-attribute">x</span> y+<span class="hljs-number">10</span><br><span class="hljs-attribute">x</span> y+<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void fb<span class="hljs-constructor">_disp_cross(<span class="hljs-params">int</span> <span class="hljs-params">x</span>, <span class="hljs-params">int</span> <span class="hljs-params">y</span>, <span class="hljs-params">unsigned</span> <span class="hljs-params">int</span> <span class="hljs-params">color</span>)</span><br>&#123;<br>        draw<span class="hljs-constructor">_line(<span class="hljs-params">x</span>-10, <span class="hljs-params">y</span>, <span class="hljs-params">x</span>+10, <span class="hljs-params">y</span>, <span class="hljs-params">color</span>)</span>;<br>        draw<span class="hljs-constructor">_line(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>-10, <span class="hljs-params">x</span>, <span class="hljs-params">y</span>+10, <span class="hljs-params">color</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编辑touchscreen.c</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//+ 坐标的x值</span><br>static <span class="hljs-built_in">int</span> g_ts_x;<br><span class="hljs-comment">//+ 坐标Y值</span><br>static <span class="hljs-built_in">int</span> g_ts_y;<br><br><span class="hljs-comment">//表示数据并未有效</span><br><span class="hljs-comment">//设置成volatile类型，有两个地方会用到一个是中断report_ts_xy</span><br><span class="hljs-comment">//另一个是程序ts_read_raw，我们一定确保这个值是从内存中读取出来</span><br><span class="hljs-comment">//让双方得到真实的值</span><br>static　volatile <span class="hljs-built_in">char</span> g_ts_data_valid = <span class="hljs-number">0</span>;<br><br>void <span class="hljs-constructor">Isr_Adc(<span class="hljs-params">void</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> x = ADCDAT0;<br>        <span class="hljs-built_in">int</span> y = ADCDAT1;<br><br>        <span class="hljs-keyword">if</span> (!(x &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))) <span class="hljs-comment">/* 如果仍然按下才打印 */</span><br>        &#123;<br>                x &amp;= <span class="hljs-number">0x3ff</span>;<br>                y &amp;= <span class="hljs-number">0x3ff</span>;<br>            <span class="hljs-comment">//我们现在不能打印               </span><br>                <span class="hljs-comment">//printf(&quot;x = %08d, y = %08d\n\r&quot;, x, y);</span><br>            <span class="hljs-comment">//实现report_ts_xy函数来打印</span><br>                report<span class="hljs-constructor">_ts_xy(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>)</span>;<br><br>                <span class="hljs-comment">/* 启动定时器以再次读取数据 */</span><br>                ts<span class="hljs-constructor">_timer_enable()</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>                ts<span class="hljs-constructor">_timer_disable()</span>;<br>                enter<span class="hljs-constructor">_wait_pen_down_mode()</span>;<br>        &#125;<br><br>        enter<span class="hljs-constructor">_wait_pen_up_mode()</span>;<br>&#125;<br><br><span class="hljs-comment">//report_ts_xy函数的实现</span><br><br>void report<span class="hljs-constructor">_ts_xy(<span class="hljs-params">int</span> <span class="hljs-params">x</span>, <span class="hljs-params">int</span> <span class="hljs-params">y</span>)</span><br>&#123;<br>        <span class="hljs-comment">//printf(&quot;x = %08d, y = %08d\n\r&quot;, x, y);</span><br>    <span class="hljs-comment">//一开始标记位=0表示没有数据</span><br>        <span class="hljs-keyword">if</span> (g_ts_data_valid<span class="hljs-operator"> == </span><span class="hljs-number">0</span>)<br>        &#123;<br>                g_ts_x = x;<br>                g_ts_y = y;<br>                g_ts_data_valid = <span class="hljs-number">1</span>;<br>        &#125;<br>&#125;<br><br><span class="hljs-comment">//读到原始数据</span><br>void ts<span class="hljs-constructor">_read_raw(<span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">px</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">py</span>)</span><br>&#123;<br>    <span class="hljs-comment">//当按下触摸屏时会产生ADC中断</span><br>        <span class="hljs-keyword">while</span> (g_ts_data_valid<span class="hljs-operator"> == </span><span class="hljs-number">0</span>);<br>        *px = g_ts_x;<br>        *py = g_ts_y;<br>    <span class="hljs-comment">//读完数据清零</span><br>        g_ts_data_valid = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下面我们实现ts_calibrate校准函数,在tslib.c文件中</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//设置斜率为全局变量</span><br>static double g_kx;<br>static double g_ky;<br>static <span class="hljs-built_in">int</span> g_ts_xc, g_ts_yc;<br>static <span class="hljs-built_in">int</span> g_lcd_xc, g_lcd_yc;<br><br><span class="hljs-comment">//加一个调换的全局变量</span><br>static <span class="hljs-built_in">int</span> g_ts_xy_swap = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">----------------------------</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|  +(A)              (B)+  |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|            +(E)          |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">|  +(D)              (C)+  |</span><br><span class="hljs-comment">|                          |</span><br><span class="hljs-comment">----------------------------</span><br><span class="hljs-comment">*/</span><br>把ABCDE这<span class="hljs-number">5</span>个点都实现<br><br>void ts<span class="hljs-constructor">_calibrate(<span class="hljs-params">void</span>)</span><br>&#123;<br>        unsigned <span class="hljs-built_in">int</span> fb_base;<br>        <span class="hljs-built_in">int</span> xres, yres, bpp;<br>    <span class="hljs-comment">//定义ABCDE触摸屏坐标</span><br>        <span class="hljs-built_in">int</span> a_ts_x, a_ts_y;<br>        <span class="hljs-built_in">int</span> b_ts_x, b_ts_y;<br>        <span class="hljs-built_in">int</span> c_ts_x, c_ts_y;<br>        <span class="hljs-built_in">int</span> d_ts_x, d_ts_y;<br>        <span class="hljs-built_in">int</span> e_ts_x, e_ts_y;<br><br>        <span class="hljs-comment">/* X轴方向 */</span><br>        <span class="hljs-built_in">int</span> ts_s1, ts_s2;<br>        <span class="hljs-built_in">int</span> lcd_s;<br><br>        <span class="hljs-comment">/* Y轴方向 */</span><br>        <span class="hljs-built_in">int</span> ts_d1, ts_d2;<br>        <span class="hljs-built_in">int</span> lcd_d;<br>    <span class="hljs-comment">//通过调用framebuffer.c里面的函数，来获取LCD坐标</span><br>        <span class="hljs-comment">/* 获得LCD的参数: fb_base, xres, yres, bpp */</span><br>        get<span class="hljs-constructor">_lcd_params(&amp;<span class="hljs-params">fb_base</span>, &amp;<span class="hljs-params">xres</span>, &amp;<span class="hljs-params">yres</span>, &amp;<span class="hljs-params">bpp</span>)</span>;<br><br>        <span class="hljs-comment">/* 对于ABCDE, 循环: 显示&quot;+&quot;、点击、读ts原始值 */</span><br>    <span class="hljs-comment">//A坐标，X分辨率50， Y分辨率50</span><br>        <span class="hljs-comment">/* A(50, 50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(50, 50, &amp;<span class="hljs-params">a_ts_x</span>, &amp;<span class="hljs-params">a_ts_y</span>)</span>;<br>    <span class="hljs-comment">//B坐标，X分辨率-50</span><br>        <span class="hljs-comment">/* B(xres-50, 50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">xres</span>-50, 50, &amp;<span class="hljs-params">b_ts_x</span>, &amp;<span class="hljs-params">b_ts_y</span>)</span>;<br>    <span class="hljs-comment">//C坐标，X分辨率-50，Y分辨率-50</span><br>        <span class="hljs-comment">/* C(xres-50, yres-50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">xres</span>-50, <span class="hljs-params">yres</span>-50, &amp;<span class="hljs-params">c_ts_x</span>, &amp;<span class="hljs-params">c_ts_y</span>)</span>;<br>    <span class="hljs-comment">//D坐标，X分辨率位置50，Y分辨率-50</span><br>        <span class="hljs-comment">/* D(50, yres-50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(50, <span class="hljs-params">yres</span>-50, &amp;<span class="hljs-params">d_ts_x</span>, &amp;<span class="hljs-params">d_ts_y</span>)</span>;<span class="hljs-comment">//E坐标，X分辨率除2，Y分辨率除2</span><br>        <span class="hljs-comment">/* E(xres/2, yres/2) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">xres</span><span class="hljs-operator">/</span>2, <span class="hljs-params">yres</span><span class="hljs-operator">/</span>2, &amp;<span class="hljs-params">e_ts_x</span>, &amp;<span class="hljs-params">e_ts_y</span>)</span>;<br>    <span class="hljs-comment">//读取XY坐标值后确定XY是否反转</span><br>        <span class="hljs-comment">/* 确定触摸屏数据XY是否反转 */</span><br>        g_ts_xy_swap = is<span class="hljs-constructor">_ts_xy_swap(<span class="hljs-params">a_ts_x</span>, <span class="hljs-params">a_ts_y</span>, <span class="hljs-params">b_ts_x</span>, <span class="hljs-params">b_ts_y</span>)</span>;<br>    <span class="hljs-comment">//如果反转，对调所有点的XY坐标</span><br>        <span class="hljs-keyword">if</span> (g_ts_xy_swap)<br>        &#123;<br>                <span class="hljs-comment">/* 对调所有点的XY坐标 */</span><br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">a_ts_x</span>, &amp;<span class="hljs-params">a_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">b_ts_x</span>, &amp;<span class="hljs-params">b_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">c_ts_x</span>, &amp;<span class="hljs-params">c_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">d_ts_x</span>, &amp;<span class="hljs-params">d_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">e_ts_x</span>, &amp;<span class="hljs-params">e_ts_y</span>)</span>;<br>        &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/Chapter18_lesson10_003.png" srcset="/img/loading.gif" lazyload alt="Chapter18_lesson10_003.png"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* 确定公式的参数并保存 */</span><br><span class="hljs-regexp">//</span>Ts_S1值=B点ts和A点tsX轴方向的距离<br>        ts_s1 = b_ts_x - a_ts_x;<br><span class="hljs-regexp">//</span>Ts_S2值<br>        ts_s2 = c_ts_x - d_ts_x;<br><span class="hljs-regexp">//</span>lcd_s值<br>        lcd_s = xres-<span class="hljs-number">50</span> - <span class="hljs-number">50</span>;<br><span class="hljs-regexp">//</span>ts_d1值<br>        ts_d1 = d_ts_y - a_ts_y;<br><span class="hljs-regexp">//</span>ts_d2值<br>        ts_d2 = c_ts_y - b_ts_y;<br><span class="hljs-regexp">//</span>lcd_d值<br>        lcd_d = yres-<span class="hljs-number">50</span>-<span class="hljs-number">50</span>;<br><span class="hljs-regexp">//</span>X轴的斜率<br>        g_kx = ((double)(<span class="hljs-number">2</span>*lcd_s)) / (ts_s1 + ts_s2);<br><span class="hljs-regexp">//</span>Y轴的斜率<br>        g_ky = ((double)(<span class="hljs-number">2</span>*lcd_d)) / (ts_d1 + ts_d2);<br><br><span class="hljs-regexp">//</span>中心点E点的坐标<br>        g_ts_xc = e_ts_x;<br>        g_ts_yc = e_ts_y;<br>        g_lcd_xc = xres/<span class="hljs-number">2</span>;<br>        g_lcd_yc = yres/<span class="hljs-number">2</span>;&#125;<br></code></pre></td></tr></table></figure>

<p>我们需要把 + 在LCD上显示出来并且读出数据</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">int</span> <span class="hljs-params">lcd_x</span>, <span class="hljs-params">int</span> <span class="hljs-params">lcd_y</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">px</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">py</span>)</span><br>&#123;<br>        fb<span class="hljs-constructor">_disp_cross(<span class="hljs-params">lcd_x</span>, <span class="hljs-params">lcd_y</span>, 0xffffff)</span>;<br><br>        <span class="hljs-comment">/* 等待点击 */</span><br><br>        ts<span class="hljs-constructor">_read_raw(<span class="hljs-params">px</span>, <span class="hljs-params">py</span>)</span>;<br>&#125;<br><span class="hljs-comment">//比如我们之前发现上报的X轴Y轴值反了</span><br><span class="hljs-comment">//比如正常情况下从A点移动到B点是x值变化比较大y值不变，但是目前的情况是y值变化比较大，x值不变</span><br><span class="hljs-comment">//我分根据这个特性分辨</span><br><br><span class="hljs-built_in">int</span> is<span class="hljs-constructor">_ts_xy_swap(<span class="hljs-params">int</span> <span class="hljs-params">a_ts_x</span>, <span class="hljs-params">int</span> <span class="hljs-params">a_ts_y</span>, <span class="hljs-params">int</span> <span class="hljs-params">b_ts_x</span>, <span class="hljs-params">int</span> <span class="hljs-params">b_ts_y</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> dx = b_ts_x - a_ts_x;<br>        <span class="hljs-built_in">int</span> dy = b_ts_y - a_ts_y;<br><span class="hljs-comment">//减出来的值有可能是负数，我们需要取绝对值</span><br>        <span class="hljs-keyword">if</span> (dx &lt; <span class="hljs-number">0</span>)<br>                dx = <span class="hljs-number">0</span> - dx;<br>        <span class="hljs-keyword">if</span> (dy &lt; <span class="hljs-number">0</span>)<br>                dy = <span class="hljs-number">0</span> - dy;<br><br>        <span class="hljs-keyword">if</span>(dx &gt; dy)<br>                return <span class="hljs-number">0</span>; <span class="hljs-comment">/* xy没有反转 */</span><br>        <span class="hljs-keyword">else</span><br>                return <span class="hljs-number">1</span>; <span class="hljs-comment">/* xy反了 */</span><br>&#125;<br><br><span class="hljs-comment">//如果是反的我们需要调换回来，我们需要确定XY是否反转</span><br><br><span class="hljs-comment">//我们写出一个对调函数</span><br>void swap<span class="hljs-constructor">_xy(<span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">px</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">py</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> tmp = *px;<br>        *px = *py;<br>        *py = tmp;<br>&#125;<br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * 读TS原始数据, 转换为LCD坐标 </span><br><span class="hljs-comment"> */</span><br>void ts<span class="hljs-constructor">_read(<span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">lcd_x</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">lcd_y</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> ts_x, ts_y;<br>        <br>        ts<span class="hljs-constructor">_read_raw(&amp;<span class="hljs-params">ts_x</span>, <span class="hljs-params">ts_y</span>)</span>;<br>        <span class="hljs-keyword">if</span> (g_ts_xy_swap)<br>        &#123;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">ts_x</span>, &amp;<span class="hljs-params">ts_y</span>)</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* 使用公式计算 */</span><br>    <span class="hljs-comment">//斜率 * (触摸屏坐标 - 中心点除，触摸屏坐标) + 中心点LCD坐标</span><br>        *lcd_x = g_kx<span class="hljs-operator"> * </span>(ts_x - g_ts_xc) + g_lcd_xc;<br>        *lcd_y = g_ky<span class="hljs-operator"> * </span>(ts_y - g_ts_yc) + g_lcd_yc;&#125;<br></code></pre></td></tr></table></figure>

<p>接下来我们画线, 我们在framebuffer.c中把清屏函数单独实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear_screen</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> color)</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">int</span> x, y;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p0;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *p;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *p2;<br><br>        <span class="hljs-comment">/* 往framebuffer中写数据 */</span><br>        <span class="hljs-keyword">if</span> (bpp == <span class="hljs-number">8</span>)<br>        &#123;<br>                <span class="hljs-comment">/* bpp: palette[color] */</span><br><br>                p0 = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)fb_base;<br>                <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; xres; x++)<br>                        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; yres; y++)<br>                                *p0++ = color;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bpp == <span class="hljs-number">16</span>)<br>        &#123;<br>                <span class="hljs-comment">/* 让LCD输出整屏的红色 */</span><br><br>                <span class="hljs-comment">/* 565: 0xf700 */</span><br><br>                p = (<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *)fb_base;<br>                <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; xres; x++)<br>                        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; yres; y++)<br>                                *p++ = <span class="hljs-built_in">convert32bppto16bpp</span>(color);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bpp == <span class="hljs-number">32</span>)<br>        &#123;<br>                p2 = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)fb_base;<br>                <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; xres; x++)<br>                        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; yres; y++)<br>                                *p2++ = color;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先显示一个一个点，让后显示开始校准提示， 校准完提示 ok draw</p>
<p>打开我们的 touchscreen_test.c文件</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void touchscreen<span class="hljs-constructor">_test(<span class="hljs-params">void</span>)</span><br>&#123;<br>        unsigned <span class="hljs-built_in">int</span> fb_base;<br>        <span class="hljs-built_in">int</span> xres, yres, bpp;<br><br>        <span class="hljs-built_in">int</span> x, y;<br><br>        <span class="hljs-comment">/* 获得LCD的参数: fb_base, xres, yres, bpp */</span><br>        get<span class="hljs-constructor">_lcd_params(&amp;<span class="hljs-params">fb_base</span>, &amp;<span class="hljs-params">xres</span>, &amp;<span class="hljs-params">yres</span>, &amp;<span class="hljs-params">bpp</span>)</span>;<br><br>        touchscreen<span class="hljs-constructor">_init()</span>;<br><br>        <span class="hljs-comment">/* 清屏 */</span><br>        clear<span class="hljs-constructor">_screen(0)</span>;<br>    <span class="hljs-comment">//我们在70像素的地方显示文字，背景白色显示文字</span><br>        <span class="hljs-comment">/* 显示文字提示较准 */</span><br>        fb<span class="hljs-constructor">_print_string(70, 70, <span class="hljs-string">&quot;Touc cross to calibrate touchscreen&quot;</span>, 0xffffff)</span>;<br>        ts<span class="hljs-constructor">_calibrate()</span>;<br><br>        <span class="hljs-comment">/* 显示文字提示绘画 */</span><br>        fb<span class="hljs-constructor">_print_string(70, <span class="hljs-params">yres</span> - 70, <span class="hljs-string">&quot;OK! To draw!&quot;</span>, 0xffffff)</span>;<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>        &#123;<br>                ts<span class="hljs-constructor">_read(&amp;<span class="hljs-params">x</span>, &amp;<span class="hljs-params">y</span>)</span>;<br>    <span class="hljs-comment">//我们先打印值</span><br>                printf(<span class="hljs-string">&quot; x = %d, y = %d\n\r&quot;</span>, x, y);<br>    <span class="hljs-comment">//描绿色的线</span><br>                fb<span class="hljs-constructor">_put_pixel(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>, 0xff00)</span>;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们添加了 tslib.c需要修改Makefile</p>
<p>添加objs +&#x3D; adc_touchscreen&#x2F;tslib.o</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs makefile">objs = start.o init.o nand_flash.o led.o uart.o main.o exception.o interrupt.o timer.o nor_flash.o my_printf.o string_utils.o lib1funcs.o<br>objs += lcd/font.o<br>objs += lcd/framebuffer.o<br>objs += lcd/geometry.o<br>objs += lcd/lcd.o<br>objs += lcd/lcd_4.3.o<br>objs += lcd/lcd_controller.o<br>objs += lcd/lcd_test.o<br>objs += lcd/s3c2440_lcd_controller.o<br>objs += lcd/font_8x16.o<br><br>objs += adc_touchscreen/adc.o<br>objs += adc_touchscreen/adc_test.o<br><br>objs += adc_touchscreen/touchscreen.o<br>objs += adc_touchscreen/touchscreen_test.o<br><br>objs += adc_touchscreen/tslib.o<br><br><span class="hljs-section">all: <span class="hljs-variable">$(objs)</span></span><br>        <span class="hljs-comment">#arm-linux-ld -Ttext 0 -Tdata 0x30000000  start.o led.o uart.o init.o main.o -o sdram.elf</span><br>        arm-linux-ld -T sdram.lds <span class="hljs-variable">$^</span> libgcc.a -o sdram.elf<br>        arm-linux-objcopy -O binary -S sdram.elf sdram.bin<br>        arm-linux-objdump -D sdram.elf &gt; sdram.dis<br><span class="hljs-section">clean:</span><br>        rm -f *.bin <span class="hljs-variable">$(objs)</span> *.elf *.dis<br>        <br>%.o : %.c<br>        arm-linux-gcc -march=armv4 -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$&lt;</span><br>%.o : %.S<br>        arm-linux-gcc -march=armv4 -c -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$&lt;</span><br></code></pre></td></tr></table></figure>

<p><strong>第011节_触摸屏编程_测试</strong></p>
<hr>
<ul>
<li>发现程序有bug,点击坐标一次，程序就完成执行,我们需要修改触摸屏文件tsib.c</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static double g_kx;<br>static double g_ky;<br><br>static <span class="hljs-built_in">int</span> g_ts_xc, g_ts_yc;<br>static <span class="hljs-built_in">int</span> g_lcd_xc, g_lcd_yc;<br>static <span class="hljs-built_in">int</span> g_ts_xy_swap = <span class="hljs-number">0</span>;<br><br>static unsigned <span class="hljs-built_in">int</span> fb_base;<br>static <span class="hljs-built_in">int</span> xres, yres, bpp;<br><br>void get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">int</span> <span class="hljs-params">lcd_x</span>, <span class="hljs-params">int</span> <span class="hljs-params">lcd_y</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">px</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">py</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> pressure;<br>        <span class="hljs-built_in">int</span> x, y;<br>        <br>        fb<span class="hljs-constructor">_disp_cross(<span class="hljs-params">lcd_x</span>, <span class="hljs-params">lcd_y</span>, 0xffffff)</span>;<br><br>        <span class="hljs-comment">/* 等待点击 */</span><br><br>        <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-comment">//如果pressure一直是0的话我们丢掉这些数据</span><br>                ts<span class="hljs-constructor">_read_raw(&amp;<span class="hljs-params">x</span>, &amp;<span class="hljs-params">y</span>, &amp;<span class="hljs-params">pressure</span>)</span>;<br>        &#125; <span class="hljs-keyword">while</span> (pressure<span class="hljs-operator"> == </span><span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">//让后再次读</span><br>        <span class="hljs-keyword">do</span> &#123;<br>                *px = x;<br>                *py = y;<br>                ts<span class="hljs-constructor">_read_raw(&amp;<span class="hljs-params">x</span>, &amp;<span class="hljs-params">y</span>, &amp;<span class="hljs-params">pressure</span>)</span>;<br>                printf(<span class="hljs-string">&quot;get raw data: x = %08d, y = %08d\n\r&quot;</span>, x, y);<br>        &#125; <span class="hljs-keyword">while</span> (pressure);<br>        <br>        printf(<span class="hljs-string">&quot;return raw data: x = %08d, y = %08d\n\r&quot;</span>, *px, *py);<br><br>        <span class="hljs-comment">/* 直到松开才返回 */</span><br>        fb<span class="hljs-constructor">_disp_cross(<span class="hljs-params">lcd_x</span>, <span class="hljs-params">lcd_y</span>, 0)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改touchcreen.c文件添加压力值相关信息</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//定义压力值全局变量</span><br>static <span class="hljs-built_in">int</span> g_ts_pressure;<br>void report<span class="hljs-constructor">_ts_xy(<span class="hljs-params">int</span> <span class="hljs-params">x</span>, <span class="hljs-params">int</span> <span class="hljs-params">y</span>, <span class="hljs-params">int</span> <span class="hljs-params">pressure</span>)</span>;<br><br><span class="hljs-comment">//发现不能画线，修改 ts_read</span><br><span class="hljs-comment">//我们需要判断触摸笔是按下还是松开，需要添加压力值参数</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 读TS原始数据, 转换为LCD坐标</span><br><span class="hljs-comment"> * 我们需要加上压力值lcd_pressure</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">int</span> ts<span class="hljs-constructor">_read(<span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">lcd_x</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">lcd_y</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">lcd_pressure</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> ts_x, ts_y, ts_pressure;<br>        <span class="hljs-built_in">int</span> tmp_x, tmp_y;<br>    <span class="hljs-comment">//添加压力值参数        </span><br>        ts<span class="hljs-constructor">_read_raw(&amp;<span class="hljs-params">ts_x</span>, &amp;<span class="hljs-params">ts_y</span>, &amp;<span class="hljs-params">ts_pressure</span>)</span>;<br><br>        <span class="hljs-keyword">if</span> (g_ts_xy_swap)<br>        &#123;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">ts_x</span>, &amp;<span class="hljs-params">ts_y</span>)</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* 使用公式计算 */</span><br>        tmp_x = g_kx<span class="hljs-operator"> * </span>(ts_x - g_ts_xc) + g_lcd_xc;<br>        tmp_y = g_ky<span class="hljs-operator"> * </span>(ts_y - g_ts_yc) + g_lcd_yc;<br><br>    <span class="hljs-comment">//如果值超出了LCD范围返回-1</span><br>        <span class="hljs-keyword">if</span> (tmp_x &lt; <span class="hljs-number">0</span><span class="hljs-operator"> || </span>tmp_x &gt;= xres<span class="hljs-operator"> || </span>tmp_y &lt; <span class="hljs-number">0</span><span class="hljs-operator"> || </span>tmp_y &gt;= yres)<br>                return -<span class="hljs-number">1</span>;<br>        <br>        *lcd_x = tmp_x;<br>        *lcd_y = tmp_y;<br>    <span class="hljs-comment">//压力值等于全局变量ts_pressure</span><br>        *lcd_pressure = ts_pressure;<br>        return <span class="hljs-number">0</span>;<br>&#125;<br><br>void ts<span class="hljs-constructor">_read_raw(<span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">px</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">py</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">ppressure</span>)</span><br>&#123;<br>        <span class="hljs-keyword">while</span> (g_ts_data_valid<span class="hljs-operator"> == </span><span class="hljs-number">0</span>);<br>        *px = g_ts_x;<br>        *py = g_ts_y;<br>        *ppressure = g_ts_pressure;<br>        g_ts_data_valid = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//我们需要report上报压力值数据</span><br>void report<span class="hljs-constructor">_ts_xy(<span class="hljs-params">int</span> <span class="hljs-params">x</span>, <span class="hljs-params">int</span> <span class="hljs-params">y</span>, <span class="hljs-params">int</span> <span class="hljs-params">pressure</span>)</span><br>&#123;<br>        <span class="hljs-comment">//printf(&quot;x = %08d, y = %08d\n\r&quot;, x, y);</span><br><br>        <span class="hljs-keyword">if</span> (g_ts_data_valid<span class="hljs-operator"> == </span><span class="hljs-number">0</span>)<br>        &#123;<br>                g_ts_x = x;<br>                g_ts_y = y;<br>                g_ts_pressure = pressure;<br>                g_ts_data_valid = <span class="hljs-number">1</span>;<br>        &#125;<br>&#125;<br><br>void <span class="hljs-constructor">Isr_Tc(<span class="hljs-params">void</span>)</span><br>&#123;<br>        <span class="hljs-comment">//printf(&quot;ADCUPDN = 0x%x, ADCDAT0 = 0x%x, ADCDAT1 = 0x%x, ADCTSC = 0x%x\n\r&quot;, ADCUPDN, ADCDAT0, ADCDAT1, ADCTSC);</span><br>        <br>        <span class="hljs-keyword">if</span> (ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))<br>        &#123;<br>                <span class="hljs-comment">//printf(&quot;pen up\n\r&quot;);</span><br><br>                enter<span class="hljs-constructor">_wait_pen_down_mode()</span>;<br>            <span class="hljs-comment">//如果松开就上报数据xy坐标00 压力值0</span><br>                report<span class="hljs-constructor">_ts_xy(0, 0, 0)</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>   <br>        &#123;<br>                <span class="hljs-comment">//printf(&quot;pen down\n\r&quot;);</span><br><br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                enter<span class="hljs-constructor">_auto_measure_mode()</span>;<br><br>                <span class="hljs-comment">/* 启动ADC */</span><br>                ADCCON <span class="hljs-pattern-match">|= (1&lt;&lt;0);</span><br><span class="hljs-pattern-match">        &#125;</span><br><span class="hljs-pattern-match">&#125;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">void <span class="hljs-constructor">Isr_Adc(<span class="hljs-params">void</span>)</span></span><br><span class="hljs-pattern-match">&#123;</span><br><span class="hljs-pattern-match">        <span class="hljs-built_in">int</span> x = <span class="hljs-constructor">ADCDAT0</span>;</span><br><span class="hljs-pattern-match">        <span class="hljs-built_in">int</span> y = <span class="hljs-constructor">ADCDAT1</span>;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">        static <span class="hljs-built_in">int</span> adc<span class="hljs-constructor">_cnt</span> = 0;</span><br><span class="hljs-pattern-match">        static <span class="hljs-built_in">int</span> adc<span class="hljs-constructor">_x</span> = 0;</span><br><span class="hljs-pattern-match">        static <span class="hljs-built_in">int</span> adc<span class="hljs-constructor">_y</span> = 0;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">        <span class="hljs-keyword">if</span> (!(x &amp; (1&lt;&lt;15))) <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 如果仍然按下才打印 <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">        &#123;</span><br><span class="hljs-pattern-match">#<span class="hljs-keyword">if</span> 0                      </span><br><span class="hljs-pattern-match">            x &amp;= 0x3ff;          </span><br><span class="hljs-pattern-match">            y &amp;= 0x3ff;</span><br><span class="hljs-pattern-match">                    </span><br><span class="hljs-pattern-match">            <span class="hljs-operator">/</span><span class="hljs-operator">/</span>printf(&quot;x = %08d, y = %08d\n\r&quot;, x, y);</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>当我得到触电数据以后，如果当前仍是按下状态，会上报<span class="hljs-constructor">XY</span>坐标值并且上报压力值，压力值等于1          </span><br><span class="hljs-pattern-match">            report<span class="hljs-constructor">_ts_xy(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>, 1)</span>;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">          <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 启动定时器以再次读取数据 <span class="hljs-operator">*</span><span class="hljs-operator">/</span>          </span><br><span class="hljs-pattern-match">            ts<span class="hljs-constructor">_timer_enable()</span>;</span><br><span class="hljs-pattern-match">#endif</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>防止数据在最后出现很大的误差</span><br><span class="hljs-pattern-match">                <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 第1次启动<span class="hljs-constructor">ADC</span>后:          </span><br><span class="hljs-pattern-match">                 <span class="hljs-operator">*</span>   a. 要连续启动<span class="hljs-constructor">N</span>次, 获得<span class="hljs-constructor">N</span>个数据, 求平均值并上报          </span><br><span class="hljs-pattern-match">                 <span class="hljs-operator">*</span>   b. 得到<span class="hljs-constructor">N</span>次数据后, 再启动<span class="hljs-constructor">TIMER</span>           </span><br><span class="hljs-pattern-match">                 <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>我们直接累加</span><br><span class="hljs-pattern-match">                adc<span class="hljs-constructor">_x</span> += (x &amp; 0x3ff);</span><br><span class="hljs-pattern-match">                adc<span class="hljs-constructor">_y</span> += (y &amp; 0x3ff);</span><br><span class="hljs-pattern-match">                adc<span class="hljs-constructor">_cnt</span><span class="hljs-operator">++</span>;</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>我们取16的话右移4位比较容易操作</span><br><span class="hljs-pattern-match">                <span class="hljs-keyword">if</span> (adc<span class="hljs-constructor">_cnt</span> <span class="hljs-operator">==</span> 16)</span><br><span class="hljs-pattern-match">                &#123;</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>右移4位</span><br><span class="hljs-pattern-match">                        adc<span class="hljs-constructor">_x</span> &gt;&gt;= 4;</span><br><span class="hljs-pattern-match">                        adc<span class="hljs-constructor">_y</span> &gt;&gt;= 4;</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>上报</span><br><span class="hljs-pattern-match">                        report<span class="hljs-constructor">_ts_xy(<span class="hljs-params">adc_x</span>, <span class="hljs-params">adc_y</span>, 1)</span>;</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>恢复到初始值0</span><br><span class="hljs-pattern-match">                        adc<span class="hljs-constructor">_cnt</span> = 0;</span><br><span class="hljs-pattern-match">                        adc<span class="hljs-constructor">_x</span> = 0;</span><br><span class="hljs-pattern-match">                        adc<span class="hljs-constructor">_y</span> = 0;</span><br><span class="hljs-pattern-match">                        </span><br><span class="hljs-pattern-match">                        <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 启动定时器以再次读取数据 <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">                        ts<span class="hljs-constructor">_timer_enable()</span>;</span><br><span class="hljs-pattern-match">                &#125;</span><br><span class="hljs-pattern-match">                <span class="hljs-keyword">else</span></span><br><span class="hljs-pattern-match">                &#123;</span><br><span class="hljs-pattern-match">                        <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 否则再次启动<span class="hljs-constructor">ADC</span> <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">                        <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 进入&quot;自动测量&quot;模式 <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">                        enter<span class="hljs-constructor">_auto_measure_mode()</span>;</span><br><span class="hljs-pattern-match">                        </span><br><span class="hljs-pattern-match">                        <span class="hljs-operator">/</span><span class="hljs-operator">*</span> 启动<span class="hljs-constructor">ADC</span> <span class="hljs-operator">*</span><span class="hljs-operator">/</span></span><br><span class="hljs-pattern-match">                        <span class="hljs-constructor">ADCCON</span> |= (1&lt;&lt;0);</span><br><span class="hljs-pattern-match">                &#125;</span><br><span class="hljs-pattern-match">        &#125;</span><br><span class="hljs-pattern-match">        <span class="hljs-keyword">else</span></span><br><span class="hljs-pattern-match">        &#123;</span><br><span class="hljs-pattern-match">                adc<span class="hljs-constructor">_cnt</span> = 0;</span><br><span class="hljs-pattern-match">                adc<span class="hljs-constructor">_x</span> = 0;</span><br><span class="hljs-pattern-match">                adc<span class="hljs-constructor">_y</span> = 0;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">                ts<span class="hljs-constructor">_timer_disable()</span>;</span><br><span class="hljs-pattern-match">                enter<span class="hljs-constructor">_wait_pen_down_mode()</span>;</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">/</span><span class="hljs-operator">/</span>如果数据转换完之前再次松开，这里我也会上报数据，0，0，0</span><br><span class="hljs-pattern-match">                report<span class="hljs-constructor">_ts_xy(0, 0, 0)</span>;</span><br><span class="hljs-pattern-match">        &#125;</span><br><span class="hljs-pattern-match">        enter<span class="hljs-constructor">_wait_pen_up_mode()</span>;</span><br><span class="hljs-pattern-match">&#125;</span><br></code></pre></td></tr></table></figure>

<p>那么我们的tslib.c中</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">int</span> <span class="hljs-params">lcd_x</span>, <span class="hljs-params">int</span> <span class="hljs-params">lcd_y</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">px</span>, <span class="hljs-params">int</span> <span class="hljs-operator">*</span><span class="hljs-params">py</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> pressure;<br>        <span class="hljs-built_in">int</span> x, y;<br>        <br>        fb<span class="hljs-constructor">_disp_cross(<span class="hljs-params">lcd_x</span>, <span class="hljs-params">lcd_y</span>, 0xffffff)</span>;<br><br>        <span class="hljs-comment">/* 等待点击 */</span><br><br>        <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-comment">//读取ts坐标值也加上压力值</span><br>                ts<span class="hljs-constructor">_read_raw(&amp;<span class="hljs-params">x</span>, &amp;<span class="hljs-params">y</span>, &amp;<span class="hljs-params">pressure</span>)</span>;<br>    <span class="hljs-comment">//直到压力等于0的时候才返回</span><br>        &#125; <span class="hljs-keyword">while</span> (pressure<span class="hljs-operator"> == </span><span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">do</span> &#123;<br>                *px = x;<br>                *py = y;<br>    <span class="hljs-comment">//压力值存在的情况下表示按下状态，就一直读取数据</span><br>                ts<span class="hljs-constructor">_read_raw(&amp;<span class="hljs-params">x</span>, &amp;<span class="hljs-params">y</span>, &amp;<span class="hljs-params">pressure</span>)</span>;<br>                printf(<span class="hljs-string">&quot;get raw data: x = %08d, y = %08d\n\r&quot;</span>, x, y);<br>        &#125; <span class="hljs-keyword">while</span> (pressure);<br>    <span class="hljs-comment">//打印坐标值</span><br>        printf(<span class="hljs-string">&quot;return raw data: x = %08d, y = %08d\n\r&quot;</span>, *px, *py);<br><br>        <span class="hljs-comment">/* 直到松开才返回 */</span><br>    <span class="hljs-comment">//我们操作完成后消除 +  </span><br>        fb<span class="hljs-constructor">_disp_cross(<span class="hljs-params">lcd_x</span>, <span class="hljs-params">lcd_y</span>, 0)</span>;<br>&#125;<br><br><span class="hljs-comment">//我们确定校准为什么不对，我们校准涉及 原始数据 校准公式</span><br><br><span class="hljs-comment">//我们把公式使用函数来表示int get_lcd_x_frm_ts_x(int ts_x)</span><br>&#123;<br>        return g_kx<span class="hljs-operator"> * </span>(ts_x - g_ts_xc) + g_lcd_xc;<br>&#125;<br><br><span class="hljs-built_in">int</span> get<span class="hljs-constructor">_lcd_y_frm_ts_y(<span class="hljs-params">int</span> <span class="hljs-params">ts_y</span>)</span><br>&#123;<br>        return g_ky<span class="hljs-operator"> * </span>(ts_y - g_ts_yc) + g_lcd_yc;<br>&#125;<br><br>void ts<span class="hljs-constructor">_calibrate(<span class="hljs-params">void</span>)</span><br>&#123;<br>        <span class="hljs-built_in">int</span> a_ts_x, a_ts_y;<br>        <span class="hljs-built_in">int</span> b_ts_x, b_ts_y;<br>        <span class="hljs-built_in">int</span> c_ts_x, c_ts_y;<br>        <span class="hljs-built_in">int</span> d_ts_x, d_ts_y;<br>        <span class="hljs-built_in">int</span> e_ts_x, e_ts_y;<br><br>        <span class="hljs-comment">/* X轴方向 */</span><br>        <span class="hljs-built_in">int</span> ts_s1, ts_s2;<br>        <span class="hljs-built_in">int</span> lcd_s;<br><br>        <span class="hljs-comment">/* Y轴方向 */</span><br>        <span class="hljs-built_in">int</span> ts_d1, ts_d2;<br>        <span class="hljs-built_in">int</span> lcd_d;<br><br>        <span class="hljs-comment">/* 获得LCD的参数: fb_base, xres, yres, bpp */</span><br>        get<span class="hljs-constructor">_lcd_params(&amp;<span class="hljs-params">fb_base</span>, &amp;<span class="hljs-params">xres</span>, &amp;<span class="hljs-params">yres</span>, &amp;<span class="hljs-params">bpp</span>)</span>;<br><br>        <span class="hljs-comment">/* 对于ABCDE, 循环: 显示&quot;+&quot;、点击、读ts原始值 */</span><br>        <span class="hljs-comment">/* A(50, 50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(50, 50, &amp;<span class="hljs-params">a_ts_x</span>, &amp;<span class="hljs-params">a_ts_y</span>)</span>; <br>  <br>        <span class="hljs-comment">/* B(xres-50, 50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">xres</span>-50, 50, &amp;<span class="hljs-params">b_ts_x</span>, &amp;<span class="hljs-params">b_ts_y</span>)</span>;<br><br>        <span class="hljs-comment">/* C(xres-50, yres-50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">xres</span>-50, <span class="hljs-params">yres</span>-50, &amp;<span class="hljs-params">c_ts_x</span>, &amp;<span class="hljs-params">c_ts_y</span>)</span>;<br><br>        <span class="hljs-comment">/* D(50, yres-50) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(50, <span class="hljs-params">yres</span>-50, &amp;<span class="hljs-params">d_ts_x</span>, &amp;<span class="hljs-params">d_ts_y</span>)</span>;<br>        <br>        <span class="hljs-comment">/* E(xres/2, yres/2) */</span><br>        get<span class="hljs-constructor">_calibrate_point_data(<span class="hljs-params">xres</span><span class="hljs-operator">/</span>2, <span class="hljs-params">yres</span><span class="hljs-operator">/</span>2, &amp;<span class="hljs-params">e_ts_x</span>, &amp;<span class="hljs-params">e_ts_y</span>)</span>;<br><br>        <span class="hljs-comment">/* 确定触摸屏数据XY是否反转 */</span><br>        g_ts_xy_swap = is<span class="hljs-constructor">_ts_xy_swap(<span class="hljs-params">a_ts_x</span>, <span class="hljs-params">a_ts_y</span>, <span class="hljs-params">b_ts_x</span>, <span class="hljs-params">b_ts_y</span>)</span>;<br><br>        <span class="hljs-keyword">if</span> (g_ts_xy_swap)<br>        &#123;<br>                <span class="hljs-comment">/* 对调所有点的XY坐标 */</span><br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">a_ts_x</span>, &amp;<span class="hljs-params">a_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">b_ts_x</span>, &amp;<span class="hljs-params">b_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">c_ts_x</span>, &amp;<span class="hljs-params">c_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">d_ts_x</span>, &amp;<span class="hljs-params">d_ts_y</span>)</span>;<br>                swap<span class="hljs-constructor">_xy(&amp;<span class="hljs-params">e_ts_x</span>, &amp;<span class="hljs-params">e_ts_y</span>)</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* 确定公式的参数并保存 */</span><br>        ts_s1 = b_ts_x - a_ts_x;<br>        ts_s2 = c_ts_x - d_ts_x;<br>        lcd_s = xres-<span class="hljs-number">50</span> - <span class="hljs-number">50</span>;<br><br>        ts_d1 = d_ts_y - a_ts_y;<br>        ts_d2 = c_ts_y - b_ts_y;<br>        lcd_d = yres-<span class="hljs-number">50</span>-<span class="hljs-number">50</span>;<br><br>        g_kx = ((double)(<span class="hljs-number">2</span>*lcd_s))<span class="hljs-operator"> / </span>(ts_s1 + ts_s2);<br>        g_ky = ((double)(<span class="hljs-number">2</span>*lcd_d))<span class="hljs-operator"> / </span>(ts_d1 + ts_d2);<br><br>        g_ts_xc = e_ts_x;<br>        g_ts_yc = e_ts_y;<br><br>        g_lcd_xc = xres/<span class="hljs-number">2</span>;<br>        g_lcd_yc = yres/<span class="hljs-number">2</span>;<br>    <span class="hljs-comment">//打印ABCDE的坐标值</span><br>        printf(<span class="hljs-string">&quot;A lcd_x = %08d, lcd_y = %08d\n\r&quot;</span>, get<span class="hljs-constructor">_lcd_x_frm_ts_x(<span class="hljs-params">a_ts_x</span>)</span>, get<span class="hljs-constructor">_lcd_y_frm_ts_y(<span class="hljs-params">a_ts_y</span>)</span>);<br>        printf(<span class="hljs-string">&quot;B lcd_x = %08d, lcd_y = %08d\n\r&quot;</span>, get<span class="hljs-constructor">_lcd_x_frm_ts_x(<span class="hljs-params">b_ts_x</span>)</span>, get<span class="hljs-constructor">_lcd_y_frm_ts_y(<span class="hljs-params">b_ts_y</span>)</span>);<br>        printf(<span class="hljs-string">&quot;C lcd_x = %08d, lcd_y = %08d\n\r&quot;</span>, get<span class="hljs-constructor">_lcd_x_frm_ts_x(<span class="hljs-params">c_ts_x</span>)</span>, get<span class="hljs-constructor">_lcd_y_frm_ts_y(<span class="hljs-params">c_ts_y</span>)</span>);<br>        printf(<span class="hljs-string">&quot;D lcd_x = %08d, lcd_y = %08d\n\r&quot;</span>, get<span class="hljs-constructor">_lcd_x_frm_ts_x(<span class="hljs-params">d_ts_x</span>)</span>, get<span class="hljs-constructor">_lcd_y_frm_ts_y(<span class="hljs-params">d_ts_y</span>)</span>);<br>        printf(<span class="hljs-string">&quot;E lcd_x = %08d, lcd_y = %08d\n\r&quot;</span>, get<span class="hljs-constructor">_lcd_x_frm_ts_x(<span class="hljs-params">e_ts_x</span>)</span>, get<span class="hljs-constructor">_lcd_y_frm_ts_y(<span class="hljs-params">e_ts_y</span>)</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>我们转换出的XY坐标值不是特别稳定</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/* 每10ms该函数被调用一次 </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">touchscreen_timer_irq</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>        <span class="hljs-comment">/* 如果触摸屏仍被按下, 进入&quot;自动测量模式&quot;, 启动ADC */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">get_status_of_ts_timer</span>() == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">ADCDAT0</span> &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>)) <span class="hljs-comment">/* 如果松开 */</span><br>        &#123;<br>                <span class="hljs-title function_">ts_timer_disable</span>();<br>                <span class="hljs-title function_">enter_wait_pen_down_mode</span>();<br>                <span class="hljs-comment">//report_ts_xy(0, 0, 0);</span><br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>  <span class="hljs-comment">/* 按下状态 */</span><br>        &#123;<br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                <span class="hljs-title function_">enter_auto_measure_mode</span>();<br><br>                <span class="hljs-comment">/* 启动ADC */</span><br>                <span class="hljs-variable constant_">ADCCON</span> |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>修改touchscreen-test.c文件</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void touchscreen<span class="hljs-constructor">_test(<span class="hljs-params">void</span>)</span><br>&#123;<br>        unsigned <span class="hljs-built_in">int</span> fb_base;<br>        <span class="hljs-built_in">int</span> xres, yres, bpp;<br><br>        <span class="hljs-built_in">int</span> x, y, pressure;<br><br>        <span class="hljs-comment">/* 获得LCD的参数: fb_base, xres, yres, bpp */</span><br>        get<span class="hljs-constructor">_lcd_params(&amp;<span class="hljs-params">fb_base</span>, &amp;<span class="hljs-params">xres</span>, &amp;<span class="hljs-params">yres</span>, &amp;<span class="hljs-params">bpp</span>)</span>;<br><br>        touchscreen<span class="hljs-constructor">_init()</span>;<br><br>        <span class="hljs-comment">/* 清屏 */</span><br>        clear<span class="hljs-constructor">_screen(0)</span>;<br><br>        <span class="hljs-comment">/* 显示文字提示较准 */</span><br>        fb<span class="hljs-constructor">_print_string(70, 70, <span class="hljs-string">&quot;Touc cross to calibrate touchscreen&quot;</span>, 0xffffff)</span>;<br>        ts<span class="hljs-constructor">_calibrate()</span>;<br><br>        <span class="hljs-comment">/* 显示文字提示绘画 */</span><br>        fb<span class="hljs-constructor">_print_string(70, <span class="hljs-params">yres</span> - 70, <span class="hljs-string">&quot;OK! To draw!&quot;</span>, 0xffffff)</span>;<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>        &#123;<br>    <span class="hljs-comment">//如果结果=0则继续执行下面操作</span><br>                <span class="hljs-keyword">if</span> (ts<span class="hljs-constructor">_read(&amp;<span class="hljs-params">x</span>, &amp;<span class="hljs-params">y</span>, &amp;<span class="hljs-params">pressure</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0</span>)<br>                &#123;<br>                        printf(<span class="hljs-string">&quot; x = %d, y = %d\n\r&quot;</span>, x, y);<br>    <span class="hljs-comment">//如果是按下状态，才会描点</span><br>                        <span class="hljs-keyword">if</span> (pressure)<br>                        &#123;<br>                                fb<span class="hljs-constructor">_put_pixel(<span class="hljs-params">x</span>, <span class="hljs-params">y</span>, 0xff00)</span>;<br>                        &#125;<br>                &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>把LCD的电压值，成功转化成屏幕的坐标 要点</p>
<p>1). 对于触摸屏要多次测量，求平均值</p>
<p>2). 要丢弃非法值（以LCD分辨率作为判断标准）</p>
<p>3). 校准时一定要点准</p>
<p>参考tslib库，</p>
<p><strong>第012节_触摸屏编程_完善</strong></p>
<hr>
<ul>
<li>我们触摸屏校准虽然可以正常运行，但是有些问题，比如在触摸屏上点一个点，同时屏幕上面会显示另一个点,我们按住屏幕不动的同时将其转换成LCD坐标并且描点，就表明数值不大稳定</li>
</ul>
<p>问题</p>
<ol>
<li>我们第一次点击触摸屏会出现两个点</li>
<li>长按，LCD上的点会越来越大</li>
</ol>
<ul>
<li>根源在于我们得到的LCD坐标值不稳定，根源ADC转换出来的xy坐标值不稳定</li>
</ul>
<p><img src="/image/700px-Chapter18_lesson12_001.jpg" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_001.jpg"></p>
<p>我们打开touchscreen.c问题出现在这里面</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">#include &quot;../s3c2440_soc.h&quot;</span><br><span class="hljs-comment">#define ADC_INT_BIT (10)</span><br><span class="hljs-comment">#define TC_INT_BIT  (9)</span><br><span class="hljs-comment">#define INT_ADC_TC   (31)</span><br><br><span class="hljs-comment">/* ADCTSC&#x27;s bits */</span><br><span class="hljs-comment">#define WAIT_PEN_DOWN    (0&lt;&lt;8)</span><br><span class="hljs-comment">#define WAIT_PEN_UP      (1&lt;&lt;8)</span><br><span class="hljs-comment">#define YM_ENABLE        (1&lt;&lt;7)</span><br><span class="hljs-comment">#define YM_DISABLE       (0&lt;&lt;7)</span><br><span class="hljs-comment">#define YP_ENABLE        (0&lt;&lt;6)</span><br><span class="hljs-comment">#define YP_DISABLE       (1&lt;&lt;6)</span><br><span class="hljs-comment">#define XM_ENABLE        (1&lt;&lt;5)</span><br><span class="hljs-comment">#define XM_DISABLE       (0&lt;&lt;5)</span><br><span class="hljs-comment">#define XP_ENABLE        (0&lt;&lt;4)</span><br><span class="hljs-comment">#define XP_DISABLE       (1&lt;&lt;4)</span><br><span class="hljs-comment">#define PULLUP_ENABLE    (0&lt;&lt;3)</span><br><span class="hljs-comment">#define PULLUP_DISABLE   (1&lt;&lt;3)</span><br><span class="hljs-comment">#define AUTO_PST         (1&lt;&lt;2)</span><br><span class="hljs-comment">#define WAIT_INT_MODE    (3)</span><br><span class="hljs-comment">#define NO_OPR_MODE      (0)</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-variable">volatile</span> int <span class="hljs-variable">g_ts_timer_enable</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">static</span> int <span class="hljs-variable">g_ts_x</span>;<span class="hljs-keyword">static</span> int <span class="hljs-variable">g_ts_y</span>;<br><span class="hljs-keyword">static</span> int <span class="hljs-variable">g_ts_pressure</span>;<br><span class="hljs-keyword">static</span> int <span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">//定义测试数据16</span><br><span class="hljs-keyword">static</span> int <span class="hljs-variable">test_x_array</span>[<span class="hljs-number">16</span>];<br><span class="hljs-keyword">static</span> int <span class="hljs-variable">test_y_array</span>[<span class="hljs-number">16</span>];<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">report_ts_xy</span>(int <span class="hljs-variable">x</span>, int <span class="hljs-variable">y</span>, int <span class="hljs-variable">pressure</span>);<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">enter_wait_pen_down_mode</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-variable">ADCTSC</span> <span class="hljs-operator">=</span> <span class="hljs-variable">WAIT_PEN_DOWN</span> <span class="hljs-operator">|</span> <span class="hljs-variable">PULLUP_ENABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">YM_ENABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">YP_DISABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">XP_DISABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">XM_DISABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">WAIT_INT_MODE</span>;<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">enter_wait_pen_up_mode</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-variable">ADCTSC</span> <span class="hljs-operator">=</span> <span class="hljs-variable">WAIT_PEN_UP</span> <span class="hljs-operator">|</span> <span class="hljs-variable">PULLUP_ENABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">YM_ENABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">YP_DISABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">XP_DISABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">XM_DISABLE</span> <span class="hljs-operator">|</span> <span class="hljs-variable">WAIT_INT_MODE</span>;<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">enter_auto_measure_mode</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-variable">ADCTSC</span> <span class="hljs-operator">=</span> <span class="hljs-variable">AUTO_PST</span> <span class="hljs-operator">|</span> <span class="hljs-variable">NO_OPR_MODE</span>;<br>&#125;<br><br>int <span class="hljs-title function_">is_in_auto_mode</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ADCTSC</span> <span class="hljs-operator">&amp;</span> <span class="hljs-variable">AUTO_PST</span>;<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title class_">Isr</span>_Tc(<span class="hljs-variable">void</span>)<br>&#123;<br>        <span class="hljs-comment">//printf(&quot;ADCUPDN = 0x%x, ADCDAT0 = 0x%x, ADCDAT1 = 0x%x, ADCTSC = 0x%x\n\r&quot;, ADCUPDN, ADCDAT0, ADCDAT1, ADCTSC);</span><br>        <br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ADCDAT0</span> <span class="hljs-operator">&amp;</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">15</span>))<br>        &#123;<br>    <span class="hljs-comment">//按下状态启用触摸屏</span><br>    <span class="hljs-comment">//启动测量模式，转换结束产生adc中断</span><br>                <span class="hljs-comment">//printf(&quot;pen up\n\r&quot;);</span><br>                <span class="hljs-title function_">enter_wait_pen_down_mode</span>();<br>                <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>   <br>        &#123;<br>                <span class="hljs-comment">//printf(&quot;pen down\n\r&quot;);</span><br><br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                <span class="hljs-title function_">enter_auto_measure_mode</span>();<br><br>                <span class="hljs-comment">/* 启动ADC */</span><br>                <span class="hljs-variable">ADCCON</span> <span class="hljs-operator">|</span><span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">ts_timer_enable</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-variable">g_ts_timer_enable</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">ts_timer_disable</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-variable">g_ts_timer_enable</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">static</span> int <span class="hljs-title function_">get_status_of_ts_timer</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">g_ts_timer_enable</span>;<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-params">int</span> <span class="hljs-params">x</span>, <span class="hljs-params">int</span> <span class="hljs-params">y</span>, <span class="hljs-params">int</span> <span class="hljs-params">pressure</span>)<br>&#123;<br>        <span class="hljs-comment">//printf(&quot;x = %08d, y = %08d\n\r&quot;, x, y);</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">==</span> <span class="hljs-number">0</span>)<br>        &#123;<br>                <span class="hljs-variable">g_ts_x</span> <span class="hljs-operator">=</span> <span class="hljs-variable">x</span>;<br>                <span class="hljs-variable">g_ts_y</span> <span class="hljs-operator">=</span> <span class="hljs-variable">y</span>;<br>                <span class="hljs-variable">g_ts_pressure</span> <span class="hljs-operator">=</span> <span class="hljs-variable">pressure</span>;<br>                <span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        &#125;<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">ts_read_raw</span>(<span class="hljs-params">int</span> *<span class="hljs-params">px</span>, <span class="hljs-params">int</span> *<span class="hljs-params">py</span>, <span class="hljs-params">int</span> *<span class="hljs-params">ppressure</span>)<br>&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">==</span> <span class="hljs-number">0</span>);<br>        <span class="hljs-operator">*</span><span class="hljs-variable">px</span> <span class="hljs-operator">=</span> <span class="hljs-variable">g_ts_x</span>;<br>        <span class="hljs-operator">*</span><span class="hljs-variable">py</span> <span class="hljs-operator">=</span> <span class="hljs-variable">g_ts_y</span>;<br>        <span class="hljs-operator">*</span><span class="hljs-variable">ppressure</span> <span class="hljs-operator">=</span> <span class="hljs-variable">g_ts_pressure</span>;<br>        <span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* 每10ms该函数被调用一次 </span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">void</span> <span class="hljs-title function_">touchscreen_timer_irq</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-comment">/* 如果触摸屏仍被按下, 进入&quot;自动测量模式&quot;, 启动ADC */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">get_status_of_ts_timer</span>() <span class="hljs-operator">==</span> <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">is_in_auto_mode</span>())<br>                <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-comment">/* 只有在&quot;等待中断模式&quot;下才可以使用ADCDAT0&#x27;BIT 15来判断触摸笔状态 */</span><br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ADCDAT0</span> <span class="hljs-operator">&amp;</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">15</span>)) <span class="hljs-comment">/* 如果松开 */</span><br>        &#123;<br>                <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;timer set pen down<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>                <span class="hljs-title function_">ts_timer_disable</span>();<br>                <span class="hljs-title function_">enter_wait_pen_down_mode</span>();<br>                <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>  <span class="hljs-comment">/* 按下状态 */</span><br>        &#123;<br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                <span class="hljs-title function_">enter_auto_measure_mode</span>();<br><br>                <span class="hljs-comment">/* 启动ADC */</span><br>                <span class="hljs-variable">ADCCON</span> <span class="hljs-operator">|</span><span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title class_">Isr</span>_Adc(<span class="hljs-variable">void</span>)<br>&#123;<br>        int <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-variable">ADCDAT0</span>;<br>        int <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-variable">ADCDAT1</span>;<br><br>        <span class="hljs-keyword">static</span> int <span class="hljs-variable">adc_cnt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">static</span> int <span class="hljs-variable">adc_x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">static</span> int <span class="hljs-variable">adc_y</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">/* 进入ADC中断时, TS处于&quot;自动测量模式&quot; */</span><br><br>        <span class="hljs-comment">/* 只有在&quot;等待中断模式&quot;下才可以使用ADCDAT0&#x27;BIT 15来判断触摸笔状态 */</span><br><br>        <span class="hljs-title function_">enter_wait_pen_up_mode</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>(<span class="hljs-variable">ADCDAT0</span> <span class="hljs-operator">&amp;</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">15</span>))) <span class="hljs-comment">/* 如果仍然按下才打印 */</span><br>        &#123;<br><span class="hljs-comment">#<span class="hljs-keyword">if</span> 0                      </span><br>            <span class="hljs-variable">x</span> <span class="hljs-operator">&amp;</span><span class="hljs-operator">=</span> <span class="hljs-number">0x3ff</span>;          <br>            <span class="hljs-variable">y</span> <span class="hljs-operator">&amp;</span><span class="hljs-operator">=</span> <span class="hljs-number">0x3ff</span>;                    <br><br>            <span class="hljs-comment">//printf(&quot;x =   %08d, y = %08d\n\r&quot;, x, y);          </span><br>            <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-variable">x</span>, <span class="hljs-variable">y</span>, <span class="hljs-number">1</span>);<br><br>            <span class="hljs-comment">/* 启动定时器以再次读取数据 */</span>          <br>            <span class="hljs-title function_">ts_timer_enable</span>();<br><span class="hljs-comment">#endif</span><br>            <span class="hljs-comment">/* 第1次启动ADC后:          </span><br><span class="hljs-comment">             *   a. 要连续启动N次, 获得N个数据, 求平均值并上报          </span><br><span class="hljs-comment">             *   b. 得到N次数据后, 再启动TIMER           </span><br><span class="hljs-comment">             */</span><br>                <span class="hljs-variable">adc_x</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> (<span class="hljs-variable">x</span> <span class="hljs-operator">&amp;</span> <span class="hljs-number">0x3ff</span>);<br>                <span class="hljs-variable">adc_y</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> (<span class="hljs-variable">y</span> <span class="hljs-operator">&amp;</span> <span class="hljs-number">0x3ff</span>);<br>        <span class="hljs-comment">//定义一个函数把这些值打印出来</span><br>                <span class="hljs-variable">test_x_array</span>[<span class="hljs-variable">adc_cnt</span>] <span class="hljs-operator">=</span> (<span class="hljs-variable">x</span> <span class="hljs-operator">&amp;</span> <span class="hljs-number">0x3ff</span>);<br>                <span class="hljs-variable">test_y_array</span>[<span class="hljs-variable">adc_cnt</span>] <span class="hljs-operator">=</span> (<span class="hljs-variable">y</span> <span class="hljs-operator">&amp;</span> <span class="hljs-number">0x3ff</span>);<br>                <br>                <span class="hljs-variable">adc_cnt</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">adc_cnt</span> <span class="hljs-operator">==</span> <span class="hljs-number">16</span>)<br>                &#123;<br>                        <span class="hljs-variable">adc_x</span> <span class="hljs-operator">&gt;&gt;</span><span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>                        <span class="hljs-variable">adc_y</span> <span class="hljs-operator">&gt;&gt;</span><span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>                        <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-variable">adc_x</span>, <span class="hljs-variable">adc_y</span>, <span class="hljs-number">1</span>);<br>                        <span class="hljs-variable">adc_cnt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                        <span class="hljs-variable">adc_x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                        <span class="hljs-variable">adc_y</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                        <br>                        <span class="hljs-comment">/* 启动定时器以再次读取数据 */</span><br>                        <span class="hljs-comment">/* 先设置TS进入&quot;等待中断模式&quot; */</span><br>        <span class="hljs-comment">//有按下就会有松开</span><br>                        <span class="hljs-title function_">enter_wait_pen_up_mode</span>();<br>                        <span class="hljs-title function_">ts_timer_enable</span>();<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                        <span class="hljs-comment">/* 再次启动ADC */</span><br>                        <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                        <span class="hljs-title function_">enter_auto_measure_mode</span>();<br>                        <br>                        <span class="hljs-comment">/* 启动ADC */</span><br>                        <span class="hljs-variable">ADCCON</span> <span class="hljs-operator">|</span><span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">0</span>);<br>                &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>                <span class="hljs-variable">adc_cnt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-variable">adc_x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-variable">adc_y</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;adc report pen down<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>                <span class="hljs-title function_">ts_timer_disable</span>();<br>                <span class="hljs-title function_">enter_wait_pen_down_mode</span>();<br>                <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-comment">//enter_wait_pen_up_mode();  /* 启动ADC时不应该进入这个模式, 它会影响数据 */&#125;</span><br><br><span class="hljs-variable">void</span> <span class="hljs-title class_">AdcTsIntHandle</span>(int <span class="hljs-variable">irq</span>)<br>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">SUBSRCPND</span> <span class="hljs-operator">&amp;</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">TC_INT_BIT</span>))  <span class="hljs-comment">/* 如果是触摸屏中断 */</span><br>                <span class="hljs-title class_">Isr</span>_Tc();<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">SUBSRCPND</span> <span class="hljs-operator">&amp;</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">ADC_INT_BIT</span>))  <span class="hljs-comment">/* ADC中断 */</span><br>                <span class="hljs-title class_">Isr</span>_Adc();<br>        <span class="hljs-variable">SUBSRCPND</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">TC_INT_BIT</span>) <span class="hljs-operator">|</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">ADC_INT_BIT</span>);<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">adc_ts_int_init</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-variable">SUBSRCPND</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">TC_INT_BIT</span>) <span class="hljs-operator">|</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">ADC_INT_BIT</span>);<br><br>        <span class="hljs-comment">/* 注册中断处理函数 */</span><br>        <span class="hljs-title function_">register_irq</span>(<span class="hljs-number">31</span>, <span class="hljs-title class_">AdcTsIntHandle</span>);<br><br>        <span class="hljs-comment">/* 使能中断 */</span><br>        <span class="hljs-variable">INTSUBMSK</span> <span class="hljs-operator">&amp;</span><span class="hljs-operator">=</span> <span class="hljs-operator">~</span>((<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">ADC_INT_BIT</span>) <span class="hljs-operator">|</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-variable">TC_INT_BIT</span>));<br>        <span class="hljs-comment">//INTMSK    &amp;= ~(1&lt;&lt;INT_ADC_TC);</span><br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">adc_ts_reg_init</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-comment">/* [15] : ECFLG,  1 = End of A/D conversion  </span><br><span class="hljs-comment">         * [14] : PRSCEN, 1 = A/D converter prescaler enable  </span><br><span class="hljs-comment">         * [13:6]: PRSCVL, adc clk = PCLK / (PRSCVL + 1)  </span><br><span class="hljs-comment">         * [5:3] : SEL_MUX, 000 = AIN 0  * [2]   : STDBM  </span><br><span class="hljs-comment">         * [0]   : 1 = A/D conversion starts and this bit is cleared after the startup.  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-variable">ADCCON</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">14</span>) <span class="hljs-operator">|</span> (<span class="hljs-number">49</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">6</span>) <span class="hljs-operator">|</span> (<span class="hljs-number">0</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">3</span>);<br><br>        <span class="hljs-comment">/*  按下触摸屏, 延时一会再发出TC中断  </span><br><span class="hljs-comment">         *  延时时间 = ADCDLY * 晶振周期 = ADCDLY * 1 / 12000000 = 5ms  </span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-variable">ADCDLY</span> <span class="hljs-operator">=</span> <span class="hljs-number">60000</span>;      <br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">touchscreen_init</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-comment">/* 设置触摸屏接口:寄存器 */</span><br>        <span class="hljs-title function_">adc_ts_reg_init</span>();<br><br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;ADCUPDN = 0x%x, SUBSRCPND = 0x%x, SRCPND = 0x%x<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>, <span class="hljs-variable">ADCUPDN</span>, <span class="hljs-variable">SUBSRCPND</span>, <span class="hljs-variable">SRCPND</span>);<br><br>        <span class="hljs-comment">/* 设置中断 */</span><br>        <span class="hljs-title function_">adc_ts_int_init</span>();<br><br>        <span class="hljs-comment">/* 注册定时器处理函数 */</span><br>        <span class="hljs-title function_">register_timer</span>(<span class="hljs-string">&quot;touchscreen&quot;</span>, <span class="hljs-variable">touchscreen_timer_irq</span>);<br><br>        <span class="hljs-comment">/* 让触摸屏控制器进入&quot;等待中断模式&quot; */</span><br>        <span class="hljs-title function_">enter_wait_pen_down_mode</span>();<br>&#125;<br><br><span class="hljs-comment">//打印数组定义的那些值</span><br><span class="hljs-variable">void</span> <span class="hljs-title function_">print_test_array</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        int <span class="hljs-variable">i</span>;<br><br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;test array x : &quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">16</span>; <span class="hljs-variable">i</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>)<br>                <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;%08d &quot;</span>, <span class="hljs-variable">test_x_array</span>[<span class="hljs-variable">i</span>]);<br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br><br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;test array y : &quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">16</span>; <span class="hljs-variable">i</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>)<br>                <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;%08d &quot;</span>, <span class="hljs-variable">test_y_array</span>[<span class="hljs-variable">i</span>]);<br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>&#125;<br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">ts_read_raw_test</span>(<span class="hljs-params">int</span> *<span class="hljs-params">px</span>, <span class="hljs-params">int</span> *<span class="hljs-params">py</span>, <span class="hljs-params">int</span> *<span class="hljs-params">ppressure</span>)<br>&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">==</span> <span class="hljs-number">0</span>);<br>        <span class="hljs-operator">*</span><span class="hljs-variable">px</span> <span class="hljs-operator">=</span> <span class="hljs-variable">g_ts_x</span>;<br>        <span class="hljs-operator">*</span><span class="hljs-variable">py</span> <span class="hljs-operator">=</span> <span class="hljs-variable">g_ts_y</span>;<br>        <span class="hljs-operator">*</span><span class="hljs-variable">ppressure</span> <span class="hljs-operator">=</span> <span class="hljs-variable">g_ts_pressure</span>;<br>        <span class="hljs-title function_">print_test_array</span>();<br>        <span class="hljs-variable">g_ts_data_valid</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>tslib.c使用了ts_read_raw函数</li>
</ul>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs hsp">void get_calibrate_point_data(<span class="hljs-keyword">int</span> lcd_x, <span class="hljs-keyword">int</span> lcd_y, <span class="hljs-keyword">int</span> *px, <span class="hljs-keyword">int</span> *py)<br>&#123;<br>        <span class="hljs-keyword">int</span> pressure<span class="hljs-comment">;</span><br>        <span class="hljs-keyword">int</span> x, y<span class="hljs-comment">;</span><br>        <span class="hljs-keyword">int</span> sum_x = <span class="hljs-number">0</span>, sum_y = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>        <span class="hljs-keyword">int</span> <span class="hljs-keyword">cnt</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>        <br>        fb_disp_cross(lcd_x, lcd_y, <span class="hljs-number">0</span>xffffff)<span class="hljs-comment">;</span><br><br>        <span class="hljs-comment">/* 等待点击 */</span><br><br>        <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-comment">//ts_read_raw(&amp;x, &amp;y, &amp;pressure); </span><br>            <span class="hljs-comment">//我们使用测试程序去读这些值</span><br>                ts_read_raw_test(&amp;x, &amp;y, &amp;pressure)<span class="hljs-comment">;</span><br>        &#125; <span class="hljs-keyword">while</span> (pressure == <span class="hljs-number">0</span>)<span class="hljs-comment">;</span><br><br>        <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">cnt</span> &lt; <span class="hljs-number">128</span>)<br>                &#123;<br>                        sum_x += x<span class="hljs-comment">;</span><br>                        sum_y += y<span class="hljs-comment">;</span><br>                        <span class="hljs-keyword">cnt</span>++<span class="hljs-comment">;</span><br>                &#125;<br>                <span class="hljs-comment">//ts_read_raw(&amp;x, &amp;y, &amp;pressure);</span><br><br>                <span class="hljs-comment">//ts_read_raw_test(&amp;x, &amp;y, &amp;pressure);</span><br>                printf(<span class="hljs-string">&quot;get raw data: x = %08d, y = %08d, cnt = %d\n\r&quot;</span>, x, y, <span class="hljs-keyword">cnt</span>)<span class="hljs-comment">;</span><br>        &#125; <span class="hljs-keyword">while</span> (pressure)<span class="hljs-comment">;</span><br><br>        *px = sum_x / <span class="hljs-keyword">cnt</span><span class="hljs-comment">;</span><br>        *py = sum_y / <span class="hljs-keyword">cnt</span><span class="hljs-comment">;</span><br><br>        printf(<span class="hljs-string">&quot;return raw data: x = %08d, y = %08d\n\r&quot;</span>, *px, *py)<span class="hljs-comment">;</span><br><br>        <span class="hljs-comment">/* 直到松开才返回 */</span><br>        fb_disp_cross(lcd_x, lcd_y, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们来看点击一下是不是得到了距离非常远的两个值</p>
<p><img src="/image/700px-Chapter18_lesson12_002.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_002.png"></p>
<p>对于同一个点得到的是255 945 945 944</p>
<p>发现 945 944经常出现</p>
<p>我们查一下原因,进入touchscreen.c中</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs awk">void Isr_Adc(void)<br>&#123;<br>        int x = ADCDAT0;<br>        int y = ADCDAT1;<br><br>        static int adc_cnt = <span class="hljs-number">0</span>;<br>        static int adc_x = <span class="hljs-number">0</span>;<br>        static int adc_y = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-regexp">/* 进入ADC中断时, TS处于&quot;自动测量模式&quot; */</span><br><br>        <span class="hljs-regexp">/* 只有在&quot;等待中断模式&quot;下才可以使用ADCDAT0&#x27;BIT 15来判断触摸笔状态 */</span><br><br>        enter_wait_pen_up_mode();<br>        <span class="hljs-keyword">if</span> (!(ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>))) <span class="hljs-regexp">/* 如果仍然按下才打印 */</span><br>        &#123;<br><span class="hljs-comment">#if 0                      </span><br>            x &amp;= <span class="hljs-number">0</span>x3ff;          <br>            y &amp;= <span class="hljs-number">0</span>x3ff;     <br>               <br>            <span class="hljs-regexp">//</span>printf(<span class="hljs-string">&quot;x = %08d, y = %08d\n\r&quot;</span>, x, y);          <br>            report_ts_xy(x, y, <span class="hljs-number">1</span>);<br><br>            <span class="hljs-regexp">/* 启动定时器以再次读取数据 */</span>          <br>            ts_timer_enable();<span class="hljs-comment">#endif</span><br>                /* 第<span class="hljs-number">1</span>次启动ADC后:          <br>                 *   a. 要连续启动N次, 获得N个数据, 求平均值并上报          <br>                 *   b. 得到N次数据后, 再启动TIMER           <br>                 */<br>                adc_x += (x &amp; <span class="hljs-number">0</span>x3ff);<br>                adc_y += (y &amp; <span class="hljs-number">0</span>x3ff);<br><br>                test_x_array[adc_cnt] = (x &amp; <span class="hljs-number">0</span>x3ff);<br>                test_y_array[adc_cnt] = (y &amp; <span class="hljs-number">0</span>x3ff);<br>                <br>                adc_cnt++;<br><br>                <span class="hljs-keyword">if</span> (adc_cnt == <span class="hljs-number">16</span>)<br>                &#123;<br>                        adc_x &gt;&gt;= <span class="hljs-number">4</span>;<br>                        adc_y &gt;&gt;= <span class="hljs-number">4</span>;<br>                        report_ts_xy(adc_x, adc_y, <span class="hljs-number">1</span>);<br>                        adc_cnt = <span class="hljs-number">0</span>;<br>                        adc_x = <span class="hljs-number">0</span>;<br>                        adc_y = <span class="hljs-number">0</span>;<br>                        <br>                        <span class="hljs-regexp">/* 启动定时器以再次读取数据 */</span><br>                        <span class="hljs-regexp">/* 先设置TS进入&quot;等待中断模式&quot; */</span><br>                        enter_wait_pen_up_mode();<br>                        ts_timer_enable();<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                        <span class="hljs-regexp">/* 再次启动ADC */</span><br>                        <span class="hljs-regexp">/* 进入&quot;自动测量&quot;模式 */</span><br>                        enter_auto_measure_mode();<br>                        <br>                        <span class="hljs-regexp">/* 启动ADC */</span><br>                        ADCCON |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>);<br>                &#125;<br>                <br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>                adc_cnt = <span class="hljs-number">0</span>;<br>                adc_x = <span class="hljs-number">0</span>;<br>                adc_y = <span class="hljs-number">0</span>;<br>                printf(<span class="hljs-string">&quot;adc report pen down\n\r&quot;</span>);<br>                ts_timer_disable();<br>                enter_wait_pen_down_mode();<br>                report_ts_xy(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>    <span class="hljs-regexp">//</span>启动ADC后又再次进入enter_wait_pen_up_mode电阻上拉，多次一举<br>        <span class="hljs-regexp">//</span>enter_wait_pen_up_mode();  <span class="hljs-regexp">/* 启动ADC时不应该进入这个模式, 它会影响数据 */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/700px-Chapter18_lesson12_003.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_003.png"></p>
<p>发现这些值中还有944，我需要继续查找原因, 在touchscreen.c时钟处理函数中添加打印信息</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/* 每10ms该函数被调用一次  </span><br><span class="hljs-comment">*/</span>void touchscreen<span class="hljs-constructor">_timer_irq(<span class="hljs-params">void</span>)</span><br>&#123;<br>        <span class="hljs-comment">/* 如果触摸屏仍被按下, 进入&quot;自动测量模式&quot;, 启动ADC */</span><br>        <span class="hljs-keyword">if</span> (get<span class="hljs-constructor">_status_of_ts_timer()</span><span class="hljs-operator"> == </span><span class="hljs-number">0</span>)<br>                return;<br><br>        <span class="hljs-keyword">if</span> (is<span class="hljs-constructor">_in_auto_mode()</span>)<br>                return;<br><br>        <span class="hljs-comment">/* 只有在&quot;等待中断模式&quot;下才可以使用ADCDAT0&#x27;BIT 15来判断触摸笔状态 */</span><br><br>        <span class="hljs-keyword">if</span> (ADCDAT0 &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">15</span>)) <span class="hljs-comment">/* 如果松开 */</span><br>        &#123;<br>    <span class="hljs-comment">//添加打印信息</span><br>                printf(<span class="hljs-string">&quot;timer set pen down\n\r&quot;</span>);<br>                ts<span class="hljs-constructor">_timer_disable()</span>;<br>    <span class="hljs-comment">//进入enter_wait_pen_down_mode，来判断触摸笔是按下还是松开</span><br>                enter<span class="hljs-constructor">_wait_pen_down_mode()</span>;<br>                report<span class="hljs-constructor">_ts_xy(0, 0, 0)</span>;<br>                return;<br>        &#125;<br>        <span class="hljs-keyword">else</span>  <span class="hljs-comment">/* 按下状态 */</span><br>        &#123;<br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                enter<span class="hljs-constructor">_auto_measure_mode()</span>;<br><br>                <span class="hljs-comment">/* 启动ADC */</span><br>                ADCCON <span class="hljs-pattern-match">|= (1&lt;&lt;0);</span><br><span class="hljs-pattern-match">        &#125;</span><br><span class="hljs-pattern-match">&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="/image/700px-Chapter18_lesson12_004.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_004.png"></p>
<p>非常频繁打印timer set pen down</p>
<ul>
<li>我们的判断有问题</li>
</ul>
<p>打开芯片手册，搜索这个寄存器,Bit15确实是判断按下或者松开</p>
<p><img src="/image/700px-Chapter18_lesson12_005.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_005.png"></p>
<p>只有在中断模式下，这一位才可以正确反应是按下还是松开的状态,修改touchscreen_timer_irq函数</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">/* 每10ms该函数被调用一次  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">void</span> <span class="hljs-title function_">touchscreen_timer_irq</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-comment">/* 如果触摸屏仍被按下, 进入&quot;自动测量模式&quot;, 启动ADC */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">get_status_of_ts_timer</span>() <span class="hljs-operator">==</span> <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//如果定时器中断在ADC中间产生，应该立刻返回啥都不做，不需要timer去做任何操作</span><br><span class="hljs-comment">//我们需要写出这个函数</span><br><span class="hljs-comment">//如果不是自动模式，那么就是等待中断模式</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">is_in_auto_mode</span>())<br>                <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//中断处理函数，</span><br>        <span class="hljs-comment">/* 只有在&quot;等待中断模式&quot;下才可以使用ADCDAT0&#x27;BIT 15来判断触摸笔状态 */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ADCDAT0</span> <span class="hljs-operator">&amp;</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">15</span>)) <span class="hljs-comment">/* 如果松开 */</span><br>        &#123;<br>                <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;timer set pen down<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\r</span>&quot;</span>);<br>                <span class="hljs-title function_">ts_timer_disable</span>();<br>                <span class="hljs-title function_">enter_wait_pen_down_mode</span>();<br>                <span class="hljs-title function_">report_ts_xy</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>  <span class="hljs-comment">/* 按下状态 */</span><br>        &#123;<br>                <span class="hljs-comment">/* 进入&quot;自动测量&quot;模式 */</span><br>                <span class="hljs-title function_">enter_auto_measure_mode</span>();<br>                <span class="hljs-comment">/* 启动ADC */</span><br>                <span class="hljs-variable">ADCCON</span> <span class="hljs-operator">|</span><span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-number">0</span>);<br>        &#125;<br>&#125;<br><br><span class="hljs-comment">//判断是否是模式模式的函数</span><br><br>int <span class="hljs-title function_">is_in_auto_mode</span>(<span class="hljs-params">void</span>)<br>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ADCTSC</span> <span class="hljs-operator">&amp;</span> <span class="hljs-variable">AUTO_PST</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们接着实验</p>
<p><img src="/image/700px-Chapter18_lesson12_006.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_006.png"></p>
<p>发现并没有捕捉到笔的松开模式 , 修改tslib，取消ts_read_raw_test 重新进行测试.</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs perl">void get_calibrate_point_data(<span class="hljs-keyword">int</span> lcd_x, <span class="hljs-keyword">int</span> lcd_y, <span class="hljs-keyword">int</span> *px, <span class="hljs-keyword">int</span> *py)<br>&#123;<br>        <span class="hljs-keyword">int</span> pressure;<br>        <span class="hljs-keyword">int</span> <span class="hljs-keyword">x</span>, <span class="hljs-keyword">y</span>;<br>        <span class="hljs-keyword">int</span> sum_x = <span class="hljs-number">0</span>, sum_y = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> cnt = <span class="hljs-number">0</span>;<br>        <br>        fb_disp_cross(lcd_x, lcd_y, <span class="hljs-number">0xffffff</span>);<br><br>        <span class="hljs-regexp">/* 等待点击 */</span><br><br>        <span class="hljs-keyword">do</span> &#123;<br>                ts_read_raw(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>                <span class="hljs-regexp">//</span>ts_read_raw_test(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>        &#125; <span class="hljs-keyword">while</span> (pressure == <span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">128</span>)<br>                &#123;<br>                        sum_x += <span class="hljs-keyword">x</span>;<br>                        sum_y += <span class="hljs-keyword">y</span>;<br>                        cnt++;<br>                &#125;<br>                ts_read_raw(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>                <span class="hljs-regexp">//</span>ts_read_raw_test(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>                <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;get raw data: x = %08d, y = %08d, cnt = %d\n\r&quot;</span>, <span class="hljs-keyword">x</span>, <span class="hljs-keyword">y</span>, cnt);<br>        &#125; <span class="hljs-keyword">while</span> (pressure);<br><br>        *px = sum_x / cnt;<br>        *py = sum_y / cnt;<br><br>        <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;return raw data: x = %08d, y = %08d\n\r&quot;</span>, *px, *py);<br><br>        <span class="hljs-regexp">/* 直到松开才返回 */</span><br>        fb_disp_cross(lcd_x, lcd_y, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>现在发现点点不准确</p>
<p><img src="/image/700px-Chapter18_lesson12_007.png" srcset="/img/loading.gif" lazyload alt="700px-Chapter18_lesson12_007.png"></p>
<p>发现校准的值和我们之前的不一样,修改我们的tslib校准程序</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs perl">void get_calibrate_point_data(<span class="hljs-keyword">int</span> lcd_x, <span class="hljs-keyword">int</span> lcd_y, <span class="hljs-keyword">int</span> *px, <span class="hljs-keyword">int</span> *py)<br>&#123;<br>        <span class="hljs-keyword">int</span> pressure;<br>        <span class="hljs-keyword">int</span> <span class="hljs-keyword">x</span>, <span class="hljs-keyword">y</span>;<br>        <span class="hljs-keyword">int</span> sum_x = <span class="hljs-number">0</span>, sum_y = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> cnt = <span class="hljs-number">0</span>;<br>        <br>        fb_disp_cross(lcd_x, lcd_y, <span class="hljs-number">0xffffff</span>);<br><br>        <span class="hljs-regexp">/* 等待点击 */</span><br>        <span class="hljs-keyword">do</span> &#123;<br>                ts_read_raw(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>                <span class="hljs-regexp">//</span>ts_read_raw_test(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>        &#125; <span class="hljs-keyword">while</span> (pressure == <span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-regexp">//</span>我们把求和的次数限制为<span class="hljs-number">128</span>次<br>                <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">128</span>)<br>                &#123;<br>                        sum_x += <span class="hljs-keyword">x</span>;<br>                        sum_y += <span class="hljs-keyword">y</span>;<br>                        cnt++;<br>                &#125;<br>                ts_read_raw(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>                <span class="hljs-regexp">//</span>ts_read_raw_test(&amp;<span class="hljs-keyword">x</span>, &amp;<span class="hljs-keyword">y</span>, &amp;pressure);<br>                <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;get raw data: x = %08d, y = %08d, cnt = %d\n\r&quot;</span>, <span class="hljs-keyword">x</span>, <span class="hljs-keyword">y</span>, cnt);<br>        &#125; <span class="hljs-keyword">while</span> (pressure);<br><br>        *px = sum_x / cnt;<br>        *py = sum_y / cnt;<br><br>        <span class="hljs-keyword">printf</span>(<span class="hljs-string">&quot;return raw data: x = %08d, y = %08d\n\r&quot;</span>, *px, *py);<br><br>        <span class="hljs-regexp">/* 直到松开才返回 */</span><br>        fb_disp_cross(lcd_x, lcd_y, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们可以参考tslib</p>
<p>1). 使用矩阵进行校准，适用性更强</p>
<p>2). 使用多种方法消除误差，多次测量求平均值</p>
<p>判断相领点的距离，如果突然变化很大，就有可能是错误值</p>
<p>1). …</p>
<p>第一期的视频在于裸机基本操作</p>
<p><strong>视频的要点在于</strong></p>
<p><strong>修改要点</strong></p>
<p>1). 启动ADC时不应该进入等待中断模式，它会影响数据</p>
<p>2). 只有在”等待中断模式”下才可以使用ADCDAT0’BIT 15来判断触摸笔状态</p>
<p>3). 校准非常重要，所以在程序种多次测量求平均值(不仅仅是在adc中断种求平均值)</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" class="category-chain-item">嵌入式</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%9C%AA%E9%87%8D%E6%9E%84/">#未重构</a>
      
        <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">#嵌入式</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>第018课 ADC和触摸屏</div>
      <div>https://godxqi.github.io/2023/01/15/韦东山一期/第018课_ADC和触摸屏/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>GODXQI</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>January 15, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/15/%E9%9F%A6%E4%B8%9C%E5%B1%B1%E4%B8%80%E6%9C%9F/%E7%AC%AC018%E8%AF%BE_ADC%E5%92%8C%E8%A7%A6%E6%91%B8%E5%B1%8F-1/" title="第018课 ADC和触摸屏">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第018课 ADC和触摸屏</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/15/%E9%9F%A6%E4%B8%9C%E5%B1%B1%E4%B8%80%E6%9C%9F/%E7%AC%AC017%E8%AF%BE_LCD%E7%BC%96%E7%A8%8B/" title="第017课 LCD编程">
                        <span class="hidden-mobile">第017课 LCD编程</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
